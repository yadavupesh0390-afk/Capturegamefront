<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Category Products</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:20px}
.header{margin-top:15px;background:#fff;padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.08)}
.products-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px}
.product-card{background:#fff;padding:8px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.product-card img{width:100%;height:110px;object-fit:contain;background:#f8fafc;padding:6px;border-radius:10px}
.price{color:#16a34a;font-weight:600;font-size:13px}
.actions{display:flex;gap:5px;margin-top:6px}
.actions button{flex:1;border:none;border-radius:8px;padding:6px;font-size:12px;cursor:pointer}
.cart-btn{background:#e5fbe9}
.buy-btn{background:#fee2e2}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
.modal-content{background:#fff;padding:20px;width:90%;max-width:500px;border-radius:15px;max-height:85vh;overflow:auto}

.slider{display:flex;overflow-x:auto;scroll-snap-type:x mandatory}
.slider img{min-width:100%;height:200px;object-fit:contain;scroll-snap-align:center;border-radius:10px}
.dots{display:flex;justify-content:center;gap:6px;margin:8px 0}
.dot{width:8px;height:8px;border-radius:50%;background:#cbd5e1}
.dot.active{background:#16a34a}

.desc.short{-webkit-line-clamp:3;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden}
.desc-toggle{color:#2563eb;font-size:13px;cursor:pointer}
.price-value{font-size:20px;font-weight:700;color:#14532d}
.topbar{
  position:sticky;
  top:0;
  z-index:20;
  height:56px;
  display:flex;
  align-items:center;
  padding:0 16px;
  background:linear-gradient(135deg,#2563eb,#1e40af);
  border-radius:14px;
  box-shadow:0 8px 20px rgba(37,99,235,.35);
}

/* back button left */
.back-btn{
  width:38px;
  height:38px;
  border-radius:50%;
  border:none;
  background:rgba(255,255,255,.25);
  color:#fff;
  font-size:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:2;
}

/* üî• TITLE TRUE CENTER */
.title{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  margin:0;
  color:#fff;
  font-size:18px;
  font-weight:600;
  letter-spacing:.4px;
  white-space:nowrap;
}
</style>
</head>

<body>

<div class="main">
  <div class="topbar">
  <button class="back-btn" onclick="goBack()">
    <i class="bi bi-arrow-left"></i>
  </button>

  <h2 id="catTitle" class="title">Category Products</h2>

  <!-- üîç SEARCH ICON -->
  <button class="back-btn" style="margin-left:auto" onclick="toggleSearch()">
    <i class="bi bi-search"></i>
  </button>
</div>

<!-- üîç SEARCH BOX (hidden by default) -->
<div id="searchBox" style="
  display:none;
  margin-top:10px;
  background:#fff;
  padding:10px;
  border-radius:10px;
  box-shadow:0 5px 12px rgba(0,0,0,.1);
">
  <input
    type="text"
    id="searchInput"
    placeholder="üîç Product name search ‡§ï‡§∞‡•á‡§Ç..."
    oninput="filterProducts()"
    style="
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #cbd5e1;
      font-size:14px;
    "
  />
</div>
</div>
  <div class="products-grid" id="products"></div>
</div>

<!-- PRODUCT DETAIL MODAL -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <h3 id="dName"></h3>

    <div class="slider" id="dImages"></div>
    <div class="dots" id="dDots"></div>

    <p id="dDesc" class="desc short"></p>
    <span id="descToggle" class="desc-toggle" onclick="toggleDesc()">More ‚¨á</span>

    <div class="price-value" id="dPrice"></div>

    <select id="vehicleType" onchange="updateDelivery()">
  <option value="">Select Vehicle</option>
  <option value="two_wheeler">Two Wheeler</option>
  <option value="three_wheeler">Three Wheeler</option>
  <option value="four_wheeler">Four Wheeler</option>
</select>

<div id="deliveryBox" style="
  margin-top:12px;
  padding:12px;
  border-radius:12px;
  background:#f8fafc;
  box-shadow:0 6px 14px rgba(0,0,0,.08);
  display:none;
">
  <div id="deliveryText">üöö Delivery: ‚Çπ0</div>
  <div id="totalText" style="font-weight:600;margin-top:4px">
    üí∞ Total: ‚Çπ0
  </div>
</div>

<br>
<button class="buy-btn" onclick="directBuy(event)">‚ö° Buy Now</button>
<button onclick="closeAll()">‚ùå Close</button>
  </div>
</div>

<!-- IMAGE MODAL -->
<div class="modal" id="imageModal">
  <div class="modal-content" style="background:#000">
    <img id="fullImg" style="width:100%">
    <button onclick="closeAll()" style="margin-top:10px">Close</button>
  </div>
</div>

<script>
const API = "https://shopbacked-vmhs.onrender.com";
let lastDeliveryCharge = 0;
 let allProducts = []; 
  let currentRetailerLoc = null;
let currentWholesalerLoc = null;
// URL params
const params = new URLSearchParams(location.search);
const wid = params.get("wid");
const category = params.get("category");
document.getElementById("catTitle").innerText = category || "Category Products";

// ---------------- PRODUCTS ----------------
async function loadProducts(){
  try{
    const res = await fetch(`${API}/api/products/wholesaler/${wid}`);
    const data = await res.json();

    allProducts = data.products.filter(
  p => (p.category || "Other") === category
);

renderProducts(allProducts);
    const container = document.getElementById("products");

    if(!list.length){
      container.innerHTML = "<p>No products found</p>";
      return;
    }

    container.innerHTML = list.map(p=>{
      const pdata = encodeURIComponent(JSON.stringify(p));
      return `
        <div class="product-card">
          <img src="${p.images?.[0]||''}">
          <div>${p.productName}</div>
          <div class="price">‚Çπ${p.price}</div>
          <div class="actions">
            <button class="cart-btn" onclick='addToCart(JSON.parse(decodeURIComponent("${pdata}")))'>üõí</button>
            <button class="buy-btn" onclick='openDetail(JSON.parse(decodeURIComponent("${pdata}")))'>‚ö°</button>
          </div>
        </div>
      `;
    }).join("");
  }catch(e){
  console.warn("Products load retry / initial delay", e);
  // ‚ùå alert ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ

  }
}
function renderProducts(list){
  const container = document.getElementById("products");

  if(!list.length){
    container.innerHTML = "<p>No products found</p>";
    return;
  }

  container.innerHTML = list.map(p=>{
    const pdata = encodeURIComponent(JSON.stringify(p));
    return `
      <div class="product-card">
        <img src="${p.images?.[0]||''}">
        <div>${p.productName}</div>
        <div class="price">‚Çπ${p.price}</div>
        <div class="actions">
          <button class="cart-btn"
            onclick='addToCart(JSON.parse(decodeURIComponent("${pdata}")))'>üõí</button>
          <button class="buy-btn"
            onclick='openDetail(JSON.parse(decodeURIComponent("${pdata}")))'>‚ö°</button>
        </div>
      </div>
    `;
  }).join("");
}

  function toggleSearch(){
  const box = document.getElementById("searchBox");
  const input = document.getElementById("searchInput");

  if(box.style.display === "none"){
    box.style.display = "block";
    input.focus();
  }else{
    box.style.display = "none";
    input.value = "";
    renderProducts(allProducts); // reset
  }
}

function filterProducts(){
  const q = document.getElementById("searchInput").value.toLowerCase();

  const filtered = allProducts.filter(p =>
    p.productName.toLowerCase().includes(q)
  );

  renderProducts(filtered);
}
// ---------------- DETAIL ----------------
let selectedProduct = null;

function openDetail(p){
  selectedProduct = p;
  document.getElementById("dName").innerText = p.productName;
  document.getElementById("dPrice").innerText = "‚Çπ" + p.price;
  document.getElementById("dDesc").innerText = p.detail || "No description";

  const imgBox = document.getElementById("dImages");
  const dots = document.getElementById("dDots");
  imgBox.innerHTML = "";
  dots.innerHTML = "";

  (p.images||[]).forEach((img,i)=>{
    imgBox.innerHTML += `<img src="${img}" onclick="openImage('${img}')">`;
    dots.innerHTML += `<div class="dot ${i==0?'active':''}"></div>`;
  });

  document.getElementById("detailModal").style.display="flex";
}

function toggleDesc(){
  document.getElementById("dDesc").classList.toggle("short");
}

function openImage(src){
  document.getElementById("fullImg").src = src;
  document.getElementById("imageModal").style.display="flex";
}

function closeAll(){
  document.getElementById("detailModal").style.display = "none";
  document.getElementById("imageModal").style.display = "none";

  // üî• FULL RESET
  selectedProduct = null;
  document.getElementById("vehicleType").value = "";
  document.getElementById("deliveryBox").style.display = "none";
  document.getElementById("deliveryText").innerText = "";
  document.getElementById("totalText").innerText = "";
  lastDeliveryCharge = 0;
}
function goBack(){
  history.back();
}
// ---------------- CART ----------------
// ---------------- CART ----------------
let cart = JSON.parse(localStorage.getItem("cart")||"[]");
let currentWholesalerId = cart.length ? cart[0].wholesalerId : null;

async function addToCart(p){
  const retailerId = localStorage.getItem("userId");
  if(!retailerId){
    alert("üîê Please login first");
    return;
  }

  // ‡§Ö‡§ó‡§∞ cart ‡§Æ‡•á‡§Ç ‡§™‡§π‡§≤‡•á ‡§∏‡•á products ‡§π‡•à‡§Ç ‡§î‡§∞ wholesaler ‡§Ö‡§≤‡§ó ‡§π‡•à
  if(currentWholesalerId && currentWholesalerId !== p.wholesalerId){
    const confirmClear = confirm("‚ö†Ô∏è ‡§Ü‡§™‡§ï‡§æ cart ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§≠‡§∞‡§æ ‡§π‡•à‡•§ ‡§¶‡•Ç‡§∏‡§∞‡•á wholesaler ‡§ï‡§æ product add ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§™‡•Å‡§∞‡§æ‡§®‡§æ cart clear ‡§π‡•ã‡§ó‡§æ‡•§ Continue?");
    if(!confirmClear) return;

    // üîπ Backend cart clear
    await fetch(`${API}/api/cart/clear/${retailerId}`, { method: "DELETE" });

    // üîπ Frontend cart clear
    cart = [];
    localStorage.removeItem("cart");
    currentWholesalerId = null;

    alert("üßπ ‡§™‡•Å‡§∞‡§æ‡§®‡§æ cart clear ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§ ‡§Ö‡§¨ ‡§®‡§Ø‡§æ product add ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
  }

  try{
    const res = await fetch(`${API}/api/cart/save`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        retailerId,
        item:{
          productId: p._id || p.id,
          productName: p.productName,
          price: p.price,
          image: p.images?.[0] || "",
          wholesalerId: p.wholesalerId,
          shopName: p.shopName,
          mobile: p.mobile,
          address: p.address
        }
      })
    });

    const data = await res.json();

    if(data.success){
      cart.push(p);
      currentWholesalerId = p.wholesalerId;
      localStorage.setItem("cart", JSON.stringify(cart));
      alert("üõí Added to cart successfully");
    }else{
      alert("‚ùå Failed to add to cart");
    }
  }catch(err){
    console.error(err);
    alert("‚ùå Server error");
  }
}

  let deliveryTimer = null;

function updateDelivery(){
  clearTimeout(deliveryTimer);
  deliveryTimer = setTimeout(runDeliveryCalc, 400); // debounce
}




async function runDeliveryCalc(){

  if(!selectedProduct){
    console.warn("‚ùå No product selected");
    return;
  }

  const vehicle = document.getElementById("vehicleType").value;
  const box = document.getElementById("deliveryBox");
  const dText = document.getElementById("deliveryText");
  const tText = document.getElementById("totalText");

  if(!vehicle){
    box.style.display = "none";
    lastDeliveryCharge = 0;
    return;
  }

  /* ================= RETAILER LOCATION ================= */

  const retailerProfile =
    JSON.parse(localStorage.getItem("retailerProfile") || "{}");

  currentRetailerLoc =
    JSON.parse(localStorage.getItem("retailer_location")) ||
    retailerProfile.location ||
    null;

  // üîÑ Normalize retailer location keys
  if(currentRetailerLoc?.latitude && currentRetailerLoc?.longitude){
    currentRetailerLoc = {
      lat: currentRetailerLoc.latitude,
      lng: currentRetailerLoc.longitude
    };
  }

  /* ================= WHOLESALER LOCATION (LIVE) ================= */

  currentWholesalerLoc = null;

  try{
    const resWh = await fetch(
      `${API}/api/wholesalers/profile/${selectedProduct.wholesalerId}`
    );
    const whData = await resWh.json();

    currentWholesalerLoc =
      whData?.profile?.location ||
      whData?.wholesaler?.location ||
      whData?.location ||
      null;

    // üîÑ Normalize wholesaler location keys
    if(currentWholesalerLoc?.latitude && currentWholesalerLoc?.longitude){
      currentWholesalerLoc = {
        lat: currentWholesalerLoc.latitude,
        lng: currentWholesalerLoc.longitude
      };
    }

    console.log("üè™ LIVE Wholesaler Location:", currentWholesalerLoc);

  }catch(err){
    console.error("‚ùå Wholesaler location fetch failed", err);
  }

  /* ================= LOCATION VALIDATION ================= */

  if(
    !currentRetailerLoc?.lat ||
    !currentRetailerLoc?.lng ||
    !currentWholesalerLoc?.lat ||
    !currentWholesalerLoc?.lng
  ){
    box.style.display = "block";
    dText.innerText = "üìç Location missing";
    tText.innerText = "";
    lastDeliveryCharge = 0;

    console.warn("‚ö†Ô∏è Location check failed", {
      retailerLoc: currentRetailerLoc,
      wholesalerLoc: currentWholesalerLoc
    });
    return;
  }

  /* ================= DELIVERY CALCULATION ================= */

  try{
    const res = await fetch(`${API}/api/delivery/calculate`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        orderAmount: Number(selectedProduct.price),
        vehicleType: vehicle,
        retailerLocation: currentRetailerLoc,
        wholesalerLocation: currentWholesalerLoc
      })
    });

    const data = await res.json();

    if(!data.success){
      box.style.display = "block";
      dText.innerText = "‚ùå Delivery calculation failed";
      tText.innerText = "";
      lastDeliveryCharge = 0;
      return;
    }

    /* ================= SAVE FOR PAYMENT ================= */
    lastDeliveryCharge = Number(data.retailerPays);
    const doubleDistance = (Number(data.distanceKm) * 2).toFixed(2);
    const doubleTime = Math.round(Number(data.timeMinutes) * 2);
    /* ================= UI UPDATE ================= */
    box.style.display = "block";

    dText.innerText =
`üöö Delivery ‚Çπ${data.totalDelivery}
(Retailer Pays ‚Çπ${data.retailerPays}, ${data.retailerPercent}%)
‚è±Ô∏è ${doubleTime} min
üìç ‡§ü‡•ã‡§ü‡§≤  ‡§Ü‡§®‡•á  ‡§ú‡§æ‡§®‡•á  ‡§ï‡§æ = ${doubleDistance} km`;

    const total =
      Number(selectedProduct.price) + Number(data.retailerPays);

    tText.innerText = `üí∞ Total ‚Çπ${total}`;

  }catch(err){
    console.error("‚ùå Delivery calc error", err);
    box.style.display = "block";
    dText.innerText = "‚ö†Ô∏è Server error";
    tText.innerText = "";
    lastDeliveryCharge = 0;
  }
}
// ---------------- DIRECT BUY ----------------
let paying = false;

async function directBuy(e){
  e.preventDefault();

  if(paying) return;

  if(!selectedProduct){
    alert("‚ùå Product not selected");
    return;
  }

  if(!currentRetailerLoc || !currentWholesalerLoc){
    alert("üìç Delivery calculate karo");
    return;
  }

  const vehicle = vehicleType.value;
  if(!vehicle){
    alert("üöö Vehicle select karo");
    return;
  }

  const retailerProfile =
  JSON.parse(localStorage.getItem("retailerProfile") || "{}");

if (!retailerProfile.name || !retailerProfile.mobile) {
  alert("üë§ Retailer profile incomplete");
  return;
}

  const totalAmount =
    Number(selectedProduct.price) + Number(lastDeliveryCharge);

  try{
    paying = true;

    /* ================= STEP 1 : CREATE PAYMENT (LIGHT PAYLOAD) ================= */
    const res = await fetch(`${API}/api/orders/pay-and-create`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        amount: totalAmount,
        notes:{
          type: "direct",
          productId: selectedProduct._id,
          wholesalerId: selectedProduct.wholesalerId,
          retailerId: retailerProfile.id,
          vehicleType: vehicle
        }
      })
    });

    const data = await res.json();
    if(!data.success){
      paying = false;
      alert("‚ùå Payment order failed");
      return;
    }

    /* ================= STEP 2 : RAZORPAY ================= */
    const rzp = new Razorpay({
      key: data.key,
      amount: data.amount,
      currency: "INR",
      order_id: data.orderId,

      prefill:{
        name: retailerProfile.name,
        contact: retailerProfile.mobile
      },

      handler: async function (response){

        /* ================= STEP 3 : VERIFY PAYMENT ================= */
        const verifyRes = await fetch(`${API}/api/orders/verify-payment`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature
          })
        });

        const verifyData = await verifyRes.json();
        paying = false;

        if(verifyData.success){
          alert("‚úÖ Payment Successful üéâ");
          closeAll();

          // optional redirect
          // location.href = "orders.html";

        }else{
          alert("‚ùå Payment verify failed");
        }
      },

      modal:{
        ondismiss(){
          paying = false;
          alert("‚ùå Payment cancelled");
        }
      }
    });

    rzp.open();

  }catch(err){
    paying = false;
    console.error(err);
    alert("‚ùå Server error");
  }
}
loadProducts();
</script>
</body>
</html>
