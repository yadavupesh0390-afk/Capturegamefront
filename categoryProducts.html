<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Category Products</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<style>
/* COPY DASHBOARD STYLES */
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:20px}
.header{margin-top:15px;background:#fff;padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.08)}
.products-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px}
.product-card{background:#fff;padding:8px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.product-card img{width:100%;height:110px;object-fit:contain;background:#f8fafc;padding:6px;border-radius:10px}
.price{color:#16a34a;font-weight:600;font-size:13px}
.actions{display:flex;gap:5px;margin-top:6px}
.actions button{flex:1;border:none;border-radius:8px;padding:6px;font-size:12px;cursor:pointer}
.cart-btn{background:#e5fbe9}
.buy-btn{background:#fee2e2}

/* MODAL STYLES COPY DASHBOARD */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
.modal-content{background:#fff;padding:20px;width:90%;max-width:500px;border-radius:15px;max-height:85vh;overflow:auto}
/* SLIDER */
.slider{display:flex;overflow-x:auto;scroll-snap-type:x mandatory}
.slider img{min-width:100%;height:200px;object-fit:cover;scroll-snap-align:center;border-radius:10px;flex-shrink:0}
.dots{display:flex;justify-content:center;gap:6px;margin:8px 0}
.dot{width:8px;height:8px;border-radius:50%;background:#cbd5e1}
.dot.active{background:#16a34a}
.desc{font-size:14px;line-height:1.5;color:#333}
.desc.short{-webkit-line-clamp:3;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden}
.desc-toggle{display:inline-block;color:#2563eb;font-size:13px;cursor:pointer;margin-top:4px;user-select:none}
.price-box{margin:8px 0;padding:8px 12px;background:linear-gradient(135deg,#f0fdf4,#ecfeff);border:1px solid #bbf7d0;border-radius:10px}
.price-row{display:flex;align-items:center;gap:2px;margin-top:2px}
.price-row i{font-size:16px;color:#16a34a}
.price-value{font-size:20px;font-weight:700;color:#14532d}
</style>
</head>
<body>

<div class="main">
  <div class="header"><h3 id="catTitle">Category Products</h3></div>
  <div class="products-grid" id="products"></div>
</div>

<!-- COPY DASHBOARD MODALS -->
<!-- PRODUCT DETAIL -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <h3 id="dName"></h3>
    <div class="slider" id="dImages"></div>
    <div class="dots" id="dDots"></div>
    <p id="dDesc" class="desc short"></p>
    <span id="descToggle" class="desc-toggle" onclick="toggleDesc()">More ‚¨á</span>
    <div class="price-box">
      <div class="price-row">
        <span id="dPrice" class="price-value">0</span>
      </div>
    </div>
    <select id="vehicleType">
      <option value="">Select Vehicle</option>
      <option value="two_wheeler">Two Wheeler</option>
      <option value="three_wheeler">Three Wheeler</option>
      <option value="four_wheeler">Four Wheeler</option>
    </select>
    <button class="buy-btn" onclick="directBuy(event)">‚ö° Buy Now</button>
    <button onclick="closeAll()">Close</button>
  </div>
</div>

<!-- FULL IMAGE -->
<div class="modal" id="imageModal">
  <div class="modal-content" style="padding:10px;background:#000">
    <img id="fullImg" style="width:100%;height:auto;border-radius:10px">
    <button onclick="closeImage()" style="margin-top:10px;background:#fff;border:none;padding:8px 14px;border-radius:8px">‚ùå Close</button>
  </div>
</div>

<script>
const API = "https://shopbacked-vmhs.onrender.com";

// Get params
// Get params
const params = new URLSearchParams(window.location.search);
const wid = params.get("wid");
const category = params.get("category");

document.getElementById("catTitle").innerText = category || "Category Products";

// ------------------- PRODUCTS -------------------
async function loadProducts(){
  try{
    const res = await fetch(`${API}/api/products/wholesaler/${wid}`);
    const data = await res.json();
    const productsList = data.products.filter(p => (p.category || "Other") === category);

    const container = document.getElementById("products");
    container.innerHTML = productsList.map(p=>{
      const pdata = encodeURIComponent(JSON.stringify(p));
      return `
      <div class="product-card">
        <img src="${p.images?.[0] || ''}">
        <div>${p.productName}</div>
        <div class="price">‚Çπ${p.price}</div>
        <div class="actions">
          <button class="cart-btn" onclick='addToCart(JSON.parse(decodeURIComponent("${pdata}")))'>üõí</button>
          <button class="buy-btn" onclick='openDetail(JSON.parse(decodeURIComponent("${pdata}")))'>‚ö°</button>
        </div>
      </div>`;
    }).join("");
  }catch(e){ alert("Products load failed"); console.error(e); }
}

// ------------------- COPY FUNCTIONS FROM DASHBOARD -------------------
let selectedProduct = null;

const dImages = document.getElementById("dImages");
const dDots   = document.getElementById("dDots");
const detailModal = document.getElementById("detailModal");
const dName = document.getElementById("dName");
const dDesc = document.getElementById("dDesc");
const dPrice = document.getElementById("dPrice");
const dTotal = document.getElementById("dTotal");
const vehicleType = document.getElementById("vehicleType");

// --- PRODUCT DETAIL ---
function openDetail(p){
  selectedProduct = p;
  dName.innerText  = p.productName || "";
  dPrice.innerText = "Price ‚Çπ" + (p.price || 0);
  dDesc.innerText  = p.detail || "No description";
  dDesc.classList.add("short");
  document.getElementById("descToggle").innerText = "More ‚¨á";

  // images
  dImages.innerHTML = "";
  dDots.innerHTML   = "";
  const images = (p.images && p.images.length) ? p.images : (p.image?[p.image]:[]);
  images.forEach((img,i)=>{
    dImages.innerHTML += `<img src="${img}" onclick="openImage('${img}')" style="min-width:100%;object-fit:contain;cursor:zoom-in">`;
    dDots.innerHTML += `<div class="dot ${i===0?"active":""}"></div>`;
  });

  dImages.onscroll = ()=>{
    const index = Math.round(dImages.scrollLeft/dImages.clientWidth);
    [...dDots.children].forEach((dot,i)=>dot.classList.toggle("active",i===index));
  }

  detailModal.style.display="flex";
}

function openImage(src){
  document.getElementById("fullImg").src = src;
  document.getElementById("imageModal").style.display="flex";
}
function closeImage(){document.getElementById("imageModal").style.display="none";}
function toggleDesc(){dDesc.classList.toggle("short"); document.getElementById("descToggle").innerText = dDesc.classList.contains("short")?"More ‚¨á":"Less ‚¨Ü";}

// CART
let cart = JSON.parse(localStorage.getItem("cart")||"[]");
function addToCart(p){
  const already = cart.find(item=>item._id===p._id);
  if(already){ alert("Already in cart"); return; }
  cart.push(p);
  localStorage.setItem("cart",JSON.stringify(cart));
  alert("Added to cart ‚úÖ "+p.productName);
}

// BUY DIRECT (simplified)
async function directBuy(e) {
  e.preventDefault();

  if (!vehicleType.value) {
    alert("üöö Select vehicle first");
    return;
  }

  const retailerProfile = JSON.parse(
    localStorage.getItem("retailerProfile") || "{}"
  );

  if (!retailerProfile.mobile) {
    alert("üë§ Please save profile first");
    return;
  }

  const delivery = deliveryChargeByVehicle(vehicleType.value);
  const total = selectedProduct.price + delivery;

  const res = await fetch(`${API}/api/orders/pay-and-create`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: total,
      notes: {
        type: "direct", // ‚úÖüî• MOST IMPORTANT

        productId: selectedProduct._id,
        productName: selectedProduct.productName,
        price: selectedProduct.price,

        wholesalerId: selectedProduct.wholesalerId,
        wholesalerName: selectedProduct.shopName,
        wholesalerMobile: selectedProduct.mobile,
        wholesalerAddress: selectedProduct.address,

        retailerName: retailerProfile.name,
        retailerMobile: retailerProfile.mobile,
        retailerAddress: retailerProfile.address,

        vehicleType: vehicleType.value,
        deliveryCharge: delivery
      }
    })
  });

  const data = await res.json();
  if (!data.success) {
    alert("‚ùå Order create failed");
    return;
  }

  const rzp = new Razorpay({
    key: data.key,
    amount: data.amount,
    currency: "INR",
    order_id: data.order.id,

    handler: function () {
      alert("‚úÖ Payment Successful üéâ");
      alert("üì¶ Order processing ho raha hai");

      closeAll();
      setTimeout(openOrderStatus, 3000);
    },

    modal: {
      ondismiss: function () {
        alert("‚ùå Payment cancelled");
      }
    }
  });

  rzp.open();
}

loadProducts();
</script>
</body>
</html>
