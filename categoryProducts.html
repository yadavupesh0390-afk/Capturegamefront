<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Category Products</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:20px}
.header{margin-top:15px;background:#fff;padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.08)}
.products-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px}
.product-card{background:#fff;padding:8px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.product-card img{width:100%;height:110px;object-fit:contain;background:#f8fafc;padding:6px;border-radius:10px}
.price{color:#16a34a;font-weight:600;font-size:13px}
.actions{display:flex;gap:5px;margin-top:6px}
.actions button{flex:1;border:none;border-radius:8px;padding:6px;font-size:12px;cursor:pointer}
.cart-btn{background:#e5fbe9}
.buy-btn{background:#fee2e2}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
.modal-content{background:#fff;padding:20px;width:90%;max-width:500px;border-radius:15px;max-height:85vh;overflow:auto}

.slider{display:flex;overflow-x:auto;scroll-snap-type:x mandatory}
.slider img{min-width:100%;height:200px;object-fit:contain;scroll-snap-align:center;border-radius:10px}
.dots{display:flex;justify-content:center;gap:6px;margin:8px 0}
.dot{width:8px;height:8px;border-radius:50%;background:#cbd5e1}
.dot.active{background:#16a34a}

.desc.short{-webkit-line-clamp:3;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden}
.desc-toggle{color:#2563eb;font-size:13px;cursor:pointer}
.price-value{font-size:20px;font-weight:700;color:#14532d}
</style>
</head>

<body>

<div class="main">
  <div class="header">
    <h3 id="catTitle">Category Products</h3>
  </div>
  <div class="products-grid" id="products"></div>
</div>

<!-- PRODUCT DETAIL MODAL -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <h3 id="dName"></h3>

    <div class="slider" id="dImages"></div>
    <div class="dots" id="dDots"></div>

    <p id="dDesc" class="desc short"></p>
    <span id="descToggle" class="desc-toggle" onclick="toggleDesc()">More ‚¨á</span>

    <div class="price-value" id="dPrice"></div>

    <select id="vehicleType">
      <option value="">Select Vehicle</option>
      <option value="two_wheeler">Two Wheeler</option>
      <option value="three_wheeler">Three Wheeler</option>
      <option value="four_wheeler">Four Wheeler</option>
    </select>

    <br><br>
    <button class="buy-btn" onclick="directBuy(event)">‚ö° Buy Now</button>
    <button onclick="closeAll()">‚ùå Close</button>
  </div>
</div>

<!-- IMAGE MODAL -->
<div class="modal" id="imageModal">
  <div class="modal-content" style="background:#000">
    <img id="fullImg" style="width:100%">
    <button onclick="closeAll()" style="margin-top:10px">Close</button>
  </div>
</div>

<script>
const API = "https://shopbacked-vmhs.onrender.com";

// URL params
const params = new URLSearchParams(location.search);
const wid = params.get("wid");
const category = params.get("category");

document.getElementById("catTitle").innerText = category || "Category Products";

// ---------------- PRODUCTS ----------------
async function loadProducts(){
  try{
    const res = await fetch(`${API}/api/products/wholesaler/${wid}`);
    const data = await res.json();

    const list = data.products.filter(p => (p.category||"Other") === category);
    const container = document.getElementById("products");

    if(!list.length){
      container.innerHTML = "<p>No products found</p>";
      return;
    }

    container.innerHTML = list.map(p=>{
      const pdata = encodeURIComponent(JSON.stringify(p));
      return `
        <div class="product-card">
          <img src="${p.images?.[0]||''}">
          <div>${p.productName}</div>
          <div class="price">‚Çπ${p.price}</div>
          <div class="actions">
            <button class="cart-btn" onclick='addToCart(JSON.parse(decodeURIComponent("${pdata}")))'>üõí</button>
            <button class="buy-btn" onclick='openDetail(JSON.parse(decodeURIComponent("${pdata}")))'>‚ö°</button>
          </div>
        </div>
      `;
    }).join("");
  }catch(e){
    alert("Failed to load products");
    console.error(e);
  }
}

// ---------------- DETAIL ----------------
let selectedProduct = null;

function openDetail(p){
  selectedProduct = p;
  document.getElementById("dName").innerText = p.productName;
  document.getElementById("dPrice").innerText = "‚Çπ" + p.price;
  document.getElementById("dDesc").innerText = p.detail || "No description";

  const imgBox = document.getElementById("dImages");
  const dots = document.getElementById("dDots");
  imgBox.innerHTML = "";
  dots.innerHTML = "";

  (p.images||[]).forEach((img,i)=>{
    imgBox.innerHTML += `<img src="${img}" onclick="openImage('${img}')">`;
    dots.innerHTML += `<div class="dot ${i==0?'active':''}"></div>`;
  });

  document.getElementById("detailModal").style.display="flex";
}

function toggleDesc(){
  document.getElementById("dDesc").classList.toggle("short");
}

function openImage(src){
  document.getElementById("fullImg").src = src;
  document.getElementById("imageModal").style.display="flex";
}

function closeAll(){
  document.getElementById("detailModal").style.display="none";
  document.getElementById("imageModal").style.display="none";
  selectedProduct = null;
}

// ---------------- CART ----------------
let cart = JSON.parse(localStorage.getItem("cart")||"[]");

function addToCart(p){
  let cart = JSON.parse(localStorage.getItem("retailer_cart") || "[]");

  const exists = cart.find(item => item._id === p._id);
  if(exists){
    alert("Already in cart");
    return;
  }

  cart.push({
    _id: p._id,
    productName: p.productName,
    price: p.price,
    image: p.images?.[0] || "",
    wholesalerId: p.wholesalerId,
    shopName: p.shopName
  });

  localStorage.setItem("retailer_cart", JSON.stringify(cart));
  alert("‚úÖ Added to cart");
}
// ---------------- DIRECT BUY ----------------
async function directBuy(e){
  e.preventDefault();

  if(!selectedProduct){
    alert("Product not selected");
    return;
  }

  const vehicle = vehicleType.value;
  if(!vehicle){
    alert("üöö Select vehicle first");
    return;
  }

  const retailerProfile = JSON.parse(
    localStorage.getItem("retailerProfile") || "{}"
  );

  if(!retailerProfile.mobile){
    alert("üë§ Please save retailer profile first");
    return;
  }

  const delivery = deliveryChargeByVehicle(vehicle);
  const total = selectedProduct.price + delivery;

  try{
    const res = await fetch(`${API}/api/orders/pay-and-create`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        amount: total,
        notes:{
          type:"direct",

          productId: selectedProduct._id,
          productName: selectedProduct.productName,
          price: selectedProduct.price,

          wholesalerId: selectedProduct.wholesalerId,
          wholesalerName: selectedProduct.shopName,
          wholesalerMobile: selectedProduct.mobile,
          wholesalerAddress: selectedProduct.address,

          retailerName: retailerProfile.name,
          retailerMobile: retailerProfile.mobile,
          retailerAddress: retailerProfile.address,

          vehicleType: vehicle,
          deliveryCharge: delivery
        }
      })
    });

    const data = await res.json();
    if(!data.success){
      alert("‚ùå Order create failed");
      return;
    }

    const rzp = new Razorpay({
      key: data.key,
      amount: data.amount,
      currency: "INR",
      order_id: data.order.id,

      handler: function(){
        alert("‚úÖ Payment Successful üéâ");
        closeAll();
      },

      modal:{
        ondismiss:function(){
          alert("‚ùå Payment cancelled");
        }
      }
    });

    rzp.open();

  }catch(err){
    console.error(err);
    alert("‚ùå Payment error");
  }
}
loadProducts();
</script>
</body>
</html>
