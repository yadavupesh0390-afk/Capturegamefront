<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Retailer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:20px}
.icon-bar{display:flex;gap:20px;justify-content:center;background:#064e3b;padding:12px;border-radius:14px;max-width:720px;margin:auto}
.icon-btn{background:#16a34a;color:#fff;border:none;width:55px;height:55px;border-radius:50%;font-size:22px;cursor:pointer;position:relative}
.header{margin-top:15px;background:#fff;padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.08)}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-top:20px}
.product-card{background:#fff;padding:10px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.product-card img{width:100%;height:100px;object-fit:cover;border-radius:8px}
.price{color:#16a34a;font-weight:600}
.actions{display:flex;gap:6px;margin-top:8px}
.actions button{flex:1;border:none;border-radius:8px;padding:6px;font-size:13px;cursor:pointer}
.cart-btn{background:#dcfce7}
.buy-btn{background:#fee2e2}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
.modal-content{background:#fff;padding:20px;width:92%;max-width:480px;border-radius:16px;max-height:85vh;overflow:auto}

input,select,textarea{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc}
button.primary{background:#16a34a;color:#fff;border:none;padding:10px;border-radius:10px;cursor:pointer;width:100%}

.cart-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eee}
.order-card{background:#fff;padding:12px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);margin-bottom:10px}
.small{font-size:12px;color:#555}
</style>
</head>

<body>

<div class="main">

<div class="icon-bar">
<button class="icon-btn" onclick="openProfile()"><i class="bi bi-person"></i></button>
<button class="icon-btn" onclick="openOrders()"><i class="bi bi-bag-check"></i></button>
<button class="icon-btn" onclick="openCart()"><i class="bi bi-cart"></i></button>
</div>

<div class="header"><h3>üõí Retailer Dashboard</h3></div>

<div class="header">
<input id="wid" placeholder="Enter Wholesaler ID">
<button class="primary" onclick="loadProducts()">Search Products</button>
</div>

<div class="products-grid" id="products"></div>

</div>

<!-- PRODUCT DETAIL -->
<div class="modal" id="detailModal">
<div class="modal-content">
<h3 id="dName"></h3>
<img id="dImg" style="width:100%;border-radius:10px">
<p class="price" id="dPrice"></p>

<select id="vehicleType">
<option value="">Select Vehicle</option>
<option value="two_wheeler">Two Wheeler</option>
<option value="three_wheeler">Three Wheeler</option>
<option value="four_wheeler">Four Wheeler</option>
</select>

<p id="dTotal"></p>
<button class="primary" onclick="buyNow()">Pay & Order</button>
<button onclick="closeAll()">Close</button>
</div>
</div>

<!-- CART -->
<div class="modal" id="cartModal">
<div class="modal-content">
<h3>üß∫ Cart</h3>
<div id="cartItems"></div>

<select id="cartVehicle" onchange="updateCartTotal()">
<option value="">Select Vehicle</option>
<option value="two_wheeler">Two Wheeler</option>
<option value="three_wheeler">Three Wheeler</option>
<option value="four_wheeler">Four Wheeler</option>
</select>

<b id="cartTotal"></b>
<button class="primary" onclick="payCart()">Pay & Order</button>
<button onclick="closeAll()">Close</button>
</div>
</div>

<!-- PROFILE -->
<div class="modal" id="profileModal">
<div class="modal-content">
<h3>Retailer Profile</h3>
<input id="pName" placeholder="Name">
<input id="pMobile" placeholder="Mobile">
<textarea id="pAddress" placeholder="Address"></textarea>
<button class="primary" onclick="saveProfile()">Save</button>
<button onclick="closeAll()">Close</button>
</div>
</div>

<!-- ORDERS -->
<div class="modal" id="ordersModal">
<div class="modal-content">
<h3>üì¶ My Orders</h3>
<div id="ordersData"></div>
<button onclick="closeAll()">Close</button>
</div>
</div>

<script>
const API = "https://shopbacked-vmhs.onrender.com";
const retailerId = localStorage.getItem("userId") || "demoRetailer";
let selectedProduct = null;
let cart = JSON.parse(localStorage.getItem("cart") || "[]");

/* UTILS */
function deliveryCharge(v){
return v==="two_wheeler"?1:v==="three_wheeler"?50:80;
}

/* LOAD PRODUCTS */
async function loadProducts(){
const wid = document.getElementById("wid").value.trim();
const res = await fetch(`${API}/api/products/wholesaler/${wid}`);
const data = await res.json();

products.innerHTML = data.products.map(p=>`
<div class="product-card">
<img src="${p.image}">
<div>${p.productName}</div>
<div class="price">‚Çπ${p.price}</div>
<div class="actions">
<button class="cart-btn" onclick='addToCart(${JSON.stringify(p)})'>üõí</button>
<button class="buy-btn" onclick='openDetail(${JSON.stringify(p)})'>‚ö°</button>
</div>
</div>
`).join("");
}

/* DETAIL */
function openDetail(p){
selectedProduct = p;
dName.innerText = p.productName;
dImg.src = p.image;
dPrice.innerText = "‚Çπ"+p.price;
dTotal.innerText = "";
detailModal.style.display = "flex";
}

/* BUY NOW */
async function buyNow(){
const vehicle = vehicleType.value;
if(!vehicle) return alert("Select vehicle");

const dc = deliveryCharge(vehicle);
const total = selectedProduct.price + dc;
dTotal.innerText = "Total ‚Çπ"+total;

const r = await fetch(`${API}/api/orders/pay-and-create`,{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({amount:total})
});
const d = await r.json();

new Razorpay({
key:d.key,
amount:d.order.amount,
order_id:d.order.id,
handler: async resp=>{
await fetch(`${API}/api/orders/confirm-after-payment`,{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
paymentId:resp.razorpay_payment_id,
productId:selectedProduct._id,
retailerId,
totalAmount:total
})
});
alert("Order placed");
closeAll();
}
}).open();
}

/* CART */
function addToCart(p){
cart.push(p);
localStorage.setItem("cart",JSON.stringify(cart));
alert("Added to cart");
}

function openCart(){
if(cart.length===0){
cartItems.innerHTML="Cart empty";
cartModal.style.display="flex";
return;
}

let sum=0;
cartItems.innerHTML = cart.map((c,i)=>{
sum+=c.price;
return `<div class="cart-item">${c.productName} ‚Çπ${c.price}
<button onclick="removeCart(${i})">‚ùå</button></div>`;
}).join("");

cartTotal.innerText="Subtotal ‚Çπ"+sum;
cartModal.style.display="flex";
}

function removeCart(i){
cart.splice(i,1);
localStorage.setItem("cart",JSON.stringify(cart));
openCart();
}

function updateCartTotal(){
const v = cartVehicle.value;
let sum = cart.reduce((s,i)=>s+i.price,0);
cartTotal.innerText="Total ‚Çπ"+(sum+deliveryCharge(v));
}

/* PAY CART */
async function payCart(){
const v = cartVehicle.value;
if(!v) return alert("Select vehicle");

let sum = cart.reduce((s,i)=>s+i.price,0);
let total = sum + deliveryCharge(v);

const r = await fetch(`${API}/api/orders/pay-and-create`,{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({amount:total})
});
const d = await r.json();

new Razorpay({
key:d.key,
amount:d.order.amount,
order_id:d.order.id,
handler: async resp=>{
alert("Cart Order Placed");
cart=[];
localStorage.removeItem("cart");
closeAll();
}
}).open();
}

/* PROFILE */
async function openProfile(){
profileModal.style.display="flex";
const r = await fetch(`${API}/api/retailers/profile/${retailerId}`);
const d = await r.json();
if(d.profile){
pName.value=d.profile.name||"";
pMobile.value=d.profile.mobile||"";
pAddress.value=d.profile.address||"";
}
}

async function saveProfile(){
await fetch(`${API}/api/retailers/saveProfile`,{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
retailerId,
name:pName.value,
mobile:pMobile.value,
address:pAddress.value
})
});
alert("Profile saved");
closeAll();
}

/* ORDERS */
async function openOrders(){
ordersModal.style.display="flex";
const p = pMobile.value;
if(!p) return ordersData.innerHTML="Save profile first";

const r = await fetch(`${API}/api/orders/retailer/${p}`);
const d = await r.json();

ordersData.innerHTML = d.orders.map(o=>`
<div class="order-card">
<b>${o.productName}</b>
<div class="small">Status: ${o.status}</div>
<div class="small">‚Çπ${o.totalAmount}</div>
</div>
`).join("");
}

function closeAll(){
document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
}
</script>

</body>
</html>
