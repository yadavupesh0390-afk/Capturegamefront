<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Retailer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:20px}
.icon-bar{display:flex;gap:20px;justify-content:center;background:#064e3b;padding:12px;border-radius:14px;max-width:700px;margin:auto}
.icon-btn{background:#16a34a;color:#fff;border:none;width:55px;height:55px;border-radius:50%;font-size:22px;cursor:pointer;position:relative}
.notify-dot{position:absolute;top:8px;right:8px;width:10px;height:10px;border-radius:50%;background:red;display:none}
.header{margin-top:15px;background:#fff;padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.08)}
.products-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px}
.product-card{background:#fff;padding:8px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.product-card img{
  width:100%;
  height:110px;              /* thoda bada */
  object-fit:contain;        /* üî• FULL IMAGE dikhegi */
  background:#f8fafc;        /* white/soft bg */
  padding:6px;               /* breathing space */
  border-radius:10px;
}
.price{color:#16a34a;font-weight:600;font-size:13px}
.actions{display:flex;gap:5px;margin-top:6px}
.actions button{flex:1;border:none;border-radius:8px;padding:6px;font-size:12px;cursor:pointer}
.cart-btn{background:#e5fbe9}
.buy-btn{background:#fee2e2}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
.modal-content{background:#fff;padding:20px;width:90%;max-width:500px;border-radius:15px;max-height:85vh;overflow:auto}
input,select,textarea{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc}
button.primary{background:#16a34a;color:#fff;border:none;padding:10px;border-radius:10px;cursor:pointer;width:100%}
.cart-item{border-bottom:1px solid #ddd;padding:8px 0}
.order-card{background:#fff;padding:12px;margin-bottom:10px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.badge{background:#e0f2fe;padding:4px 10px;border-radius:20px;font-size:12px}
.small{font-size:12px;color:#555}
.delivery-card{background:#f8fafc;border-left:5px solid #16a34a;padding:14px;border-radius:12px;margin-bottom:12px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
.delivery-row{display:flex;justify-content:space-between;font-size:14px;margin:4px 0;}
.delivery-label{color:#555;}
.delivery-value{font-weight:600;color:#111;}
.delivery-code{background:#dcfce7;color:#166534;padding:4px 10px;border-radius:20px;font-weight:600;display:inline-block;margin-top:6px;}
.status-card{background:#ffffff;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 6px 14px rgba(0,0,0,.08);border-left:6px solid #2563eb;}
.status-product{font-size:16px;font-weight:600;color:#111;margin-bottom:6px;}
.status-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:13px;font-weight:600;margin-bottom:8px;}
.status-pending{ background:#fef3c7;color:#92400e; }
.status-confirmed{ background:#dcfce7;color:#166534; }
.status-delivery{ background:#e0f2fe;color:#075985; }
.status-delivered{ background:#ede9fe;color:#5b21b6; }
.status-time{font-size:13px;color:#555;}
.slider{
  display:flex;
  overflow-x:auto;
  scroll-snap-type:x mandatory;
}

.slider img{
  min-width:100%;
  height:200px;
  object-fit:cover;
  scroll-snap-align:center;
  border-radius:10px;
  flex-shrink:0;
}

.dots{
  display:flex;
  justify-content:center;
  gap:6px;
  margin:8px 0;
}

.dot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:#cbd5e1;
}

.dot.active{
  background:#16a34a;
}

  #imageModal .modal-content{
  max-width:95%;
  max-height:90vh;
  text-align:center;
}

#imageModal img{
  max-height:80vh;
  object-fit:contain;
}
.desc{
  font-size:14px;
  line-height:1.5;
  color:#333;
}

.desc.short{
  display:-webkit-box;
  -webkit-line-clamp:3;   /* üëà kitni line dikhani hai */
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.desc-toggle{
  display:inline-block;
  color:#2563eb;
  font-size:13px;
  cursor:pointer;
  margin-top:4px;
  user-select:none;
}
.price-box{
  margin:8px 0;
  padding:8px 12px;

  background: linear-gradient(135deg,#f0fdf4,#ecfeff);
  border:1px solid #bbf7d0;
  border-radius:10px;
}

.price-label{
  font-size:10px;
  color:#16a34a;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.4px;
}

.price-row{
  display:flex;
  align-items:center;
  gap:2px;
  margin-top:2px;
}

.price-row i{
  font-size:16px;
  color:#16a34a;
}

.price-value{
  font-size:20px;
  font-weight:700;
  color:#14532d;
}
  /* CATEGORY GRID (Retailer Dashboard) */
.category-card{
  background: linear-gradient(135deg,#ecfeff,#f0fdf4);
  border:1px solid #bbf7d0;
  border-radius:16px;
  padding:20px 12px;
  text-align:center;
  cursor:pointer;
  box-shadow:0 6px 14px rgba(0,0,0,.08);
  transition:all .25s ease;
  position:relative;
}

.category-card:hover{
  transform:translateY(-5px);
  box-shadow:0 12px 24px rgba(0,0,0,.15);
}

.category-icon{
  width:52px;
  height:52px;
  margin:auto;
  border-radius:50%;
  background:#16a34a;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  margin-bottom:10px;
}

.category-name{
  font-size:15px;
  font-weight:600;
  color:#14532d;
  letter-spacing:.3px;
}

/* grid spacing improvement */
.products-grid{
  gap:16px;
}

  /* ===== CART UI ===== */
.cart-card{
  display:flex;
  align-items:center;
  gap:10px;
  background:#fff;
  padding:10px;
  border-radius:12px;
  box-shadow:0 3px 8px rgba(0,0,0,.08);
  margin-bottom:10px;
}

.cart-img{
  width:55px;
  height:55px;
  object-fit:cover;
  border-radius:8px;
  background:#f8fafc;
}

.cart-info{
  flex:1;
}

.cart-name{
  font-size:14px;
  font-weight:600;
}

.cart-price{
  font-size:13px;
  color:#16a34a;
}

.cart-qty{
  font-size:12px;
  color:#555;
}

.cart-actions button{
  background:#ef4444;
  color:#fff;
  border:none;
  border-radius:8px;
  padding:6px 8px;
  font-size:12px;
  cursor:pointer;
}
/* ===== PROFILE MODAL ===== */
#profileModal .modal-content {
  background: #fff;
  padding: 20px 20px 30px 20px;
  width: 90%;
  max-width: 450px;
  border-radius: 15px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 6px 14px rgba(0,0,0,0.08);
}

/* Heading */
#profileModal h3 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 22px;
  color: #14532d;
  font-weight: 600;
}

/* Inputs & Textarea */
#profileModal input,
#profileModal textarea {
  width: 100%;
  padding: 12px 10px;
  margin: 10px 0;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 14px;
  font-family: Poppins, sans-serif;
  box-sizing: border-box;
  transition: border 0.2s, box-shadow 0.2s;
}

#profileModal input:focus,
#profileModal textarea:focus {
  outline: none;
  border-color: #16a34a;
  box-shadow: 0 0 5px rgba(22,163,74,0.3);
}

#profileModal textarea {
  resize: vertical;
  min-height: 70px;
}

/* Buttons */
#profileModal button.primary {
  background: #16a34a;
  color: #fff;
  border: none;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  width: 100%;
  margin-top: 15px;
  font-size: 16px;
  font-weight: 600;
  transition: background 0.2s;
}

#profileModal button.primary:hover {
  background: #14532d;
}

#profileModal button:not(.primary) {
  background: #f3f6fb;
  color: #111;
  border: none;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  width: 100%;
  margin-top: 10px;
  font-size: 14px;
  transition: background 0.2s;
}

#profileModal button:not(.primary):hover {
  background: #e0e7ff;
}

/* ===== CURRENT LOCATION SECTION ===== */
#profileModal .location-group {
  display: flex;
  flex-direction: column; /* vertical layout */
  gap: 8px;              /* space between input & button */
  margin: 12px 0;
}

#profileModal .location-group label {
  font-size: 14px;
  font-weight: 500;
  color: #14532d;
}

#profileModal .location-group input {
  width: 100%;
  padding: 12px;
  font-size: 14px;
  border: 1px solid #16a34a;
  border-radius: 10px;
  background: #f8fafc;
  box-sizing: border-box;
}

#profileModal .location-group button {
  width: 100%;            /* button full width like input */
  padding: 12px;
  font-size: 15px;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  background: #16a34a;
  color: #fff;
  cursor: pointer;
  transition: background 0.2s;
}

#profileModal .location-group button:hover {
  background: #14532d;
}

/* Responsive tweaks for small height screens */
@media (max-height: 500px) {
  #profileModal .modal-content {
    max-height: 90vh;
  }
}
</style>
</head>
<body>

<div class="main">
  <div class="icon-bar">
    <button class="icon-btn" onclick="openRetailerProfile()"><i class="bi bi-person-circle"></i></button>
    <button class="icon-btn" onclick="openOrderStatus()"><i class="bi bi-bag-check"></i></button>
    <button class="icon-btn" onclick="openCart()"><i class="bi bi-cart"></i></button>
    <button class="icon-btn" onclick="openDeliveryDetails()">
      <i class="bi bi-truck"></i><span id="deliveryDot" class="notify-dot"></span>
    </button>
  </div>

  <div class="header"><h3>üõí Retailer Dashboard</h3></div>

  <div class="header">
    <input id="wid" placeholder="Enter Wholesaler ID">
    <button class="primary" onclick="loadProducts()">Search</button>
  </div>
<div class="products-grid" id="categories"></div>
</div>

<!-- PRODUCT DETAIL -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <h3 id="dName"></h3>
    <div class="slider" id="dImages"></div>
<div class="dots" id="dDots"></div>
    <p id="dDesc" class="desc short"></p>
<span id="descToggle" class="desc-toggle" onclick="toggleDesc()">More ‚¨á</span>
    <div class="price-box">
  <div class="price-row">
  <span id="dPrice" class="price-value">0</span>
</div>
</div>
    <!-- VEHICLE DROPDOWN -->
<select id="vehicleType" onchange="updateDelivery()">  
  <option value="">Select Vehicle</option>  
  <option value="two_wheeler">Two Wheeler</option>  
  <option value="three_wheeler">Three Wheeler</option>  
  <option value="four_wheeler">Four Wheeler</option>  
</select>

<p id="dDelivery"></p>
<p id="dTotal"></p>
    <button class="buy-btn" onclick="directBuy(event)">
  <i class="bi bi-lightning-fill"></i>
  Buy Now
</button>
<button type="button" onclick="closeAll()">Close</button>
  </div>
</div>

<!-- CART -->
<div class="modal" id="cartModal">
  <div class="modal-content">
    <h3 style="text-align:center">üß∫ My Cart</h3>
    <div id="cartItems" style="margin-top:10px"></div>
    <div style="margin-top:12px">
      <select id="cartVehicle" onchange="updateCartTotal()">
        <option value="">üöö Select Vehicle</option>
        <option value="two_wheeler">Two Wheeler</option>
        <option value="three_wheeler">Three Wheeler</option>
        <option value="four_wheeler">Four Wheeler</option>
      </select>
    </div>
    <div style="background:#f8fafc;padding:12px;border-radius:10px;margin-top:12px">
      <div id="cartSubtotal" class="small"></div>
      <div id="cartDelivery" class="small"></div>
      <hr>
      <b id="cartGrandTotal"></b>
    </div>
    <button class="primary" style="margin-top:12px" onclick="payCart()">üí≥ Pay & Order</button>
    <button onclick="closeAll()">Close</button>
  </div>
</div>

<!-- PROFILE -->
<div class="modal" id="profileModal">
  <div class="modal-content">
    <h3>Retailer Profile</h3>

    <input id="profileName" placeholder="Name">
    <input id="profileMobile" placeholder="Mobile">
    <textarea id="profileAddress" placeholder="Address"></textarea>

    <!-- ‚úÖ Current Location (Modified) -->
<div class="location-group">
  <label>üìç Current Location (lat, lng)</label>
  <input id="profileLocation" placeholder="Fetching location..." readonly>
  <button onclick="getRetailerLocation()">üìå Set Current Location</button>
</div>
    <button class="primary" onclick="saveProfile()">Save</button>
    <button onclick="closeAll()">Close</button>
  </div>
</div>

<!-- ORDER STATUS -->
<div class="modal" id="orderStatusModal">
  <div class="modal-content">
    <h3 style="text-align:center;margin-bottom:16px">üì¶ Order Status</h3>
    <div id="orderStatusData"></div>
    <button class="primary" onclick="closeAll()">Close</button>
  </div>
</div>

<!-- DELIVERY DETAILS -->
<div class="modal" id="deliveryModal">
  <div class="modal-content">
    <h3 style="text-align:center;margin-bottom:15px">üöö Delivery Details</h3>
    <div id="deliveryData"></div>
    <button class="primary" onclick="closeAll()">Close</button>
  </div>
</div>
<!-- FULL IMAGE VIEW -->
<div class="modal" id="imageModal">
  <div class="modal-content" style="padding:10px;background:#000">
    <img id="fullImg" style="width:100%;height:auto;border-radius:10px">
    <button onclick="closeImage()"
      style="margin-top:10px;background:#fff;border:none;padding:8px 14px;border-radius:8px">
      ‚ùå Close
    </button>
  </div>
</div>
  
<script>
const API = "https://shopbacked-vmhs.onrender.com";

let selectedProduct = null;
let cart = [];

// DOM elements
const dImages = document.getElementById("dImages");
const dDots   = document.getElementById("dDots");
  
const products = document.getElementById("products");
const detailModal = document.getElementById("detailModal");
const dName = document.getElementById("dName");
const dImg = document.getElementById("dImg");
const dDesc = document.getElementById("dDesc");
const dPrice = document.getElementById("dPrice");
const dDelivery = document.getElementById("dDelivery");
const dTotal = document.getElementById("dTotal");
const vehicleType = document.getElementById("vehicleType");
const cartModal = document.getElementById("cartModal");
const cartItems = document.getElementById("cartItems");
const cartSubtotal = document.getElementById("cartSubtotal");
const cartDelivery = document.getElementById("cartDelivery");
const cartGrandTotal = document.getElementById("cartGrandTotal");
const cartVehicle = document.getElementById("cartVehicle");
const profileModal = document.getElementById("profileModal");
const profileName = document.getElementById("profileName");
const profileMobile = document.getElementById("profileMobile");
const profileAddress = document.getElementById("profileAddress");
const orderStatusModal = document.getElementById("orderStatusModal");
const orderStatusData = document.getElementById("orderStatusData");
const deliveryModal = document.getElementById("deliveryModal");
const deliveryData = document.getElementById("deliveryData");
const deliveryDot = document.getElementById("deliveryDot");

// Utility
function formatDT(d){ const dt=new Date(d); return dt.toLocaleDateString()+" "+dt.toLocaleTimeString(); }


// ------------------- PRODUCTS -------------------
async function loadProducts(){
  const wid = document.getElementById("wid").value.trim();
  if(!wid) return alert("Enter Wholesaler ID");

  try{
    const res = await fetch(`${API}/api/products/wholesaler/${wid}`);
    const data = await res.json();

    const categoriesContainer = document.getElementById("categories");

    if(!data.products || !data.products.length){
      categoriesContainer.innerHTML = "<p>No categories found</p>";
      return;
    }

    // üî• product se unique categories nikalo
    const map = {};
    data.products.forEach(p=>{
      const cat = p.category || "Other";
      map[cat] = true;
    });

    categoriesContainer.innerHTML = Object.keys(map).map(cat=>`
  <div class="category-card"
       onclick="openCategory('${encodeURIComponent(cat)}','${wid}')">

    <div class="category-icon">
      <i class="bi bi-box-seam"></i>
    </div>

    <div class="category-name">
      ${cat}
    </div>

  </div>
`).join("");

  }catch(e){
    console.error(e);
    alert("Failed to load categories");
  }
}
function openCategory(categoryId, wid){
  // Query params ke saath redirect
  window.location.href = `categoryProducts.html?wid=${wid}&category=${categoryId}`;
}

// ------------------- PRODUCT DETAIL -------------------
function openDetail(p){
  selectedProduct = p;

  /* ================= BASIC DETAILS ================= */
  dName.innerText  = p.productName || "";
  dPrice.innerText = "Price ‚Çπ" + (p.price || 0);

  /* ================= DESCRIPTION (READ MORE RESET) ================= */
  dDesc.innerText = p.detail || "No description available";
  dDesc.classList.add("short");
  document.getElementById("descToggle").innerText = "More ‚¨á";

  /* ================= DELIVERY RESET ================= */
  dDelivery.innerText = "";
  dTotal.innerText = "";
  vehicleType.value = "";

  /* ================= MULTIPLE IMAGES ================= */
  dImages.innerHTML = "";
  dDots.innerHTML   = "";

  const images = (p.images && p.images.length)
    ? p.images
    : (p.image ? [p.image] : []);

  images.forEach((img, i) => {
    dImages.innerHTML += `
      <img 
        src="${img}" 
        onclick="openImage('${img}')"
        style="min-width:100%;object-fit:contain;cursor:zoom-in"
      >
    `;

    dDots.innerHTML += `
      <div class="dot ${i === 0 ? "active" : ""}"></div>
    `;
  });

  /* ================= DOT ACTIVE ON SCROLL ================= */
  dImages.onscroll = () => {
    const index = Math.round(
      dImages.scrollLeft / dImages.clientWidth
    );

    [...dDots.children].forEach((dot, i) => {
      dot.classList.toggle("active", i === index);
    });
  };

async function fetchDeliveryEstimate(orderAmount, vehicleType){
  const retailerLoc = JSON.parse(localStorage.getItem("retailer_location"));
  const wholesalerLoc = selectedProduct?.wholesalerLocation; // backend se aayega

  if(!retailerLoc || !wholesalerLoc) return;

  const res = await fetch(`${API}/api/delivery/calculate`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      orderAmount,
      vehicleType,
      retailerLocation: retailerLoc,
      wholesalerLocation: wholesalerLoc
    })
  });

  return await res.json();
}


  
  /* ================= OPEN MODAL ================= */
  detailModal.style.display = "flex";
}

  function openImage(src){
  document.getElementById("fullImg").src = src;
  document.getElementById("imageModal").style.display = "flex";
}

function closeImage(){
  document.getElementById("imageModal").style.display = "none";
}

 function toggleDesc(){
  const desc = document.getElementById("dDesc");
  const toggle = document.getElementById("descToggle");

  if(desc.classList.contains("short")){
    desc.classList.remove("short");
    toggle.innerText = "Less ‚¨Ü";
  }else{
    desc.classList.add("short");
    toggle.innerText = "More ‚¨á";
  }
 } 


  async function getDeliveryFromServer({ orderAmount, vehicleType }) {

  const retailerLoc =
    JSON.parse(localStorage.getItem("retailer_location"));

  const wholesalerLoc =
  selectedProduct?.wholesalerLocation ||
  cart?.[0]?.wholesalerLocation;

  if (!retailerLoc || !wholesalerLoc) {
    throw new Error("Location missing");
  }

  const res = await fetch(`${API}/api/delivery/calculate`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      orderAmount,
      vehicleType,
      retailerLocation: retailerLoc,
      wholesalerLocation: wholesalerLoc
    })
  });

  return await res.json();
}
async function directBuy(e) {
  e.preventDefault();

  // üöö Vehicle check
  if (!vehicleType.value) {
    alert("üöö Select vehicle first");
    return;
  }

  // üë§ Retailer profile check
  const retailerProfile = JSON.parse(
    localStorage.getItem("retailerProfile") || "{}"
  );

  if (!retailerProfile.mobile) {
    alert("üë§ Please save profile first");
    return;
  }

  // üìç Locations
  const retailerLoc = JSON.parse(localStorage.getItem("retailer_location"));
  const wholesalerLoc = selectedProduct.wholesalerLocation;
  if (!retailerLoc || !wholesalerLoc) {
    alert("üìç Location missing");
    return;
  }

  // ===============================
  // ‚úÖ DELIVERY FROM BACKEND
  // ===============================
  const deliveryRes = await fetch(`${API}/api/delivery/calculate`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      orderAmount: selectedProduct.price,
      vehicleType: vehicleType.value,
      retailerLocation: retailerLoc,
      wholesalerLocation: wholesalerLoc
    })
  });

  const deliveryData = await deliveryRes.json();

  if (!deliveryData.success) {
    alert(deliveryData.message || "Delivery calculation failed");
    return;
  }

  // üßæ UI update
  dDelivery.innerText =
    `Delivery ‚Çπ${deliveryData.retailerPays}
     (${deliveryData.retailerPercent}% retailer)`;

  const totalAmount =
    selectedProduct.price + deliveryData.retailerPays;

  dTotal.innerText = `Total ‚Çπ${totalAmount}`;

  // ===============================
  // ‚úÖ CREATE ORDER + PAYMENT
  // ===============================
  const res = await fetch(`${API}/api/orders/pay-and-create`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: totalAmount,
      notes: {
        type: "direct", // üî• IMPORTANT

        productId: selectedProduct._id,
        productName: selectedProduct.productName,
        price: selectedProduct.price,

        wholesalerId: selectedProduct.wholesalerId,
        wholesalerName: selectedProduct.shopName,
        wholesalerMobile: selectedProduct.mobile,
        wholesalerAddress: selectedProduct.address,

        retailerName: retailerProfile.name,
        retailerMobile: retailerProfile.mobile,
        retailerAddress: retailerProfile.address,

        vehicleType: vehicleType.value,

        // ‚úÖ DELIVERY BREAKUP (VERY IMPORTANT)
        deliveryCharge: deliveryData.totalDelivery,
        retailerDeliveryPay: deliveryData.retailerPays,
        wholesalerDeliveryPay: deliveryData.wholesalerPays,
        distanceKm: deliveryRes.distanceKm
      }
    })
  });

  const data = await res.json();

  if (!data.success) {
    alert("‚ùå Order create failed");
    return;
  }

  // ===============================
  // ‚úÖ RAZORPAY
  // ===============================
  const rzp = new Razorpay({
    key: data.key,
    amount: data.amount,
    currency: "INR",
    order_id: data.order.id,

    handler: function () {
      alert("‚úÖ Payment Successful üéâ");
      alert("üì¶ Order processing ho raha hai");

      closeAll();
      setTimeout(openOrderStatus, 3000);
    },

    modal: {
      ondismiss: function () {
        alert("‚ùå Payment cancelled");
      }
    }
  });

  rzp.open();
}

  
  
  // ------------------- CART -------------------
async function addToCart(p){

  const retailerId = localStorage.getItem("userId");
  if(!retailerId){
    alert("üîê Please login first");
    return;
  }

  // üîÅ DUPLICATE CHECK
  const already = cart.find(item => item._id === p._id);
  if(already){
    alert("‚ö†Ô∏è Product already in cart");
    return;
  }

  // ‚úÖ ADD TO CART (LOCAL)
  cart.push(p);

  try{
    const res = await fetch(`${API}/api/cart/save`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
  retailerId,
  item:{
  productId: p._id,
  productName: p.productName,
  price: p.price,
  image: p.images?.[0] || "",
  wholesalerId: p.wholesalerId,
  shopName: p.shopName,
  mobile: p.mobile,
  address: p.address,

  // üî• ADD THIS
  wholesalerLocation: p.wholesalerLocation
}
})
    });

    const data = await res.json();

    if(data.success){
      localStorage.setItem("cart", JSON.stringify(cart));

      alert(
        "üõí Added to cart successfully ‚úÖ\n\n" +
        "Product: " + p.productName + "\n" +
        "Price: ‚Çπ" + p.price
      );
    }else{
      // ‚ùå rollback
      cart = cart.filter(item => item._id !== p._id);
      alert("‚ùå Failed to add item to cart");
    }

  }catch(err){
    console.error("ADD CART ERROR:", err);

    // ‚ùå rollback
    cart = cart.filter(item => item._id !== p._id);
    alert("‚ùå Server error while adding to cart");
  }
}

async function loadCart(){
  const retailerId = localStorage.getItem("userId");

  const res = await fetch(`${API}/api/cart/${retailerId}`);
  const data = await res.json();

  const cartDiv = document.getElementById("cartItems");

  if(!data.items || !data.items.length){
    cartDiv.innerHTML = "<p style='text-align:center'>üõí Cart is empty</p>";
    return;
  }

  cartDiv.innerHTML = data.items.map(i=>`
    <div class="cart-card">

      <img src="${i.image}" class="cart-img">

      <div class="cart-info">
        <div class="cart-name">${i.productName}</div>
        <div class="cart-price">‚Çπ${i.price}</div>
        <div class="cart-qty">Qty: ${i.quantity}</div>
      </div>

      <div class="cart-actions">
        <button onclick="removeFromCart('${i.productId}')">‚ùå</button>
      </div>

    </div>
  `).join("");

  // üîÑ local cart sync
  cart = data.items;
  updateCartTotal();
}


function openCart(){
  document.getElementById("cartModal").style.display = "flex";
  loadCart(); // ‚úÖ yahin se cart load hoga
}
async function removeCart(i){
  cart.splice(i,1);
  try{
    await fetch(`${API}/api/cart/save`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ retailerId: localStorage.getItem("userId"), items: cart })
    });
    localStorage.setItem("cart", JSON.stringify(cart));
    openCart();
  }catch(e){ alert("Failed to remove item"); }
}
async function removeFromCart(productId){
  const retailerId = localStorage.getItem("userId");

  const res = await fetch(`${API}/api/cart/remove`,{
    method:"DELETE",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ retailerId, productId })
  });

  const data = await res.json();

  if(data.success){
    loadCart(); // üîÑ refresh
  }else{
    alert("‚ùå Failed to remove item");
  }
}
async function updateCartTotal() {

  if (!cartVehicle.value || cart.length === 0) {
    cartSubtotal.innerText = "";
    cartDelivery.innerText = "";
    cartGrandTotal.innerText = "";
    window.__cartDelivery = null;
    return;
  }

  const subtotal = cart.reduce((s, i) => s + i.price, 0);

  const deliveryData = await getDeliveryFromServer({
    orderAmount: subtotal,
    vehicleType: cartVehicle.value
  });

  if (!deliveryData.success) {
    alert(deliveryData.message || "Delivery calculation failed");
    return;
  }

  // ‚úÖ UI update
  cartSubtotal.innerText = `Subtotal ‚Çπ${subtotal}`;
  cartDelivery.innerText = `Delivery ‚Çπ${deliveryData.retailerPays}`;
  cartGrandTotal.innerText =
    `Total ‚Çπ${subtotal + deliveryData.retailerPays}`;

  // ‚úÖ IMPORTANT: store for payment
  window.__cartDelivery = {
    subtotal,
    ...deliveryData
  };
}

async function payCart() {

  const vehicle = cartVehicle.value;
  if (!vehicle) {
    alert("üöö Select vehicle first");
    return;
  }

  const profile = JSON.parse(localStorage.getItem("retailerProfile") || "{}");
  if (!profile.mobile) {
    alert("üë§ Save profile first");
    return;
  }

  if (!cart || cart.length === 0) {
    alert("üõí Cart empty");
    return;
  }

  // ‚úÖ Subtotal
  const subtotal = cart.reduce((s, i) => s + i.price, 0);

  try {
    // üîπ STEP 1: DELIVERY CALCULATION FROM SERVER
    const deliveryRes = await getDeliveryFromServer({
      orderAmount: subtotal,
      vehicleType: vehicle
    });

    if (!deliveryRes.success) {
      alert(deliveryRes.message || "Delivery calculation failed");
      return;
    }

    const retailerDelivery = deliveryRes.retailerPays;
    const wholesalerDelivery = deliveryRes.wholesalerPays;
    const totalDelivery = deliveryRes.totalDelivery;

    const totalAmount = subtotal + retailerDelivery;

    // üîπ STEP 2: CREATE PAYMENT
    const res = await fetch(`${API}/api/orders/pay-and-create`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        amount: totalAmount, // ‚úÖ FIXED
        notes: {
          type: "cart", // ‚úÖüî• CRITICAL

          retailerName: profile.name,
          retailerMobile: profile.mobile,
          retailerAddress: profile.address,

          vehicleType: vehicle,

          // ‚úÖ DELIVERY BREAKUP (IMPORTANT)
          deliveryCharge: totalDelivery,
          retailerDeliveryPay: retailerDelivery,
          wholesalerDeliveryPay: wholesalerDelivery,

          products: JSON.stringify(
            cart.map(p => ({
              productId: p._id,
              productName: p.productName,
              price: p.price,

              wholesalerId: p.wholesalerId,
              wholesalerName: p.shopName,
              wholesalerMobile: p.mobile,
              wholesalerAddress: p.address,
              wholesalerLocation: p.wholesalerLocation // ‚úÖ standard key
            }))
          )
        }
      })
    });

    const data = await res.json();
    if (!data.success) {
      alert("‚ùå Payment init failed");
      return;
    }

    // üîπ STEP 3: OPEN RAZORPAY
    const rzp = new Razorpay({
      key: data.key,
      amount: data.amount,
      currency: "INR",
      order_id: data.order.id,

      handler: function () {
        localStorage.removeItem("cart");
        cart = [];

        alert("‚úÖ Cart Payment Successful üéâ\nüì¶ Orders processing me hain");

        closeAll();
        setTimeout(openOrderStatus, 3000);
      },

      modal: {
        ondismiss: function () {
          alert("‚ùå Payment cancelled");
        }
      }
    });

    rzp.open();

  } catch (err) {
    console.error("CART PAYMENT ERROR:", err);
    alert("‚ùå Payment failed");
  }
}

// ------------------- DELIVERY -------------------
async function openDeliveryDetails(){
  deliveryModal.style.display="flex";

  const profile = JSON.parse(localStorage.getItem("retailerProfile")||"{}");
  if(!profile.mobile){
    deliveryData.innerHTML="Profile not found";
    return;
  }

  try{
    const res = await fetch(`${API}/api/orders/retailer/${profile.mobile}`);
    const data = await res.json();

    const visibleOrders = data.orders.filter(o =>
      o.status === "delivery_code_generated" || o.status === "delivered"
    );

    if(visibleOrders.length===0){
      deliveryData.innerHTML="<p style='text-align:center;color:#666'>No delivery details yet</p>";
      return;
    }

    deliveryData.innerHTML = visibleOrders.map(o=>{
      const lastStatusTime =
        o.statusHistory && o.statusHistory.length
          ? o.statusHistory[o.statusHistory.length - 1].time
          : o.createdAt;

      const d = new Date(lastStatusTime);

      return `
      <div class="delivery-card">
        <div class="delivery-row">
          <span class="delivery-label">üì¶ Product</span>
          <span class="delivery-value">${o.productName || "-"}</span>
        </div>

        <div class="delivery-row">
          <span class="delivery-label">üë§ Delivery Boy</span>
          <span class="delivery-value">${o.deliveryBoyName || "Assigned"}</span>
        </div>

        <div class="delivery-row">
          <span class="delivery-label">üïí Time</span>
          <span class="delivery-value">${d.toLocaleDateString("en-IN")} ${d.toLocaleTimeString("en-IN")}</span>
        </div>

        ${o.deliveryCode
          ? `<div class="delivery-code">üîê Delivery Code : ${o.deliveryCode}</div>`
          : `<div class="delivery-code">‚è≥ Waiting for code...</div>`
        }
      </div>`;
    }).join("");

  }catch(e){
    deliveryData.innerHTML="Failed to load delivery details";
  }
}

// ------------------- ORDER STATUS -------------------
async function openOrderStatus(){
  orderStatusModal.style.display="flex";
  const profile = JSON.parse(localStorage.getItem("retailerProfile")||"{}");
  if(!profile.mobile){
    orderStatusData.innerHTML="Profile not found";
    return;
  }
  try{
    const res = await fetch(`${API}/api/orders/retailer/${profile.mobile}`);
    const data = await res.json();
    if(!data.orders || data.orders.length===0){
      orderStatusData.innerHTML="<p style='text-align:center;color:#666'>No orders found</p>";
      return;
    }
    orderStatusData.innerHTML = data.orders.map(o=>{
      const d = new Date(o.updatedAt || o.createdAt);
      let cls = "status-pending";
      if(o.status.includes("confirmed")) cls="status-confirmed";
      if(o.status.includes("delivery")) cls="status-delivery";
      if(o.status==="delivered") cls="status-delivered";
      return `<div class="status-card">
        <div class="status-product">${o.productName}</div>
        <div class="status-badge ${cls}">${o.status.replaceAll("_"," ").toUpperCase()}</div>
        <div class="status-time">üïí ${d.toLocaleDateString("en-IN")} ${d.toLocaleTimeString("en-IN")}</div>
      </div>`;
    }).join("");
  }catch(e){ orderStatusData.innerHTML="Failed to load orders"; }
}

// ------------------- PROFILE -------------------
/* PROFILE */

async function openRetailerProfile() {

  profileModal.style.display = "flex";

  const retailerId = localStorage.getItem("userId");
  if(!retailerId){
    alert("Login required");
    return;
  }

  try{
    const res = await fetch(`${API}/api/retailers/profile/${retailerId}`);
    const data = await res.json();

    if(data.success && data.profile){

      profileName.value    = data.profile.name || "";
      profileMobile.value  = data.profile.mobile || "";
      profileAddress.value = data.profile.address || "";

      // ‚úÖ Current Location
      if(data.profile.location){
        profileLocation.value =
          data.profile.location.lat.toFixed(6) + ", " +
          data.profile.location.lng.toFixed(6);
      } else {
        profileLocation.value = "";
      }

      // ‚úÖ Cache for order/delivery
      localStorage.setItem(
        "retailerProfile",
        JSON.stringify(data.profile)
      );

      // ‚úÖ Cache location separately (optional)
      if(data.profile.location){
        localStorage.setItem(
          "retailer_location",
          JSON.stringify(data.profile.location)
        );
      }

    } else {
      profileName.value = "";
      profileMobile.value = "";
      profileAddress.value = "";
      profileLocation.value = "";
    }

  } catch(err){
    alert("Server error");
  }
}



async function saveProfile() {

  if(!profileMobile.value.trim()){
    alert("Mobile required");
    return;
  }

  // ‚úÖ Prepare payload
  const payload = {
    retailerId: localStorage.getItem("userId"),
    name: profileName.value.trim(),
    mobile: profileMobile.value.trim(),
    address: profileAddress.value.trim(),
    location: null  // default
  };

  // ‚úÖ Try to get current location if available
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        payload.location = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };
        // Update profileLocation input for user
        if(document.getElementById("profileLocation")){
          document.getElementById("profileLocation").value =
            payload.location.lat.toFixed(6) + ", " +
            payload.location.lng.toFixed(6);
        }

        // ‚úÖ Send payload to server after getting location
        sendProfile(payload);

      },
      (err) => {
        console.warn("Location not available:", err.message);
        // Still send profile without location
        sendProfile(payload);
      },
      { enableHighAccuracy: true, timeout: 5000 }
    );
  } else {
    // Geolocation not supported
    sendProfile(payload);
  }

}

// ‚úÖ Helper function to send profile to server
async function sendProfile(payload){
  try{
    const res = await fetch(`${API}/api/retailers/saveProfile`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if(data.success){
      // ‚úÖ Save to localStorage
      localStorage.setItem("retailerProfile", JSON.stringify(payload));
      if(payload.location){
        localStorage.setItem("retailer_location", JSON.stringify(payload.location));
      }

      alert("‚úÖ Profile server me save ho gaya");
      closeAll();
    } else {
      alert("‚ùå Save failed");
    }
  }catch(err){
    console.error("SaveProfile Error:", err);
    alert("Server error");
  }
}
  function getRetailerLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude.toFixed(6);
        const lng = position.coords.longitude.toFixed(6);
        document.getElementById("profileLocation").value = `${lat}, ${lng}`;
      },
      (err) => {
        alert("Unable to fetch location: " + err.message);
      }
    );
  } else {
    alert("Geolocation not supported by your browser");
  }
}
// ------------------- NOTIFY -------------------
setInterval(async()=>{
  const profile = JSON.parse(localStorage.getItem("retailerProfile")||"{}");
  if(!profile.mobile) return;
  try{
    const res = await fetch(`${API}/api/orders/retailer/${profile.mobile}`);
    const data = await res.json();
    deliveryDot.style.display = data.orders.some(o=>o.deliveryBoyName) ? "block":"none";
  }catch(e){}
},8000);

// ------------------- CLOSE MODALS -------------------
function closeAll(){
  document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
}
</script>
</body>
</html>
