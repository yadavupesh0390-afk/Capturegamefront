<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Retailer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:20px}
.icon-bar{display:flex;gap:20px;justify-content:center;background:#064e3b;padding:12px;border-radius:14px;max-width:650px;margin:auto}
.icon-btn{background:#16a34a;color:#fff;border:none;width:55px;height:55px;border-radius:50%;font-size:22px;cursor:pointer;position:relative}
.header{margin-top:15px;background:#fff;padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.08)}
.products-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px}
.product-card{background:#fff;padding:6px;border-radius:10px;text-align:center;cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.product-card img{width:100%;height:90px;object-fit:cover;border-radius:8px}
.price{color:#16a34a;font-weight:600;font-size:13px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
.modal-content{background:#fff;padding:20px;width:90%;max-width:500px;border-radius:15px}
select,button{width:100%;padding:10px;margin-top:10px;border-radius:10px;border:none}
.primary{background:#16a34a;color:#fff;font-size:16px}
</style>
</head>

<body>
<div class="main">

  <!-- ICON BAR -->
  <div class="icon-bar">
    <button class="icon-btn" onclick="openProfile()"><i class="bi bi-person-circle"></i></button>
    <button class="icon-btn" onclick="openOrders()"><i class="bi bi-bag-check"></i></button>
  </div>

  <!-- HEADER -->
  <div class="header">
    <h3>ðŸ›’ Retailer Dashboard</h3>
  </div>

  <!-- WHOLESALER SEARCH -->
  <div class="header">
    <input id="wid" placeholder="Enter Wholesaler ID">
    <button class="primary" onclick="loadProducts()">Search</button>
  </div>

  <!-- PRODUCTS -->
  <div class="products-grid" id="products"></div>
</div>

<!-- PRODUCT DETAIL -->
<div class="modal" id="detailModal">
 <div class="modal-content">
  <h3 id="dName"></h3>
  <img id="dImg" style="width:100%;border-radius:10px">
  <p id="dPrice"></p>
  <p><b>Shop:</b> <span id="dShop"></span></p>
  <p><b>Address:</b> <span id="dAddress"></span></p>

  <select id="vehicleType">
    <option value="">Select Vehicle</option>
    <option value="two_wheeler">Two Wheeler</option>
    <option value="three_wheeler">Three Wheeler</option>
    <option value="four_wheeler">Four Wheeler</option>
  </select>

  <button class="primary" onclick="startPayment()">ðŸ’³ Pay Now</button>
  <button onclick="closeAll()">Cancel</button>
 </div>
</div>

<!-- PROFILE -->
<div class="modal" id="profileModal">
 <div class="modal-content">
  <h3>Retailer Profile</h3>
  <input id="pName" placeholder="Name">
  <input id="pMobile" placeholder="Mobile">
  <textarea id="pAddress" placeholder="Address"></textarea>
  <button class="primary" onclick="saveProfile()">Save</button>
  <button onclick="closeAll()">Close</button>
 </div>
</div>

<script>
const API="https://shopbacked-vmhs.onrender.com";
const TOKEN=localStorage.getItem("token");
let selectedProduct=null;

/* LOAD PRODUCTS */
async function loadProducts(){
 const id=document.getElementById("wid").value.trim();
 if(!id) return alert("Enter Wholesaler ID");

 const res=await fetch(`${API}/api/products/wholesaler/${id}`);
 const data=await res.json();

 products.innerHTML=data.products.map(p=>`
  <div class="product-card" onclick='showDetail(${JSON.stringify(p)})'>
    <img src="${p.image}">
    <div>${p.productName}</div>
    <div class="price">â‚¹${p.price}</div>
  </div>
 `).join("") || "No products";
}

/* SHOW DETAIL */
function showDetail(p){
 selectedProduct=p;
 dName.innerText=p.productName;
 dImg.src=p.image;
 dPrice.innerText="â‚¹"+p.price;
 dShop.innerText=p.shopName;
 dAddress.innerText=p.address;
 detailModal.style.display="flex";
}

/* PAYMENT START */
async function startPayment(){
 if(!vehicleType.value) return alert("Select vehicle");

 const res=await fetch(API+"/api/pay/create-order",{
  method:"POST",
  headers:{
   "Content-Type":"application/json",
   "Authorization":"Bearer "+TOKEN
  },
  body:JSON.stringify({
   productId:selectedProduct._id,
   vehicleType:vehicleType.value
  })
 });

 const data=await res.json();

 const options={
  key:data.key,
  amount:data.amount,
  currency:"INR",
  name:"ShopBacked",
  description:selectedProduct.productName,
  order_id:data.razorpayOrderId,
  handler:function(resp){
   finalizeOrder(resp.razorpay_payment_id);
  }
 };

 new Razorpay(options).open();
}

/* CONFIRM ORDER */
async function finalizeOrder(paymentId){
 const res=await fetch(API+"/api/orders/confirm-after-payment",{
  method:"POST",
  headers:{
   "Content-Type":"application/json",
   "Authorization":"Bearer "+TOKEN
  },
  body:JSON.stringify({
   productId:selectedProduct._id,
   vehicleType:vehicleType.value,
   paymentId
  })
 });

 const data=await res.json();
 alert(data.success?"Order Placed âœ…":"Failed");
 closeAll();
}

/* PROFILE */
function openProfile(){
 const p=JSON.parse(localStorage.getItem("retailerProfile")||"{}");
 pName.value=p.name||""; pMobile.value=p.mobile||""; pAddress.value=p.address||"";
 profileModal.style.display="flex";
}
function saveProfile(){
 const p={name:pName.value,mobile:pMobile.value,address:pAddress.value};
 localStorage.setItem("retailerProfile",JSON.stringify(p));
 alert("Saved âœ…"); closeAll();
}

/* HELPERS */
function closeAll(){document.querySelectorAll(".modal").forEach(m=>m.style.display="none")}
</script>
</body>
</html>
