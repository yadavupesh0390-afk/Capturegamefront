<!DOCTYPE html>    <html lang="hi">    
<head>    
<meta charset="UTF-8">    
<title>Retailer Dashboard</title>    
<meta name="viewport" content="width=device-width, initial-scale=1.0">    
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">    
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">    
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>    
<style>    
*{box-sizing:border-box;font-family:Poppins,sans-serif}    
body{margin:0;background:#f3f6fb}    
.main{padding:20px}    
.icon-bar{display:flex;gap:20px;justify-content:center;background:#064e3b;padding:12px;border-radius:14px;max-width:700px;margin:auto}    
.icon-btn{background:#16a34a;color:#fff;border:none;width:55px;height:55px;border-radius:50%;font-size:22px;cursor:pointer;position:relative}    
.notify-dot{position:absolute;top:8px;right:8px;width:10px;height:10px;border-radius:50%;background:red;display:none}    
.header{margin-top:15px;background:#fff;padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.08)}    
.products-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px}    
.product-card{background:#fff;padding:8px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}    
.product-card img{    
  width:100%;    
  height:110px;              /* thoda bada */    
  object-fit:contain;        /* üî• FULL IMAGE dikhegi */    
  background:#f8fafc;        /* white/soft bg */    
  padding:6px;               /* breathing space */    
  border-radius:10px;    
}    
.price{color:#16a34a;font-weight:600;font-size:13px}    
.actions{display:flex;gap:5px;margin-top:6px}    
.actions button{flex:1;border:none;border-radius:8px;padding:6px;font-size:12px;cursor:pointer}    
.cart-btn{background:#e5fbe9}    
.buy-btn{background:#fee2e2}    
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}    
.modal-content{background:#fff;padding:20px;width:90%;max-width:500px;border-radius:15px;max-height:85vh;overflow:auto}    
input,select,textarea{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc}    
button.primary{background:#16a34a;color:#fff;border:none;padding:10px;border-radius:10px;cursor:pointer;width:100%}    
.cart-item{border-bottom:1px solid #ddd;padding:8px 0}    
.order-card{background:#fff;padding:12px;margin-bottom:10px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}    
.badge{background:#e0f2fe;padding:4px 10px;border-radius:20px;font-size:12px}    
.small{font-size:12px;color:#555}    
.delivery-card{background:#f8fafc;border-left:5px solid #16a34a;padding:14px;border-radius:12px;margin-bottom:12px;box-shadow:0 4px 10px rgba(0,0,0,.08)}    
.delivery-row{display:flex;justify-content:space-between;font-size:14px;margin:4px 0;}    
.delivery-label{color:#555;}    
.delivery-value{font-weight:600;color:#111;}    
.delivery-code{background:#dcfce7;color:#166534;padding:4px 10px;border-radius:20px;font-weight:600;display:inline-block;margin-top:6px;}    
.status-card{background:#ffffff;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 6px 14px rgba(0,0,0,.08);border-left:6px solid #2563eb;}    
.status-product{font-size:16px;font-weight:600;color:#111;margin-bottom:6px;}    
.status-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:13px;font-weight:600;margin-bottom:8px;}    
.status-pending{ background:#fef3c7;color:#92400e; }    
.status-confirmed{ background:#dcfce7;color:#166534; }    
.status-delivery{ background:#e0f2fe;color:#075985; }    
.status-delivered{ background:#ede9fe;color:#5b21b6; }    
.status-time{font-size:13px;color:#555;}    
.slider{    
  display:flex;    
  overflow-x:auto;    
  scroll-snap-type:x mandatory;    
}    .slider img{
min-width:100%;
height:200px;
object-fit:cover;
scroll-snap-align:center;
border-radius:10px;
flex-shrink:0;
}

.dots{
display:flex;
justify-content:center;
gap:6px;
margin:8px 0;
}

.dot{
width:8px;
height:8px;
border-radius:50%;
background:#cbd5e1;
}

.dot.active{
background:#16a34a;
}

#imageModal .modal-content{
max-width:95%;
max-height:90vh;
text-align:center;
}

#imageModal img{
max-height:80vh;
object-fit:contain;
}
.desc{
font-size:14px;
line-height:1.5;
color:#333;
}

.desc.short{
display:-webkit-box;
-webkit-line-clamp:3;   /* üëà kitni line dikhani hai */
-webkit-box-orient:vertical;
overflow:hidden;
}

.desc-toggle{
display:inline-block;
color:#2563eb;
font-size:13px;
cursor:pointer;
margin-top:4px;
user-select:none;
}
.price-box{
margin:8px 0;
padding:8px 12px;

background: linear-gradient(135deg,#f0fdf4,#ecfeff);
border:1px solid #bbf7d0;
border-radius:10px;
}

.price-label{
font-size:10px;
color:#16a34a;
font-weight:600;
text-transform:uppercase;
letter-spacing:.4px;
}

.price-row{
display:flex;
align-items:center;
gap:2px;
margin-top:2px;
}

.price-row i{
font-size:16px;
color:#16a34a;
}

.price-value{
font-size:20px;
font-weight:700;
color:#14532d;
}
/* CATEGORY GRID (Retailer Dashboard) */
.category-card{
background: linear-gradient(135deg,#ecfeff,#f0fdf4);
border:1px solid #bbf7d0;
border-radius:16px;
padding:20px 12px;
text-align:center;
cursor:pointer;
box-shadow:0 6px 14px rgba(0,0,0,.08);
transition:all .25s ease;
position:relative;
}

.category-card:hover{
transform:translateY(-5px);
box-shadow:0 12px 24px rgba(0,0,0,.15);
}

.category-icon{
width:52px;
height:52px;
margin:auto;
border-radius:50%;
background:#16a34a;
color:#fff;
display:flex;
align-items:center;
justify-content:center;
font-size:26px;
margin-bottom:10px;
}

.category-name{
font-size:15px;
font-weight:600;
color:#14532d;
letter-spacing:.3px;
}

/* grid spacing improvement */
.products-grid{
gap:16px;
}

/* ===== CART UI ===== */
.cart-card{
display:flex;
align-items:center;
gap:10px;
background:#fff;
padding:10px;
border-radius:12px;
box-shadow:0 3px 8px rgba(0,0,0,.08);
margin-bottom:10px;
}

.cart-img{
width:55px;
height:55px;
object-fit:cover;
border-radius:8px;
background:#f8fafc;
}

.cart-info{
flex:1;
}

.cart-name{
font-size:14px;
font-weight:600;
}

.cart-price{
font-size:13px;
color:#16a34a;
}

.cart-qty{
font-size:12px;
color:#555;
}

.cart-actions button{
background:#ef4444;
color:#fff;
border:none;
border-radius:8px;
padding:6px 8px;
font-size:12px;
cursor:pointer;
}
/* ===== PROFILE MODAL ===== */
#profileModal .modal-content {
background: #fff;
padding: 20px 20px 30px 20px;
width: 90%;
max-width: 450px;
border-radius: 15px;
max-height: 85vh;
overflow-y: auto;
box-shadow: 0 6px 14px rgba(0,0,0,0.08);
}

/* Heading */
#profileModal h3 {
text-align: center;
margin-bottom: 20px;
font-size: 22px;
color: #14532d;
font-weight: 600;
}

/* Inputs & Textarea */
#profileModal input,
#profileModal textarea {
width: 100%;
padding: 12px 10px;
margin: 10px 0;
border-radius: 10px;
border: 1px solid #ccc;
font-size: 14px;
font-family: Poppins, sans-serif;
box-sizing: border-box;
transition: border 0.2s, box-shadow 0.2s;
}

#profileModal input:focus,
#profileModal textarea:focus {
outline: none;
border-color: #16a34a;
box-shadow: 0 0 5px rgba(22,163,74,0.3);
}

#profileModal textarea {
resize: vertical;
min-height: 70px;
}

/* Buttons */
#profileModal button.primary {
background: #16a34a;
color: #fff;
border: none;
padding: 12px;
border-radius: 10px;
cursor: pointer;
width: 100%;
margin-top: 15px;
font-size: 16px;
font-weight: 600;
transition: background 0.2s;
}

#profileModal button.primary:hover {
background: #14532d;
}

#profileModal button:not(.primary) {
background: #f3f6fb;
color: #111;
border: none;
padding: 12px;
border-radius: 10px;
cursor: pointer;
width: 100%;
margin-top: 10px;
font-size: 14px;
transition: background 0.2s;
}

#profileModal button:not(.primary):hover {
background: #e0e7ff;
}

/* ===== CURRENT LOCATION SECTION ===== /
#profileModal .location-group {
display: flex;
flex-direction: column; / vertical layout /
gap: 8px;              / space between input & button */
margin: 12px 0;
}

#profileModal .location-group label {
font-size: 14px;
font-weight: 500;
color: #14532d;
}

#profileModal .location-group input {
width: 100%;
padding: 12px;
font-size: 14px;
border: 1px solid #16a34a;
border-radius: 10px;
background: #f8fafc;
box-sizing: border-box;
}

#profileModal .location-group button {
width: 100%;            /* button full width like input */
padding: 12px;
font-size: 15px;
font-weight: 600;
border: none;
border-radius: 10px;
background: #16a34a;
color: #fff;
cursor: pointer;
transition: background 0.2s;
}

#profileModal .location-group button:hover {
background: #14532d;
}

/* Responsive tweaks for small height screens */
@media (max-height: 500px) {
#profileModal .modal-content {
max-height: 90vh;
}
}
#chargeInfoModal {
position: fixed;
inset: 0;
display: none;
align-items: center;
justify-content: center;
background: rgba(0,0,0,0.5);
z-index: 1000;
}
#chargeInfoModal ul li {
padding: 6px 0;
border-bottom: 1px solid #444;
}
#chargeInfoModal ul li:last-child {
border-bottom: none;
}
#chargeInfoModal ul li.highlight {
background: #333;
font-weight: 600;
color: #16a34a;
padding-left: 6px;
border-radius: 4px;
}
  /* ===== ORDER STATUS FIX ===== */

.order-status-box{
  padding:0;                 /* header ke liye */
  max-height:85vh;
  display:flex;
  flex-direction:column;
}

/* üîí Header fixed */
.order-status-header{
  position: sticky;
  top: 0;
  background: #fff;
  z-index: 10;
  padding: 14px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:1px solid #eee;
}

/* ‚ùå Close icon */
.order-close{
  font-size:20px;
  cursor:pointer;
  color:#ef4444;
}

/* üîÅ Sirf content scroll hoga */
.order-status-scroll{
  flex:1;
  overflow-y:auto;
  padding:16px;
}
  /* ===== DELIVERY MODAL FIX ===== */

.delivery-box{
  padding:0;
  max-height:85vh;
  display:flex;
  flex-direction:column;
}

/* üîí Header fixed */
.delivery-header{
  position:sticky;
  top:0;
  background:#fff;
  z-index:10;
  padding:14px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #eee;
}

.delivery-header h3{
  margin:0;
  font-size:16px;
}

/* ‚ùå Close icon */
.delivery-close{
  font-size:20px;
  cursor:pointer;
  color:#ef4444;
}

/* üîÅ Scrollable content */
.delivery-scroll{
  flex:1;
  overflow-y:auto;
  padding:16px;
}

/* üîí Footer fixed */
.delivery-footer{
  position:sticky;
  bottom:0;
  background:#fff;
  padding:12px;
  border-top:1px solid #eee;
  text-align:center;
}
</style>

</head>    
<body>    <div class="main">    
  <div class="icon-bar">    
    <button class="icon-btn" onclick="openRetailerProfile()"><i class="bi bi-person-circle"></i></button>    
    <button class="icon-btn" onclick="openOrderStatus()"><i class="bi bi-bag-check"></i></button>    
    <button class="icon-btn" onclick="openCart()"><i class="bi bi-cart"></i></button>    
    <button class="icon-btn" onclick="openDeliveryDetails()">    
      <i class="bi bi-truck"></i><span id="deliveryDot" class="notify-dot"></span>    
    </button>    
  </div>      <!-- üîπ DELIVERY CHARGE INFO PATTi -->      <div     
    onclick="showChargeInfo(0)"     
    style="    
      background:#16a34a;     
      color:#fff;     
      text-align:center;     
      padding:8px 12px;     
      border-radius:8px;     
      font-weight:600;     
      cursor:pointer;    
      margin-bottom:10px;    
      max-width:400px;    
      margin-left:auto;    
      margin-right:auto;    
      box-shadow:0 4px 8px rgba(0,0,0,0.1);    
      font-size:14px;    
    ">    
    ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§ö‡§æ‡§∞‡•ç‡§ú ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä    
  </div>      <!-- üîπ HEADER / DASHBOARD TITLE -->      <div class="header">    
    <h3>üõí Retailer Dashboard</h3>    
  </div>      <!-- üîπ CATEGORY / PRODUCTS GRID -->      <div class="header">    
    <input id="wid" placeholder="Enter Wholesaler ID">    
    <button class="primary" onclick="loadProducts()">Search</button>    
  </div>    
  <div class="products-grid" id="categories"></div>    
</div>    <!-- PRODUCT DETAIL -->    <div class="modal" id="detailModal">    
  <div class="modal-content">    
    <h3 id="dName"></h3>    
    <div class="slider" id="dImages"></div>    
<div class="dots" id="dDots"></div>    
    <p id="dDesc" class="desc short"></p>    
<span id="descToggle" class="desc-toggle" onclick="toggleDesc()">More ‚¨á</span>    
    <div class="price-box">    
  <div class="price-row">    
  <span id="dPrice" class="price-value">0</span>    
</div>    
</div>    
    <!-- VEHICLE DROPDOWN -->    
<select id="vehicleType" onchange="updateDelivery()">      
  <option value="">Select Vehicle</option>      
  <option value="two_wheeler">Two Wheeler</option>      
  <option value="three_wheeler">Three Wheeler</option>      
  <option value="four_wheeler">Four Wheeler</option>      
</select>    <p id="dDelivery"></p>    
<p id="dTotal"></p>    
    <button class="buy-btn" onclick="directBuy(event)">    
  <i class="bi bi-lightning-fill"></i>    
  Buy Now    
</button>    
<button type="button" onclick="closeAll()">Close</button>    
  </div>    
</div>    <!-- CART -->    <div class="modal" id="cartModal">    
  <div class="modal-content">    
    <h3 style="text-align:center">üß∫ My Cart</h3>    
    <div id="cartItems" style="margin-top:10px"></div>    
    <!-- üöö CART VEHICLE SELECT -->    
<select id="cartVehicle" onchange="updateCartDelivery()">    
  <option value="">üöö Select Vehicle</option>    
  <option value="two_wheeler">Two Wheeler</option>    
  <option value="three_wheeler">Three Wheeler</option>    
  <option value="four_wheeler">Four Wheeler</option>    
</select>    <div    
  id="cartDeliveryBox"    
  style="    
    display:none;    
    background:#f0fdf4;    
    border-left:4px solid #16a34a;    
    padding:12px;    
    border-radius:10px;    
    margin-top:12px;    
    box-shadow:0 4px 10px rgba(0,0,0,0.08)    
  "    
>    
  <div id="cartDeliveryText"></div>    
  <hr>    
  <b id="cartTotalText"></b>    
</div>    
    <button class="primary" style="margin-top:12px" onclick="payCart()">üí≥ Pay & Order</button>    
    <button onclick="closeAll()">Close</button>    
  </div>    
</div>    <!-- PROFILE -->    <div class="modal" id="profileModal">    
  <div class="modal-content">    
    <h3>Retailer Profile</h3>    <input id="profileName" placeholder="Shop Name (Short address)">    
<input id="profileMobile" placeholder="Mobile">    
    

<!-- ‚úÖ Current Location (Modified) -->

<div class="location-group">    
  <label>üìç Current Location (lat, lng)</label>    
  <input id="profileLocation" placeholder="Fetching location..." readonly>    
  <button onclick="getRetailerLocation()">üìå Set Current Location</button>
  <small id="locationTimer" style="color:#9ca3af; display:block; margin-top:6px;"></small>
</div> 
    <button
    id="adminHelpBtn"
    style="
      display:none;
      margin-top:10px;
      background:#dc2626;
      color:#fff;
      padding:10px 16px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      width:100%;
    "
    onclick="contactAdminForLocation()"
  >
    üÜò Admin Help (Location Correction)
    </button>
    <button class="primary" onclick="saveProfile()">Save</button>    
    <button onclick="closeAll()">Close</button>    
  </div>    
</div>    <!-- ORDER STATUS -->        
  <div class="modal" id="orderStatusModal">    
  <div class="modal-content order-status-box">    

    <!-- üîí FIXED HEADER -->
    <div class="order-status-header">
      <h3>üì¶ Order Status</h3>
      <span class="order-close" onclick="closeAll()">‚úñ</span>
    </div>

    <!-- üîÅ SCROLLABLE CONTENT -->
    <div id="orderStatusData" class="order-status-scroll"></div>

  </div>    
</div>    <!-- DELIVERY DETAILS -->    <div class="modal" id="deliveryModal">
  <div class="modal-content delivery-box">

    <!-- üîí FIXED HEADER -->
    <div class="delivery-header">
      <h3>üöö Delivery Details</h3>
      <span class="delivery-close" onclick="closeAll()">‚úñ</span>
    </div>

    <!-- üîÅ SCROLL AREA -->
    <div id="deliveryData" class="delivery-scroll"></div>

    <!-- üîí FIXED FOOTER (optional close button) -->
    <div class="delivery-footer">
      <button class="primary" onclick="closeAll()">Close</button>
    </div>

  </div>
</div>
<!-- FULL IMAGE VIEW -->    
<div class="modal" id="imageModal">    
  <div class="modal-content" style="padding:10px;background:#000">    
    <img id="fullImg" style="width:100%;height:auto;border-radius:10px">    
    <button onclick="closeImage()"    
      style="margin-top:10px;background:#fff;border:none;padding:8px 14px;border-radius:8px">    
      ‚ùå Close    
    </button>    
  </div>    
</div>    
 <div class="modal" id="chargeInfoModal">    
  <div class="modal-content" style="max-width:400px; padding:20px; border-radius:12px; background:#000; color:#fff;">    
    <h3 style="margin-top:0; text-align:center;">Delivery Charge Info</h3>    
    <ul id="chargeList" style="list-style:none; padding:0; margin:10px 0;"></ul>    
    <button onclick="closeChargeModal()" style="    
      display:block;    
      margin:10px auto 0 auto;    
      padding:8px 16px;    
      border:none;    
      border-radius:8px;    
      background:#fff;    
      color:#000;    
      cursor:pointer;    
    ">Close</button>    
  </div>    
 </div>     
<script>    
const API = "https://shopbacked-vmhs.onrender.com";    
let selectedProduct = null;
let cart = [];
let cartDeliveryCharge = 0;
let currentWholesalerId = null;

  // DOM elements
const dImages = document.getElementById("dImages");
const dDots   = document.getElementById("dDots");
const LOCATION_EDIT_LIMIT = 10 * 60 * 60 * 1000; // 10 hours
const products = document.getElementById("products");
const detailModal = document.getElementById("detailModal");
const dName = document.getElementById("dName");
const dImg = document.getElementById("dImg");
const dDesc = document.getElementById("dDesc");
const dPrice = document.getElementById("dPrice");
const dDelivery = document.getElementById("dDelivery");
const dTotal = document.getElementById("dTotal");
const vehicleType = document.getElementById("vehicleType");
const cartModal = document.getElementById("cartModal");
const cartItems = document.getElementById("cartItems");
const cartSubtotal = document.getElementById("cartSubtotal");
const cartDelivery = document.getElementById("cartDelivery");
const cartGrandTotal = document.getElementById("cartGrandTotal");
const cartVehicle = document.getElementById("cartVehicle");
const profileModal = document.getElementById("profileModal");
const profileName = document.getElementById("profileName");
const profileMobile = document.getElementById("profileMobile");
const profileAddress = document.getElementById("profileAddress");
const orderStatusModal = document.getElementById("orderStatusModal");
const orderStatusData = document.getElementById("orderStatusData");
const deliveryModal = document.getElementById("deliveryModal");
const deliveryData = document.getElementById("deliveryData");
const deliveryDot = document.getElementById("deliveryDot");
const profileLocation = document.getElementById("profileLocation");
// Utility
function formatDT(d){ const dt=new Date(d); return dt.toLocaleDateString()+" "+dt.toLocaleTimeString(); }
// ================= LOCATION NORMALIZER =================
function normalizeLocation(loc) {
  if (!loc) return null;

  if (loc.lat && loc.lng) {
    return { lat: Number(loc.lat), lng: Number(loc.lng) };
  }

  if (loc.latitude && loc.longitude) {
    return { lat: Number(loc.latitude), lng: Number(loc.longitude) };
  }

  return null;
}

// ================= RETAILER LOCATION ENSURE =================
async function ensureRetailerLocation() {
  const profile = JSON.parse(localStorage.getItem("retailerProfile") || "{}");

  // ‚úÖ localStorage me already hai
  const loc = normalizeLocation(profile.location);
  if (loc) {
    localStorage.setItem("retailer_location", JSON.stringify(loc));
    return loc;
  }

  // üî• backend se laao
  const retailerId = localStorage.getItem("userId");
  if (!retailerId) return null;

  try {
    const res = await fetch(`${API}/api/retailers/profile/${retailerId}`);
    const data = await res.json();

    const serverLoc = normalizeLocation(data?.profile?.location);
    if (serverLoc) {
      localStorage.setItem("retailer_location", JSON.stringify(serverLoc));
      localStorage.setItem(
        "retailerProfile",
        JSON.stringify(data.profile)
      );
      return serverLoc;
    }
  } catch (e) {
    console.error("‚ùå ensureRetailerLocation failed", e);
  }

  return null;
  }
// ------------------- PRODUCTS -------------------
async function loadProducts() {
  const widInput = document.getElementById("wid");
  const wid = widInput.value.trim();

  if (!wid) {
    alert("Enter Wholesaler ID");
    return;
  }

  // Save last wholesaler
  sessionStorage.setItem("lastWid", wid);

  // Clear cart if wholesaler changed
  if (currentWholesalerId && currentWholesalerId !== wid) {
    clearCartCompletely();
  }

  currentWholesalerId = wid;

  try {
    const res = await fetch(`${API}/api/products/wholesaler/${wid}`);
    const data = await res.json();

    const categoriesContainer = document.getElementById("categories");

    if (!data.products || !data.products.length) {
      categoriesContainer.innerHTML = "<p>No categories found</p>";
      return;
    }

    // üî• Unique categories ‡§®‡§ø‡§ï‡§æ‡§≤‡•ã
    const categoryMap = {};
    data.products.forEach(p => {
      const cat = p.category || "Other";
      categoryMap[cat] = true;
    });

    // Render categories
    categoriesContainer.innerHTML = Object.keys(categoryMap)
      .map(cat => `
        <div class="category-card"
             onclick="openCategory('${encodeURIComponent(cat)}','${wid}')">
          <div class="category-icon">
            <i class="bi bi-box-seam"></i>
          </div>
          <div class="category-name">${cat}</div>
        </div>
      `)
      .join("");

    // Save categories for back navigation
    sessionStorage.setItem(
      "lastCategoriesHTML",
      categoriesContainer.innerHTML
    );

  } catch (e) {
    console.error(e);
    alert("Failed to load categories");
  }
}
window.addEventListener("load", () => {
  showRemainingTime();
  checkLocationLock();
});
/* ================= OPEN CATEGORY ================= */
function openCategory(categoryId, wid) {
  window.location.href =
    `categoryProducts.html?wid=${wid}&category=${categoryId}`;
}

function normalizeSetAt(setAt) {
  if (!setAt) return null;

  // already number (milliseconds)
  if (typeof setAt === "number" && !isNaN(setAt)) {
    return setAt;
  }

  // number as string
  if (typeof setAt === "string" && !isNaN(setAt)) {
    return Number(setAt);
  }

  // ISO date string
  const parsed = Date.parse(setAt);
  if (!isNaN(parsed)) {
    return parsed;
  }

  return null;
}

  let locationTimerInterval = null;

function updateLocationTimer(setAt, locked) {

  const timerEl = document.getElementById("locationTimer");
  if (!timerEl) return;

  const LIMIT = 10 * 60 * 60 * 1000; // 10 hours

  // ‚úÖ normalize date
  const normalizedSetAt = normalizeSetAt(setAt);

  if (!normalizedSetAt) {
    timerEl.innerText = "";
    return;
  }

  if (locationTimerInterval) {
    clearInterval(locationTimerInterval);
  }

  function tick() {
    const diff = (normalizedSetAt + LIMIT) - Date.now();

    if (diff <= 0 || locked === true) {

      timerEl.innerText =
        "üîí Location lock ho chuki hai. Correction ke liye admin se contact karein.";

      // üîí Disable set location button
      const btn = document.querySelector(
        "#profileModal .location-group button"
      );

      if (btn) {
        btn.disabled = true;
        btn.innerText = "üîí Location Locked";
        btn.style.background = "#9ca3af";
        btn.style.cursor = "not-allowed";
      }

      // üÜò SHOW ADMIN HELP
      const helpBtn = document.getElementById("adminHelpBtn");
      if (helpBtn) helpBtn.style.display = "block";

      clearInterval(locationTimerInterval);
      return;
    }

    const hrs  = Math.floor(diff / 3600000);
    const mins = Math.floor((diff % 3600000) / 60000);
    const secs = Math.floor((diff % 60000) / 1000);

    timerEl.innerText =
      `‚è≥ ${hrs}h ${mins}m ${secs}s remaining\n` +
      `Iske baad location lock ho jayegi.`;

    // ‚ùå hide admin help while time left
    const helpBtn = document.getElementById("adminHelpBtn");
    if (helpBtn) helpBtn.style.display = "none";
  }

  tick();
  locationTimerInterval = setInterval(tick, 1000);
}

  function contactAdminForLocation() {

  const retailerId = localStorage.getItem("userId");

  alert(
    "üì© Admin ko request bhej di gayi hai.\n" +
    "Retailer ID: " + retailerId + "\n" +
    "Admin aapse contact karega."
  );

  // OPTIONAL: API call yahan laga sakte ho
  }
/* ================= GET RETAILER LOCATION ================= */
async function getRetailerLocation() {

  if (!navigator.geolocation) {
    alert("Geolocation not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (pos) => {

      const location = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      };

      const res = await fetch(`${API}/api/retailers/location`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + TOKEN
        },
        body: JSON.stringify({ location })
      });

      const data = await res.json();

      if (!data.success) {
        alert(data.message || "Location update failed");
        return;
      }

      // ‚úÖ UI update
      profileLocation.value =
        location.lat.toFixed(6) + ", " +
        location.lng.toFixed(6);

      // ‚úÖ SERVER TIME se timer
      updateLocationTimer(
        data.location.setAt,
        data.location.locked
      );

      alert("üìç Location set successfully");
    },
    () => alert("Location denied"),
    { enableHighAccuracy: true }
  );
}

/* ================= PAGE BACK RESTORE ================= */
window.addEventListener("pageshow", function () {
  const wid = sessionStorage.getItem("lastWid");
  const catHTML = sessionStorage.getItem("lastCategoriesHTML");

  // Restore wid input
  if (wid) {
    document.getElementById("wid").value = wid;
  }

  // Restore categories (Back button case)
  if (catHTML) {
    document.getElementById("categories").innerHTML = catHTML;
    console.log("‚Ü©Ô∏è Categories restored from session");
  }
});

/* ================= DUMMY CART CLEAR ================= */
function clearCartCompletely() {
  console.log("üóëÔ∏è Cart cleared (Wholesaler changed)");
}
function saveCurrentLocation() {

  if (!navigator.geolocation) {
    alert("‚ùå Location support ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (pos) => {
      try {
        const location = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };

        // ‚úÖ LocalStorage save
        localStorage.setItem(
          "retailer_location",
          JSON.stringify(location)
        );

        // ‚úÖ Server save (ONLY location)
        await fetch(`${API}/api/retailers/location`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + TOKEN
          },
          body: JSON.stringify({
            retailerId: localStorage.getItem("userId"),
            location: location
          })
        });

        // ‚úÖ UI update
        const profileLocation = document.getElementById("profileLocation");
        if (profileLocation) {
          profileLocation.value =
            location.lat.toFixed(6) + ", " +
            location.lng.toFixed(6);
        }

        alert("üìç Location successfully save ho gayi");

      } catch (err) {
        console.error(err);
        alert("‚ùå Server par location save nahi hui");
      }
    },
    () => alert("‚ùå Location fetch nahi ho pa rahi"),
    {
      enableHighAccuracy: true,
      timeout: 10000
    }
  );
}

/* ================= CART DELIVERY UPDATE ================= */
function updateCartDelivery() {
  clearTimeout(cartTimer);
  cartTimer = setTimeout(calcCartDelivery, 400);
}

/* ================= PRODUCT DETAIL MODAL ================= */
function openDetail(p) {

  // üî• DEEP COPY (avoid stale data)
  selectedProduct = JSON.parse(JSON.stringify(p));

  if (!selectedProduct.wholesalerLocation) {
    console.warn("‚ö†Ô∏è Wholesaler location missing", selectedProduct);
  }

  document.getElementById("detailModal").style.display = "flex";

  /* ---------- BASIC DETAILS ---------- */
  dName.innerText  = selectedProduct.productName || "";
  dPrice.innerText = "Price ‚Çπ" + (selectedProduct.price || 0);

  /* ---------- DESCRIPTION ---------- */
  dDesc.innerText = selectedProduct.detail || "No description available";
  dDesc.classList.add("short");
  document.getElementById("descToggle").innerText = "More ‚¨á";

  /* ---------- DELIVERY RESET ---------- */
  document.getElementById("deliveryBox").style.display = "none";
  document.getElementById("deliveryText").innerText = "";
  document.getElementById("totalText").innerText = "";
  document.getElementById("vehicleType").value = "";

  /* ---------- MULTIPLE IMAGES ---------- */
  dImages.innerHTML = "";
  dDots.innerHTML   = "";

  const images =
    (selectedProduct.images && selectedProduct.images.length)
      ? selectedProduct.images
      : (selectedProduct.image ? [selectedProduct.image] : []);

  images.forEach((img, i) => {

    dImages.innerHTML += `
      <img
        src="${img}"
        onclick="openImage('${img}')"
        style="min-width:100%;object-fit:contain;cursor:zoom-in"
      >
    `;

    dDots.innerHTML += `
      <div class="dot ${i === 0 ? "active" : ""}"></div>
    `;
  });

  /* ---------- DOT ACTIVE ON SCROLL ---------- */
  dImages.onscroll = () => {
    const index = Math.round(
      dImages.scrollLeft / dImages.clientWidth
    );

    [...dDots.children].forEach((dot, i) => {
      dot.classList.toggle("active", i === index);
    });
  };

  /* ---------- DEBUG ---------- */
  console.log("üì¶ Product:", selectedProduct.productName);
  console.log("üè™ Wholesaler Loc:", selectedProduct.wholesalerLocation);
}
function showChargeInfo(orderAmount = 0) {
  const slabs = [
    { min: 100,  max: 500,  percent: 70 },
    { min: 501,  max: 3000, percent: 50 },
    { min: 3001, max: 5000, percent: 30 },
    { min: 5001, max: Infinity, percent: 0 } // Free delivery
  ];

  const list = document.getElementById("chargeList");
  list.innerHTML = "";

  slabs.forEach(slab => {
    const li = document.createElement("li");

    if (slab.percent === 0) {
      li.innerText = `‚Çπ${slab.min}+ ‡§ï‡§æ order ‚Üí Free Delivery ‚úÖ`;
    } else {
      li.innerText =
        `‚Çπ${slab.min} - ‚Çπ${slab.max} ‡§ï‡§æ order ‚Üí ${slab.percent}% delivery charge`;
    }

    // Highlight current slab
    if (orderAmount >= slab.min && orderAmount <= slab.max) {
      li.classList.add("highlight");
    }

    list.appendChild(li);
  });

  document.getElementById("chargeInfoModal").style.display = "flex";
}

function closeChargeModal() {
  document.getElementById("chargeInfoModal").style.display = "none";
}

/* ================= DELIVERY ESTIMATE (PRODUCT PAGE) ================= */
async function fetchDeliveryEstimate(orderAmount, vehicleType) {
  try {
    const retailerLoc = JSON.parse(
      localStorage.getItem("retailer_location")
    );

    const wholesalerLoc = selectedProduct?.wholesalerLocation;

    if (!retailerLoc || !wholesalerLoc) {
      console.warn("‚ö†Ô∏è Location missing", {
        retailerLoc,
        wholesalerLoc
      });
      return null;
    }

    const res = await fetch(`${API}/api/delivery/calculate`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        orderAmount,
        vehicleType,
        retailerLocation: retailerLoc,
        wholesalerLocation: wholesalerLoc
      })
    });

    return await res.json();

  } catch (err) {
    console.error("‚ùå Delivery estimate failed", err);
    return null;
  }
}

/* ================= IMAGE MODAL ================= */
function openImage(src) {
  document.getElementById("fullImg").src = src;
  document.getElementById("imageModal").style.display = "flex";
}

function closeImage() {
  document.getElementById("imageModal").style.display = "none";
}

/* ================= DESCRIPTION TOGGLE ================= */
function toggleDesc() {
  const desc = document.getElementById("dDesc");
  const toggle = document.getElementById("descToggle");

  if (desc.classList.contains("short")) {
    desc.classList.remove("short");
    toggle.innerText = "Less ‚¨Ü";
  } else {
    desc.classList.add("short");
    toggle.innerText = "More ‚¨á";
  }
}

/* ================= DELIVERY ESTIMATE (CART PAGE) ================= */
async function getDeliveryFromServer({ orderAmount, vehicleType }) {
  try {
    const retailerLoc = JSON.parse(
      localStorage.getItem("retailer_location")
    );

    if (!retailerLoc) {
      throw new Error("Retailer location missing");
    }

    // Cart ke first product se wholesaler location
    const wholesalerLoc = cart?.[0]?.wholesalerLocation;

    if (!wholesalerLoc) {
      throw new Error("Wholesaler location missing");
    }

    const res = await fetch(`${API}/api/delivery/calculate`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        orderAmount,
        vehicleType,
        retailerLocation: retailerLoc,
        wholesalerLocation: wholesalerLoc
      })
    });

    return await res.json();

  } catch (err) {
    console.error("‚ùå Cart delivery calculation failed", err);
    return null;
  }
}
async function directBuy(e) {
  e.preventDefault();

  /* ================= VEHICLE CHECK ================= */
  if (!vehicleType.value) {
    alert("üöö Select vehicle first");
    return;
  }

  /* ================= RETAILER PROFILE CHECK ================= */
  const retailerProfile = JSON.parse(
    localStorage.getItem("retailerProfile") || "{}"
  );

  if (!retailerProfile.mobile) {
    alert("üë§ Please save profile first");
    return;
  }

  /* ================= LOCATION CHECK ================= */
  const retailerLoc = JSON.parse(
    localStorage.getItem("retailer_location")
  );
  const wholesalerLoc = selectedProduct?.wholesalerLocation;

  if (!retailerLoc || !wholesalerLoc) {
    alert("üìç Location missing");
    return;
  }

  try {
    /* ================= DELIVERY CALCULATION ================= */
    const deliveryRes = await fetch(
      `${API}/api/delivery/calculate`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          orderAmount: selectedProduct.price,
          vehicleType: vehicleType.value,
          retailerLocation: retailerLoc,
          wholesalerLocation: wholesalerLoc
        })
      }
    );

    const deliveryData = await deliveryRes.json();

    if (!deliveryData.success) {
      alert(
        deliveryData.message || "Delivery calculation failed"
      );
      return;
    }

    /* ================= UI UPDATE ================= */
    dDelivery.innerText =
      `Delivery ‚Çπ${deliveryData.retailerPays} ` +
      `(${deliveryData.retailerPercent}% retailer)`;

    const totalAmount =
      selectedProduct.price + deliveryData.retailerPays;

    dTotal.innerText = `Total ‚Çπ${totalAmount}`;

    /* ================= CREATE ORDER ================= */
    const res = await fetch(
      `${API}/api/orders/pay-and-create`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount: totalAmount,
          notes: {
            type: "direct", // üî• IMPORTANT

            productId: selectedProduct._id,
            productName: selectedProduct.productName,
            price: selectedProduct.price,

            wholesalerId: selectedProduct.wholesalerId,
            wholesalerName: selectedProduct.shopName,
            wholesalerMobile: selectedProduct.mobile,
            wholesalerAddress: selectedProduct.address,

            retailerName: retailerProfile.name,
            retailerMobile: retailerProfile.mobile,
            retailerAddress: retailerProfile.address,

            vehicleType: vehicleType.value,

            // ‚úÖ DELIVERY BREAKUP
            deliveryCharge: deliveryData.totalDelivery,
            retailerDeliveryPay: deliveryData.retailerPays,
            wholesalerDeliveryPay: deliveryData.wholesalerPays,
            distanceKm: deliveryData.distanceKm
          }
        })
      }
    );

    const data = await res.json();

    if (!data.success) {
      alert("‚ùå Order create failed");
      return;
    }

    /* ================= RAZORPAY ================= */
    const rzp = new Razorpay({
      key: data.key,
      amount: data.amount,
      currency: "INR",
      order_id: data.order.id,

      handler: function () {
        alert("‚úÖ Payment Successful üéâ");
        alert("üì¶ Order processing ho raha hai");

        closeAll();
        setTimeout(openOrderStatus, 3000);
      },

      modal: {
        ondismiss: function () {
          alert("‚ùå Payment cancelled");
        }
      }
    });

    rzp.open();

  } catch (err) {
    console.error(err);
    alert("‚ùå Something went wrong");
  }
}
// ------------------- DELIVERY UPDATE ON VEHICLE SELECT -------------------
async function updateDelivery() {
  if (!selectedProduct) return; // safety

  const vehicle = vehicleType.value;

  if (!vehicle) {
    dDelivery.innerText = "";
    dTotal.innerText = "";
    return;
  }

  /* ---------- RETAILER LOCATION ---------- */
  const retailerLoc = JSON.parse(
    localStorage.getItem("retailer_location")
  );

  const wholesalerLoc = selectedProduct?.wholesalerLocation;

  if (!retailerLoc || !wholesalerLoc) {
    dDelivery.innerText = "üìç Location missing";
    dTotal.innerText = "";
    return;
  }

  try {
    const res = await fetch(
      `${API}/api/delivery/calculate`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          orderAmount: selectedProduct.price,
          vehicleType: vehicle,
          retailerLocation: retailerLoc,
          wholesalerLocation: wholesalerLoc
        })
      }
    );

    const data = await res.json();

    if (!data.success) {
      dDelivery.innerText = "‚ö†Ô∏è Delivery calculation failed";
      dTotal.innerText = "";
      return;
    }

    /* ---------- UI UPDATE ---------- */
    dDelivery.innerText =
      `Delivery ‚Çπ${data.retailerPays} ` +
      `(${data.retailerPercent}% retailer)`;

    const total =
      selectedProduct.price + data.retailerPays;

    dTotal.innerText = `Total ‚Çπ${total}`;

  } catch (err) {
    console.error("‚ùå Delivery fetch error:", err);
    dDelivery.innerText = "‚ö†Ô∏è Delivery fetch error";
    dTotal.innerText = "";
  }
}

/* ================= CART DELIVERY ================= */
let cartTimer = null;

async function calcCartDelivery() {

  const vehicle =
    document.getElementById("cartVehicle").value;

  const box =
    document.getElementById("cartDeliveryBox");

  const dText =
    document.getElementById("cartDeliveryText");

  const tText =
    document.getElementById("cartTotalText");

  if (!vehicle || !cart.length) {
    box.style.display = "none";
    dText.innerText = "";
    tText.innerText = "";
    window.__cartDelivery = null;
    return;
  }

  /* ---------- SUBTOTAL ---------- */
  const subtotal = cart.reduce(
    (sum, item) =>
      sum + (Number(item.price) * Number(item.quantity || 1)),
    0
  );

  /* ---------- RETAILER LOCATION ---------- */
  let retailerLoc =
    JSON.parse(localStorage.getItem("retailer_location")) ||
    JSON.parse(localStorage.getItem("retailerProfile") || "{}")?.location ||
    null;

  if (retailerLoc?.latitude && retailerLoc?.longitude) {
    retailerLoc = {
      lat: retailerLoc.latitude,
      lng: retailerLoc.longitude
    };
  }

  /* ---------- WHOLESALER LOCATION ---------- */
  let wholesalerLoc = null;

  try {
    const wid = cart[0].wholesalerId;

    const resWh = await fetch(
      `${API}/api/wholesalers/profile/${wid}`
    );

    const whData = await resWh.json();

    wholesalerLoc =
      whData?.profile?.location ||
      whData?.wholesaler?.location ||
      whData?.location ||
      null;

    if (wholesalerLoc?.latitude && wholesalerLoc?.longitude) {
      wholesalerLoc = {
        lat: wholesalerLoc.latitude,
        lng: wholesalerLoc.longitude
      };
    }

  } catch (err) {
    console.error("‚ùå Wholesaler location fetch failed", err);
  }

  /* ---------- LOCATION CHECK ---------- */
  if (
    !retailerLoc?.lat ||
    !retailerLoc?.lng ||
    !wholesalerLoc?.lat ||
    !wholesalerLoc?.lng
  ) {
    box.style.display = "block";
    dText.innerText = "üìç Location missing";
    tText.innerText = "";
    return;
  }

  /* ---------- DELIVERY FROM BACKEND ---------- */
  try {
    const res = await fetch(
      `${API}/api/delivery/calculate`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          orderAmount: subtotal,
          vehicleType: vehicle,
          retailerLocation: retailerLoc,
          wholesalerLocation: wholesalerLoc
        })
      }
    );

    const data = await res.json();

    if (!data.success) {
      box.style.display = "block";
      dText.innerText = "‚ö†Ô∏è Delivery calculation failed";
      tText.innerText = "";
      return;
    }

    

/* üîÅ DOUBLE distance & time */    
const doubleDistance = (Number(data.distanceKm) * 2).toFixed(2);    
const doubleTime = Math.round(Number(data.timeMinutes) * 2);    
const total = subtotal + Number(data.retailerPays);    

/* ================= UI UPDATE ================= */    
box.style.display = "block";

dText.innerText =
  `üöö Delivery ‚Çπ${data.totalDelivery} ` +
  `(Retailer Pays ‚Çπ${data.retailerPays}, ${data.retailerPercent}%)\n` +
  `‚è±Ô∏è ${doubleTime} min\n` +
  `üìç ‡§ü‡•ã‡§ü‡§≤ ‡§Ü‡§®‡•á-‡§ú‡§æ‡§®‡•á ‡§ï‡§æ = ${doubleDistance} km`;

tText.innerText = `üí∞ Total ‚Çπ${total}`;

/* ================= STORE FOR PAYMENT ================= */
window.__cartDelivery = {
  subtotal,
  retailerPays: Number(data.retailerPays),
  wholesalerPays: Number(data.wholesalerPays || 0),
  total,
  distanceKm: doubleDistance,
  timeMinutes: doubleTime
};

} catch (err) {
  console.error("Cart delivery error", err);
  box.style.display = "block";
  dText.innerText = "‚ö†Ô∏è Server error";
  tText.innerText = "";
}
}


/* ================= ADD TO CART ================= */
async function addToCart(p) {
  const retailerId = localStorage.getItem("userId");

  if (!retailerId) {
    alert("üîê Please login first");
    return;
  }

  try {
    const res = await fetch(`${API}/api/cart/save`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        retailerId,
        item: {
          productId: p._id,
          productName: p.productName,
          price: p.price,
          image: p.images?.[0] || "",
          wholesalerId: p.wholesalerId,
          shopName: p.shopName,
          mobile: p.mobile,
          address: p.address
        }
      })
    });

    const data = await res.json();

    /* ‚ùå DIFFERENT WHOLESALER FOUND */
    if (
      !data.success &&
      data.message &&
      data.message.includes("Only one wholesaler")
    ) {
      // Backend cart clear
      await fetch(`${API}/api/cart/clear/${retailerId}`, {
        method: "DELETE"
      });

      // Frontend cart clear
      cart = [];
      localStorage.removeItem("cart");
      currentWholesalerId = null;

      alert(
        "üßπ ‡§™‡•Å‡§∞‡§æ‡§®‡§æ cart clear ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à.\n‡§Ö‡§¨ ‡§®‡§Ø‡§æ product add ho raha hai."
      );

      // Re-add product
      addToCart(p);
      return;
    }

    if (data.success) {
      cart.push(p);
      currentWholesalerId = p.wholesalerId;
      localStorage.setItem("cart", JSON.stringify(cart));

      alert(
        "üõí Added to cart successfully ‚úÖ\n\n" +
        "Product: " + p.productName +
        "\nPrice: ‚Çπ" + p.price
      );
    } else {
      alert("‚ùå Failed to add item");
    }

  } catch (err) {
    console.error(err);
    alert("‚ùå Server error");
  }
}


async function loadCart() {

  const retailerId = localStorage.getItem("userId");
  const cartDiv = document.getElementById("cartItems");

  /* ---------- LOGIN CHECK ---------- */
  if (!retailerId) {
    cartDiv.innerHTML =
      "<p style='text-align:center'>üîê Please login</p>";
    cart = [];
    return;
  }

  try {
    /* ---------- FETCH CART ---------- */
    const res = await fetch(`${API}/api/cart/${retailerId}`);
    const data = await res.json();

    if (!data.items || !data.items.length) {
      cartDiv.innerHTML =
        "<p style='text-align:center'>üõí Cart is empty</p>";
      cart = [];
      return;
    }

    /* ---------- CURRENT WHOLESALER FILTER ---------- */
    const currentWholesalerId =
      new URLSearchParams(window.location.search).get("wid") ||
      localStorage.getItem("currentWholesalerId");

    const filteredItems = currentWholesalerId
      ? data.items.filter(
          item => item.wholesalerId === currentWholesalerId
        )
      : data.items;

    if (!filteredItems.length) {
      cartDiv.innerHTML =
        "<p style='text-align:center'>üõí Is wholesaler ka cart empty hai</p>";
      cart = [];
      return;
    }

    /* ---------- RENDER CART ---------- */
    cartDiv.innerHTML = filteredItems.map(item => `
      <div class="cart-card"
           style="display:flex;gap:10px;align-items:center;
                  padding:8px;border-bottom:1px solid #eee">

        <img src="${item.image || ''}"
             class="cart-img"
             style="width:60px;height:60px;object-fit:contain;
                    border-radius:8px;background:#f8fafc">

        <div class="cart-info" style="flex:1">
          <div class="cart-name" style="font-weight:600">
            ${item.productName}
          </div>

          <div class="cart-price"
               style="font-size:14px;color:#334155">
            ‚Çπ${item.price} √ó ${item.quantity || 1} =
            <b>‚Çπ${Number(item.price) * Number(item.quantity || 1)}</b>
          </div>
        </div>

        <div class="cart-actions">
          <button
            onclick="removeFromCart('${item.productId}')"
            style="border:none;background:#fee2e2;color:#991b1b;
                   border-radius:6px;padding:4px 8px;cursor:pointer">
            ‚ùå
          </button>
        </div>

      </div>
    `).join("");

    /* ---------- LOCAL CART SYNC (IMPORTANT) ---------- */
    cart = filteredItems.map(item => ({
      ...item,
      quantity: Number(item.quantity || 1),
      price: Number(item.price)
    }));

    /* ---------- DELIVERY RECALC ---------- */
    calcCartDelivery();

  } catch (err) {
    console.error("‚ùå loadCart error", err);
    cartDiv.innerHTML =
      "<p style='text-align:center'>‚ö†Ô∏è Cart load failed</p>";
    cart = [];
  }
}
/* ================= OPEN CART ================= */
function openCart() {
  const modal = document.getElementById("cartModal");
  if (modal) modal.style.display = "flex";
  loadCart(); // ‚úÖ yahin se cart load hoga
}


/* ================= REMOVE (LOCAL ‚Äì OPTIONAL) ================= */
/* ‚ö†Ô∏è Agar backend cart use ho raha hai to isko use na karein */
async function removeCart(index) {
  cart.splice(index, 1);

  try {
    await fetch(`${API}/api/cart/save`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        retailerId: localStorage.getItem("userId"),
        items: cart
      })
    });

    localStorage.setItem("cart", JSON.stringify(cart));
    loadCart();

  } catch (e) {
    alert("‚ùå Failed to remove item");
  }
}


/* ================= REMOVE FROM CART (BACKEND) ================= */
async function removeFromCart(productId) {
  const retailerId = localStorage.getItem("userId");
  if (!retailerId) return;

  try {
    const res = await fetch(`${API}/api/cart/remove`, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ retailerId, productId })
    });

    const data = await res.json();

    if (data.success) {
      loadCart(); // üîÑ refresh
    } else {
      alert(data.message || "‚ùå Failed to remove item");
    }

  } catch (err) {
    console.error("REMOVE CART ERROR:", err);
    alert("‚ùå Server error");
  }
}


/* ================= PAY CART ================= */
async function payCart() {

  const vehicle = cartVehicle?.value;
  if (!vehicle) {
    alert("üöö Select vehicle first");
    return;
  }

  const profile =
    JSON.parse(localStorage.getItem("retailerProfile") || "{}");

  if (!profile.mobile) {
    alert("üë§ Save profile first");
    return;
  }

  if (!cart || cart.length === 0) {
    alert("üõí Cart empty");
    return;
  }

  /* ‚úÖ DELIVERY DATA REQUIRED */
  if (!window.__cartDelivery) {
    alert("‚ùå Delivery calculation missing");
    return;
  }

  const {
    subtotal,
    retailerPays,
    wholesalerPays,
    total,
    distanceKm,
    timeMinutes
  } = window.__cartDelivery;

  try {
    /* ================= CREATE ORDER ================= */
    const res = await fetch(`${API}/api/orders/pay-and-create`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        amount: total, // ‚úÖ FINAL TOTAL
        notes: {
          type: "cart",

          retailerName: profile.name,
          retailerMobile: profile.mobile,

          vehicleType: vehicle,

          /* üöö DELIVERY BREAKUP */
          deliveryCharge: retailerPays + wholesalerPays,
          retailerDeliveryPay: retailerPays,
          wholesalerDeliveryPay: wholesalerPays,
          distanceKm,
          timeMinutes,

          products: JSON.stringify(
            cart.map(p => ({
              productId: p.productId || p._id,
              productName: p.productName,
              price: p.price,
              quantity: p.quantity || 1,

              wholesalerId: p.wholesalerId,
              wholesalerName: p.shopName,
              wholesalerMobile: p.mobile
            }))
          )
        }
      })
    });

    const data = await res.json();
    if (!data.success) {
      alert(data.message || "‚ùå Payment init failed");
      return;
    }

    /* ================= RAZORPAY ================= */
    const rzp = new Razorpay({
      key: data.key,
      amount: data.amount,
      currency: "INR",
      order_id: data.order.id,

      handler: function () {
        localStorage.removeItem("cart");
        cart = [];
        window.__cartDelivery = null;

        alert("‚úÖ Payment Successful üéâ");
        closeAll();
        setTimeout(openOrderStatus, 2000);
      },

      modal: {
        ondismiss: function () {
          alert("‚ùå Payment cancelled");
        }
      }
    });

    rzp.open();

  } catch (err) {
    console.error("CART PAYMENT ERROR:", err);
    alert("‚ùå Payment error");
  }
}
/* ================= CLEAR CART COMPLETELY ================= */
function clearCartCompletely() {

  // üßπ Frontend cart clear
  cart = [];
  localStorage.removeItem("cart");

  // üßπ Backend cart clear
  const retailerId = localStorage.getItem("userId");
  if (retailerId) {
    fetch(`${API}/api/cart/clear`, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ retailerId })
    }).catch(err =>
      console.error("Backend cart clear failed", err)
    );
  }

  // üñ•Ô∏è UI reset
  const cartBox = document.getElementById("cartItems");
  if (cartBox) {
    cartBox.innerHTML =
      "<p style='text-align:center'>üõí Cart empty hai</p>";
  }

  const deliveryBox = document.getElementById("cartDeliveryBox");
  if (deliveryBox) deliveryBox.style.display = "none";

  window.__cartDelivery = null;
}


/* ================= DELIVERY DETAILS ================= */
async function openDeliveryDetails() {

  deliveryModal.style.display = "flex";

  const profile =
    JSON.parse(localStorage.getItem("retailerProfile") || "{}");

  if (!profile.mobile) {
    deliveryData.innerHTML = "‚ö†Ô∏è Profile not found";
    return;
  }

  try {
    const res = await fetch(
      `${API}/api/orders/retailer/${profile.mobile}`
    );
    const data = await res.json();

    const visibleOrders = (data.orders || []).filter(o =>
      o.status === "delivery_code_generated" ||
      o.status === "delivered"
    );

    if (!visibleOrders.length) {
      deliveryData.innerHTML =
        "<p style='text-align:center;color:#666'>No delivery details yet</p>";
      return;
    }

    deliveryData.innerHTML = visibleOrders.map(o => {

      const lastStatusTime =
        o.statusHistory?.length
          ? o.statusHistory[o.statusHistory.length - 1].time
          : o.createdAt;

      const d = new Date(lastStatusTime);

      return `
        <div class="delivery-card">

          <div class="delivery-row">
            <span class="delivery-label">üì¶ Product</span>
            <span class="delivery-value">${o.productName || "-"}</span>
          </div>

          <div class="delivery-row">
            <span class="delivery-label">üë§ Delivery Boy</span>
            <span class="delivery-value">
              ${o.deliveryBoyName || "Assigned"}
            </span>
          </div>

          <div class="delivery-row">
            <span class="delivery-label">üïí Time</span>
            <span class="delivery-value">
              ${d.toLocaleDateString("en-IN")}
              ${d.toLocaleTimeString("en-IN")}
            </span>
          </div>

          <div class="delivery-code">
            ${
              o.deliveryCode
                ? `üîê Delivery Code : ${o.deliveryCode}`
                : "‚è≥ Waiting for code..."
            }
          </div>

        </div>
      `;
    }).join("");

  } catch (err) {
    console.error("Delivery details error", err);
    deliveryData.innerHTML = "‚ùå Failed to load delivery details";
  }
}


/* ================= ORDER STATUS ================= */
async function openOrderStatus() {

  orderStatusModal.style.display = "flex";

  const profile =
    JSON.parse(localStorage.getItem("retailerProfile") || "{}");

  if (!profile.mobile) {
    orderStatusData.innerHTML = "‚ö†Ô∏è Profile not found";
    return;
  }

  try {
    const res = await fetch(
      `${API}/api/orders/retailer/${profile.mobile}`
    );
    const data = await res.json();

    if (!data.orders || !data.orders.length) {
      orderStatusData.innerHTML =
        "<p style='text-align:center;color:#666'>No orders found</p>";
      return;
    }

    orderStatusData.innerHTML = data.orders.map(o => {

      const d = new Date(o.updatedAt || o.createdAt);

      let cls = "status-pending";
      if (o.status.includes("confirmed")) cls = "status-confirmed";
      else if (o.status.includes("delivery")) cls = "status-delivery";
      else if (o.status === "delivered") cls = "status-delivered";

      return `
        <div class="status-card">
          <div class="status-product">${o.productName || "-"}</div>
          <div class="status-badge ${cls}">
            ${o.status.replaceAll("_", " ").toUpperCase()}
          </div>
          <div class="status-time">
            üïí ${d.toLocaleDateString("en-IN")}
            ${d.toLocaleTimeString("en-IN")}
          </div>
        </div>
      `;
    }).join("");

  } catch (err) {
    console.error("Order status error", err);
    orderStatusData.innerHTML = "‚ùå Failed to load orders";
  }
}

// ------------------- PROFILE -------------------
/* PROFILE */
function handleLocationTimerFromServer(profile) {
  const loc = profile?.location;
  if (!loc || !loc.setAt) return;

  updateLocationTimer(loc.setAt, loc.locked);
    }
/* ================= OPEN RETAILER PROFILE ================= */
async function openRetailerProfile() {

  profileModal.style.display = "flex";

  const retailerId = localStorage.getItem("userId");
  if (!retailerId) {
    alert("üîê Login required");
    return;
  }

  try {
    const res = await fetch(
      `${API}/api/retailers/profile/${retailerId}`
    );

    const data = await res.json();

    if (data.success && data.profile) {

      /* ===== BASIC PROFILE ===== */
      profileName.value   = data.profile.name || "";
      profileMobile.value = data.profile.mobile || "";

      /* ===== LOCATION (ONLY SERVER DATA) ===== */
      if (
        data.profile.location?.lat &&
        data.profile.location?.lng
      ) {
        profileLocation.value =
          Number(data.profile.location.lat).toFixed(6) + ", " +
          Number(data.profile.location.lng).toFixed(6);
      } else {
        profileLocation.value = "";
      }

      /* ===== LOCATION TIMER (ONLY SERVER BASED) ===== */
      if (data.profile?.locationMeta?.firstSetAt) {
        updateLocationTimer(
          data.profile.locationMeta.firstSetAt,
          data.profile.locationMeta.locked
        );
      } else {
        const timerEl = document.getElementById("locationTimer");
        if (timerEl) timerEl.innerText = "";
      }

      /* ===== UI CACHE (OPTIONAL) ===== */
      localStorage.setItem(
        "retailerProfile",
        JSON.stringify(data.profile)
      );

    } else {
      profileName.value = "";
      profileMobile.value = "";
      profileLocation.value = "";

      const timerEl = document.getElementById("locationTimer");
      if (timerEl) timerEl.innerText = "";
    }

  } catch (err) {
    console.error("REAL ERROR üëâ", err);
    alert("‚ùå Server error");
  }
}

/* ================= SAVE PROFILE ================= */
async function saveProfile() {

  if (!profileMobile.value.trim()) {
    alert("üì± Mobile required");
    return;
  }

  const retailerProfile =
    JSON.parse(localStorage.getItem("retailerProfile") || "{}");

  const locationMeta = retailerProfile.locationMeta || {};
  const isLocationLocked = locationMeta.locked === true;

  let location = null;

  // ‚úÖ LOCATION TABHI BHEJO JAB LOCK NA HO
  if (!isLocationLocked) {

    const locLS = localStorage.getItem("retailer_location");

    if (locLS) {
      const loc = JSON.parse(locLS);

      if (!isNaN(loc.lat) && !isNaN(loc.lng)) {
        location = {
          lat: Number(loc.lat),
          lng: Number(loc.lng)
        };
      }
    }
  }
  // üîí locked hai ‚Üí location = null (send hi nahi hogi)

  const payload = {
    retailerId: localStorage.getItem("userId"),
    name: profileName.value.trim(),
    mobile: profileMobile.value.trim()
  };

  // ‚ùó location sirf tab add karo jab allowed ho
  if (location) {
    payload.location = location;
  }

  sendProfile(payload);
}
// ‚úÖ Helper function to send profile to server
/* ================= SEND / SAVE PROFILE ================= */
async function sendProfile(payload) {
  try {
    const res = await fetch(`${API}/api/retailers/saveProfile`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.success) {

      // ‚úÖ Always update profile cache
      localStorage.setItem(
        "retailerProfile",
        JSON.stringify(data.profile)
      );

      /* ================= LOCATION FIX ================= */
      const locationUpdated = localStorage.getItem("location_updated");

      if (locationUpdated === "yes") {
        // ‚úÖ User set new location ‚Üí keep local
        console.log("üìç New location preserved (local)");
      } else {
        // ‚úÖ User didn't set new location ‚Üí use server
        if (data.profile.location?.lat && data.profile.location?.lng) {
          localStorage.setItem(
            "retailer_location",
            JSON.stringify({
              lat: Number(data.profile.location.lat),
              lng: Number(data.profile.location.lng)
            })
          );
        } else {
          localStorage.removeItem("retailer_location");
        }
      }

      // ‚úÖ Clear flag
      localStorage.removeItem("location_updated");

      alert("‚úÖ Profile save ho gaya");
      closeAll();

    } else {
      alert(data.message || "‚ùå Save failed");
    }

  } catch (err) {
    console.error("SaveProfile Error:", err);
    alert("‚ùå Server error");
  }
}


/* ================= DELIVERY NOTIFY DOT ================= */
setInterval(async () => {
  const profile = JSON.parse(localStorage.getItem("retailerProfile") || "{}");
  if (!profile.mobile) return;

  try {
    const res = await fetch(`${API}/api/orders/retailer/${profile.mobile}`);
    const data = await res.json();

    if (deliveryDot) {
      deliveryDot.style.display = 
        (data.orders || []).some(o => o.deliveryBoyName) ? "block" : "none";
    }

  } catch (err) {
    console.error("Delivery notify error:", err);
  }

}, 8000);


/* ================= CLOSE ALL MODALS ================= */
function closeAll() {
  document.querySelectorAll(".modal").forEach(m => {
    m.style.display = "none";
  });
}
window.addEventListener("load", ensureRetailerLocation);
</script>

</body>    
</html>
