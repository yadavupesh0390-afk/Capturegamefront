<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Retailer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:20px}

.icon-bar{
 display:flex;gap:20px;justify-content:center;
 background:#064e3b;padding:12px;border-radius:14px;
 max-width:650px;margin:auto
}
.icon-btn{
 background:#16a34a;color:#fff;border:none;
 width:55px;height:55px;border-radius:50%;
 font-size:22px;cursor:pointer;position:relative
}
.notify-dot{
 position:absolute;top:8px;right:8px;
 width:10px;height:10px;border-radius:50%;
 background:red;display:none
}

.header{
 margin-top:15px;background:#fff;padding:15px;
 border-radius:12px;text-align:center;
 box-shadow:0 5px 15px rgba(0,0,0,.08)
}

.order-card{
 background:#fff;padding:12px;margin-bottom:10px;
 border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)
}

.badge{
 padding:4px 10px;border-radius:20px;
 font-size:12px;background:#e0f2fe;color:#075985
}

.modal{
 position:fixed;inset:0;background:rgba(0,0,0,.5);
 display:none;align-items:center;justify-content:center;z-index:20
}
.modal-content{
 background:#fff;padding:20px;width:90%;
 max-width:500px;border-radius:15px;
 max-height:85vh;overflow:auto
}
button.primary{
 background:#16a34a;color:#fff;border:none;
 padding:10px 15px;border-radius:10px;cursor:pointer
}
</style>
</head>

<body>

<div class="main">

<!-- ICON BAR -->
<div class="icon-bar">
 <button class="icon-btn" onclick="openOrders()">
  <i class="bi bi-bag-check"></i>
 </button>

 <button class="icon-btn" onclick="openDeliveryInfo()">
  <i class="bi bi-truck"></i>
  <span id="deliveryDot" class="notify-dot"></span>
 </button>
</div>

<div class="header">
 <h3>ğŸ›’ Retailer Dashboard</h3>
</div>

</div>

<!-- ORDERS MODAL -->
<div class="modal" id="ordersModal">
 <div class="modal-content">
  <h3>ğŸ“œ My Orders</h3>
  <div id="myOrders"></div>
  <button onclick="closeAll()">Close</button>
 </div>
</div>

<!-- DELIVERY MODAL -->
<div class="modal" id="deliveryModal">
 <div class="modal-content">
  <h3>ğŸšš Delivery Status</h3>
  <div id="deliveryList"></div>
  <button class="primary" onclick="closeAll()">Close</button>
 </div>
</div>

<script>
const API="https://shopbacked-vmhs.onrender.com";
const TOKEN=localStorage.getItem("token");
const ROLE=localStorage.getItem("role");

if(!TOKEN||ROLE!=="retailer"){
 alert("Login as Retailer");
 location.href="index.html";
}

/* OPEN ORDERS */
async function openOrders(){
 ordersModal.style.display="flex";
 const mobile=localStorage.getItem("retailerMobile");
 if(!mobile) return alert("Retailer mobile missing");

 const res=await fetch(`${API}/api/orders/retailer/${mobile}`);
 const data=await res.json();

 myOrders.innerHTML=data.orders.map(o=>`
  <div class="order-card">
   <b>${o.productName}</b> â‚¹${o.price}<br>
   <span class="badge">${o.status}</span>
  </div>
 `).join("") || "No orders";
}

/* DELIVERY INFO (FINAL) */
async function openDeliveryInfo(){
 const mobile=localStorage.getItem("retailerMobile");
 if(!mobile) return alert("Retailer mobile missing");

 const res=await fetch(`${API}/api/orders/retailer/${mobile}`);
 const data=await res.json();

 const deliveryOrders=data.orders.filter(o=>o.deliveryBoyName);

 if(!deliveryOrders.length){
  alert("No delivery assigned yet");
  return;
 }

 deliveryList.innerHTML=deliveryOrders.map(o=>`
  <div class="order-card">
   <b>${o.productName}</b> â‚¹${o.price}<br>
   <span class="badge">${o.status}</span><br><br>

   ğŸšš <b>${o.deliveryBoyName}</b><br>
   ğŸ“ ${o.deliveryBoyMobile || "N/A"}<br>

   <hr>

   ${
    o.deliveryCode
    ? `
      ğŸ” <b>Delivery Code:</b> ${o.deliveryCode}<br>
      ğŸ•’ ${new Date(o.deliveryCodeTime).toLocaleString()}
    `
    : `<i>Waiting for delivery code...</i>`
   }
  </div>
 `).join("");

 deliveryDot.style.display="none";
 deliveryModal.style.display="flex";
}

/* ğŸ”” DELIVERY NOTIFICATION */
async function checkDeliveryNotify(){
 const mobile=localStorage.getItem("retailerMobile");
 if(!mobile) return;

 const res=await fetch(`${API}/api/orders/retailer/${mobile}`);
 const data=await res.json();

 const hasCode=data.orders.some(o=>o.deliveryCode);
 deliveryDot.style.display=hasCode?"block":"none";
}

setInterval(checkDeliveryNotify,8000);

/* CLOSE MODALS */
function closeAll(){
 document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
}
</script>

</body>
</html>
