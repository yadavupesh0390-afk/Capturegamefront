<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Retailer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:20px}
.icon-bar{display:flex;gap:20px;justify-content:center;background:#064e3b;padding:12px;border-radius:14px;max-width:700px;margin:auto}
.icon-btn{background:#16a34a;color:#fff;border:none;width:55px;height:55px;border-radius:50%;font-size:22px;cursor:pointer;position:relative}
.notify-dot{position:absolute;top:8px;right:8px;width:10px;height:10px;border-radius:50%;background:red;display:none}
.header{margin-top:15px;background:#fff;padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.08)}
.products-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px}
.product-card{background:#fff;padding:8px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.product-card img{width:100%;height:90px;object-fit:cover;border-radius:8px}
.price{color:#16a34a;font-weight:600;font-size:13px}
.actions{display:flex;gap:5px;margin-top:6px}
.actions button{flex:1;border:none;border-radius:8px;padding:6px;font-size:12px;cursor:pointer}
.cart-btn{background:#e5fbe9}
.buy-btn{background:#fee2e2}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
.modal-content{background:#fff;padding:20px;width:90%;max-width:500px;border-radius:15px;max-height:85vh;overflow:auto}
input,select,textarea{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc}
button.primary{background:#16a34a;color:#fff;border:none;padding:10px;border-radius:10px;cursor:pointer;width:100%}
.cart-item{border-bottom:1px solid #ddd;padding:8px 0}
.order-card{background:#fff;padding:12px;margin-bottom:10px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.badge{background:#e0f2fe;padding:4px 10px;border-radius:20px;font-size:12px}
.small{font-size:12px;color:#555}
.delivery-card{
  background:#f8fafc;
  border-left:5px solid #16a34a;
  padding:14px;
  border-radius:12px;
  margin-bottom:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}

.delivery-row{
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin:4px 0;
}

.delivery-label{
  color:#555;
}

.delivery-value{
  font-weight:600;
  color:#111;
}

.delivery-code{
  background:#dcfce7;
  color:#166534;
  padding:4px 10px;
  border-radius:20px;
  font-weight:600;
  display:inline-block;
  margin-top:6px;
}

.status-card{
  background:#ffffff;
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 6px 14px rgba(0,0,0,.08);
  border-left:6px solid #2563eb;
}

.status-product{
  font-size:16px;
  font-weight:600;
  color:#111;
  margin-bottom:6px;
}

.status-badge{
  display:inline-block;
  padding:4px 12px;
  border-radius:20px;
  font-size:13px;
  font-weight:600;
  margin-bottom:8px;
}

.status-pending{ background:#fef3c7;color:#92400e; }
.status-confirmed{ background:#dcfce7;color:#166534; }
.status-delivery{ background:#e0f2fe;color:#075985; }
.status-delivered{ background:#ede9fe;color:#5b21b6; }

.status-time{
  font-size:13px;
  color:#555;
}
  
</style>
</head>

<body>
<div class="main">

<div class="icon-bar">
  <button class="icon-btn" onclick="openRetailerProfile()"><i class="bi bi-person-circle"></i></button>
  <button class="icon-btn" onclick="openOrders()"><i class="bi bi-bag-check"></i></button>
  <button class="icon-btn" onclick="openCart()"><i class="bi bi-cart"></i></button>
  <button class="icon-btn" onclick="openDeliveryDetails()">
    <i class="bi bi-truck"></i><span id="deliveryDot" class="notify-dot"></span>
  </button>
</div>

<div class="header"><h3>üõí Retailer Dashboard</h3></div>

<div class="header">
  <input id="wid" placeholder="Enter Wholesaler ID">
  <button class="primary" onclick="loadProducts()">Search</button>
</div>

<div class="products-grid" id="products"></div>
</div>

<!-- PRODUCT DETAIL -->
<div class="modal" id="detailModal">
 <div class="modal-content">
  <h3 id="dName"></h3>
  <img id="dImg" style="width:100%;border-radius:10px">
  <p id="dDesc"></p>
  <p id="dPrice"></p>
  <select id="vehicleType">
    <option value="">Select Vehicle</option>
    <option value="two_wheeler">Two Wheeler</option>
    <option value="three_wheeler">Three Wheeler</option>
    <option value="four_wheeler">Four Wheeler</option>
  </select>
  <p id="dDelivery"></p>
  <p id="dTotal"></p>
  <button class="primary" onclick="directBuy()">‚ö° Buy Now</button>
  <button onclick="closeAll()">Close</button>
 </div>
</div>

<!-- CART -->
<div class="modal" id="cartModal">
 <div class="modal-content">
  <h3 style="text-align:center">üß∫ My Cart</h3>

  <div id="cartItems" style="margin-top:10px"></div>

  <div style="margin-top:12px">
    <select id="cartVehicle" onchange="updateCartTotal()">
      <option value="">üöö Select Vehicle</option>
      <option value="two_wheeler">Two Wheeler</option>
      <option value="three_wheeler">Three Wheeler</option>
      <option value="four_wheeler">Four Wheeler</option>
    </select>
  </div>

  <div style="background:#f8fafc;padding:12px;border-radius:10px;margin-top:12px">
    <div id="cartSubtotal" class="small"></div>
    <div id="cartDelivery" class="small"></div>
    <hr>
    <b id="cartGrandTotal"></b>
  </div>

  <button class="primary" style="margin-top:12px" onclick="payCart()">üí≥ Pay & Order</button>
  <button onclick="closeAll()">Close</button>
 </div>
</div>

<!-- PROFILE -->
<div class="modal" id="profileModal">
 <div class="modal-content">
  <h3>Retailer Profile</h3>
  <input id="profileName" placeholder="Name">
  <input id="profileMobile" placeholder="Mobile">
  <textarea id="profileAddress" placeholder="Address"></textarea>
  <button class="primary" onclick="saveProfile()">Save</button>
  <button onclick="closeAll()">Close</button>
 </div>
</div>

<!-- ORDER STATUS -->
<div class="modal" id="orderStatusModal">
  <div class="modal-content">
    <h3 style="text-align:center;margin-bottom:16px">üì¶ Order Status</h3>

    <div id="orderStatusData"></div>

    <button class="primary" onclick="closeAll()">Close</button>
  </div>
</div>

<!-- DELIVERY DETAILS -->
<div class="modal" id="deliveryModal">
  <div class="modal-content">
    <h3 style="text-align:center;margin-bottom:15px">üöö Delivery Details</h3>

    <div id="deliveryData"></div>

    <button class="primary" onclick="closeAll()">Close</button>
  </div>
</div>

<script>
const API="https://shopbacked-vmhs.onrender.com";
let selectedProduct=null;
let cart=JSON.parse(localStorage.getItem("cart")||"[]");

/* TIME FORMAT */
function formatDT(d){
 const dt=new Date(d);
 return dt.toLocaleDateString()+" "+dt.toLocaleTimeString();
}
function deliveryChargeByVehicle(v){
 return v==="two_wheeler"?1:v==="three_wheeler"?50:80;
}

/* LOAD PRODUCTS */
async function loadProducts(){
 const wid=widInput= document.getElementById("wid").value.trim();
 const r=await fetch(`${API}/api/products/wholesaler/${wid}`);
 const d=await r.json();
 products.innerHTML=d.products.map(p=>`
 <div class="product-card">
  <img src="${p.image}">
  <div>${p.productName}</div>
  <div class="price">‚Çπ${p.price}</div>
  <div class="actions">
   <button class="cart-btn" onclick='addToCart(${JSON.stringify(p)})'>üõí</button>
   <button class="buy-btn" onclick='openDetail(${JSON.stringify(p)})'>‚ö°</button>
  </div>
 </div>`).join("");
}

/* DETAIL */
function openDetail(p){
 selectedProduct=p;
 dName.innerText=p.productName;
 dImg.src=p.image;
 dDesc.innerText=p.detail||"No description";
 dPrice.innerText="Price ‚Çπ"+p.price;
 dDelivery.innerText="";
 dTotal.innerText="";
 detailModal.style.display="flex";
}

/* DIRECT BUY */
async function directBuy(){
 const v=vehicleType.value;
 if(!v) return alert("Select vehicle");
 const profile=JSON.parse(localStorage.getItem("retailerProfile")||"{}");
 if(!profile.mobile) return alert("Save profile first");

 const dc=deliveryChargeByVehicle(v);
 const total=selectedProduct.price+dc;
 dDelivery.innerText="Delivery ‚Çπ"+dc;
 dTotal.innerText="Total ‚Çπ"+total;

 const r=await fetch(API+"/api/orders/pay-and-create",{
  method:"POST",headers:{'Content-Type':'application/json'},
  body:JSON.stringify({amount:total})
 });
 const d=await r.json();

 new Razorpay({
  key:d.key,amount:d.amount,order_id:d.order.id,currency:"INR",
  handler:async resp=>{
   await fetch(API+"/api/orders/confirm-after-payment",{
    method:"POST",headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
     paymentId:resp.razorpay_payment_id,
     productId:selectedProduct._id,
     totalAmount:total,
     deliveryCharge:dc,
     retailerName:profile.name,
     retailerMobile:profile.mobile,
     retailerAddress:profile.address
    })
   });
   alert("Order placed");
   closeAll();
  }
 }).open();
}

/* CART */
function addToCart(p){
 cart.push(p);
 localStorage.setItem("cart",JSON.stringify(cart));
 alert("Added to cart");
}
function openCart(){
 let sum=0;
 cartItems.innerHTML=cart.map((c,i)=>{
  sum+=c.price;
  return `<div class="cart-item">${c.productName} ‚Çπ${c.price}
  <button onclick="removeCart(${i})">‚ùå</button></div>`;
 }).join("");
 cartTotal.innerText="Subtotal ‚Çπ"+sum;
 cartModal.style.display="flex";
}
function removeCart(i){
 cart.splice(i,1);
 localStorage.setItem("cart",JSON.stringify(cart));
 openCart();
}

 function updateCartTotal(){
 const vehicle = document.getElementById("cartVehicle").value;
 let subtotal = cart.reduce((s,i)=>s+i.price,0);
 let delivery = 0;

 if(vehicle==="two_wheeler") delivery=1;
 else if(vehicle==="three_wheeler") delivery=50;
 else if(vehicle==="four_wheeler") delivery=80;

 cartDelivery.innerText = "Delivery ‚Çπ"+delivery;
 cartGrandTotal.innerText = "Total ‚Çπ"+(subtotal+delivery);
} 

  
/* PAY CART */
async function payCart(){
 const vehicle = cartVehicle.value;
 if(!vehicle) return alert("Select vehicle first");

 const profile = JSON.parse(localStorage.getItem("retailerProfile")||"{}");
 if(!profile.mobile) return alert("Save profile first");

 let delivery = vehicle==="two_wheeler"?1:vehicle==="three_wheeler"?50:80;
 let subtotal = cart.reduce((s,i)=>s+i.price,0);
 let total = subtotal + delivery;

 const r = await fetch(API+"/api/orders/pay-and-create",{
  method:"POST",
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({amount:total})
 });
 const d = await r.json();

 new Razorpay({
  key:d.key,
  amount:d.amount,
  order_id:d.order.id,
  currency:"INR",
  handler: async resp=>{
    await fetch(API+"/api/orders/confirm-after-payment",{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        paymentId:resp.razorpay_payment_id,
        products:cart,
        totalAmount:total,
        deliveryCharge:delivery,
        retailerName:profile.name,
        retailerMobile:profile.mobile,
        retailerAddress:profile.address
      })
    });
    localStorage.removeItem("cart");
    cart=[];
    alert("Order placed successfully");
    closeAll();
  }
 }).open();
}

/* ORDERS */
function openCart(){
 cart = JSON.parse(localStorage.getItem("cart")||"[]");

 if(cart.length===0){
  cartItems.innerHTML="<p style='text-align:center'>üõí Cart is empty</p>";
  cartSubtotal.innerText="";
  cartDelivery.innerText="";
  cartGrandTotal.innerText="";
  cartModal.style.display="flex";
  return;
 }

 let subtotal=0;
 cartItems.innerHTML = cart.map((c,i)=>{
  subtotal+=c.price;
  return `
  <div style="
    display:flex;
    gap:10px;
    align-items:center;
    background:#fff;
    padding:10px;
    border-radius:12px;
    margin-bottom:8px;
    box-shadow:0 3px 8px rgba(0,0,0,.08)">
    
    <img src="${c.image}" style="width:60px;height:60px;border-radius:8px;object-fit:cover">

    <div style="flex:1">
      <b>${c.productName}</b><br>
      <span class="small">‚Çπ${c.price}</span>
    </div>

    <button onclick="removeCart(${i})"
     style="border:none;background:#fee2e2;border-radius:50%;width:30px;height:30px">‚ùå</button>
  </div>`;
 }).join("");

 cartSubtotal.innerText = "Subtotal ‚Çπ"+subtotal;
 cartDelivery.innerText = "Delivery ‚Çπ0";
 cartGrandTotal.innerText = "Total ‚Çπ"+subtotal;

 cartModal.style.display="flex";
}

/* DELIVERY */

async function openDeliveryDetails(){
  deliveryModal.style.display="flex";

  const p = JSON.parse(localStorage.getItem("retailerProfile")||"{}");
  if(!p.mobile){
    deliveryData.innerHTML="Profile not found";
    return;
  }

  const res = await fetch(`${API}/api/orders/retailer/${p.mobile}`);
  const data = await res.json();

  const delivered = data.orders.filter(o => o.deliveryBoyName);

  if(delivered.length === 0){
    deliveryData.innerHTML = "<p style='text-align:center;color:#666'>No delivery assigned yet</p>";
    return;
  }

  deliveryData.innerHTML = delivered.map(o=>{
    const d = new Date(o.createdAt);
    return `
      <div class="delivery-card">
        <div class="delivery-row">
          <span class="delivery-label">üì¶ Product</span>
          <span class="delivery-value">${o.productName}</span>
        </div>

        <div class="delivery-row">
          <span class="delivery-label">üë§ Delivery Boy</span>
          <span class="delivery-value">${o.deliveryBoyName}</span>
        </div>

        <div class="delivery-row">
          <span class="delivery-label">üìû Mobile</span>
          <span class="delivery-value">${o.deliveryBoyMobile}</span>
        </div>

        <div class="delivery-row">
          <span class="delivery-label">üïí Date</span>
          <span class="delivery-value">
            ${d.toLocaleDateString("en-IN")} ${d.toLocaleTimeString("en-IN")}
          </span>
        </div>

        <div class="delivery-code">
          üîê Delivery Code : ${o.deliveryCode}
        </div>
      </div>
    `;
  }).join("");
}

async function openOrderStatus(){
  orderStatusModal.style.display="flex";

  const p = JSON.parse(localStorage.getItem("retailerProfile")||"{}");
  if(!p.mobile){
    orderStatusData.innerHTML="Profile not found";
    return;
  }

  const res = await fetch(`${API}/api/orders/retailer/${p.mobile}`);
  const data = await res.json();

  if(!data.orders || data.orders.length===0){
    orderStatusData.innerHTML="<p style='text-align:center;color:#666'>No orders found</p>";
    return;
  }

  orderStatusData.innerHTML = data.orders.map(o=>{
    const d = new Date(o.updatedAt || o.createdAt);

    let cls = "status-pending";
    if(o.status.includes("confirmed")) cls="status-confirmed";
    if(o.status.includes("delivery")) cls="status-delivery";
    if(o.status==="delivered") cls="status-delivered";

    return `
      <div class="status-card">
        <div class="status-product">${o.productName}</div>

        <div class="status-badge ${cls}">
          ${o.status.replaceAll("_"," ").toUpperCase()}
        </div>

        <div class="status-time">
          üïí ${d.toLocaleDateString("en-IN")} ${d.toLocaleTimeString("en-IN")}
        </div>
      </div>
    `;
  }).join("");
}
  


  
/* PROFILE */
async function openRetailerProfile(){
  profileModal.style.display = "flex";

  const retailerId = localStorage.getItem("userId");

  try{
    const res = await fetch(`${API}/api/retailers/profile/${retailerId}`);
    const data = await res.json();

    if(data.success && data.profile){
      profileName.value    = data.profile.name || "";
      profileMobile.value  = data.profile.mobile || "";
      profileAddress.value = data.profile.address || "";
    }else{
      profileName.value="";
      profileMobile.value="";
      profileAddress.value="";
    }
  }catch(err){
    alert("Server error");
  }
}

/* NOTIFY */
setInterval(async()=>{
 const p=JSON.parse(localStorage.getItem("retailerProfile")||"{}");
 if(!p.mobile) return;
 const r=await fetch(`${API}/api/orders/retailer/${p.mobile}`);
 const d=await r.json();
 deliveryDot.style.display=d.orders.some(o=>o.deliveryBoyName)?"block":"none";
},8000);

function closeAll(){
 document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
}
</script>
</body>
</html>
