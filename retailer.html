<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Retailer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:20px}
.icon-bar{display:flex;gap:20px;justify-content:center;background:#064e3b;padding:12px;border-radius:14px;max-width:700px;margin:auto}
.icon-btn{background:#16a34a;color:#fff;border:none;width:55px;height:55px;border-radius:50%;font-size:22px;cursor:pointer;position:relative}
.notify-dot{position:absolute;top:8px;right:8px;width:10px;height:10px;border-radius:50%;background:red;display:none}
.header{margin-top:15px;background:#fff;padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.08)}
.products-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px}
.product-card{background:#fff;padding:8px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.product-card img{width:100%;height:90px;object-fit:cover;border-radius:8px}
.price{color:#16a34a;font-weight:600;font-size:13px}
.actions{display:flex;gap:5px;margin-top:6px}
.actions button{flex:1;border:none;border-radius:8px;padding:6px;font-size:12px;cursor:pointer}
.cart-btn{background:#e5fbe9}
.buy-btn{background:#fee2e2}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
.modal-content{background:#fff;padding:20px;width:90%;max-width:500px;border-radius:15px;max-height:85vh;overflow:auto}
input,select,textarea{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc}
button.primary{background:#16a34a;color:#fff;border:none;padding:10px;border-radius:10px;cursor:pointer;width:100%}
.cart-item{border-bottom:1px solid #ddd;padding:8px 0}
.order-card{background:#fff;padding:12px;margin-bottom:10px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.badge{background:#e0f2fe;padding:4px 10px;border-radius:20px;font-size:12px}
.small{font-size:12px;color:#555}
.delivery-card{background:#f8fafc;border-left:5px solid #16a34a;padding:14px;border-radius:12px;margin-bottom:12px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
.delivery-row{display:flex;justify-content:space-between;font-size:14px;margin:4px 0;}
.delivery-label{color:#555;}
.delivery-value{font-weight:600;color:#111;}
.delivery-code{background:#dcfce7;color:#166534;padding:4px 10px;border-radius:20px;font-weight:600;display:inline-block;margin-top:6px;}
.status-card{background:#ffffff;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 6px 14px rgba(0,0,0,.08);border-left:6px solid #2563eb;}
.status-product{font-size:16px;font-weight:600;color:#111;margin-bottom:6px;}
.status-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:13px;font-weight:600;margin-bottom:8px;}
.status-pending{ background:#fef3c7;color:#92400e; }
.status-confirmed{ background:#dcfce7;color:#166534; }
.status-delivery{ background:#e0f2fe;color:#075985; }
.status-delivered{ background:#ede9fe;color:#5b21b6; }
.status-time{font-size:13px;color:#555;}
</style>
</head>
<body>

<div class="main">
  <div class="icon-bar">
    <button class="icon-btn" onclick="openRetailerProfile()"><i class="bi bi-person-circle"></i></button>
    <button class="icon-btn" onclick="openOrderStatus()"><i class="bi bi-bag-check"></i></button>
    <button class="icon-btn" onclick="openCart()"><i class="bi bi-cart"></i></button>
    <button class="icon-btn" onclick="openDeliveryDetails()">
      <i class="bi bi-truck"></i><span id="deliveryDot" class="notify-dot"></span>
    </button>
  </div>

  <div class="header"><h3>üõí Retailer Dashboard</h3></div>

  <div class="header">
    <input id="wid" placeholder="Enter Wholesaler ID">
    <button class="primary" onclick="loadProducts()">Search</button>
  </div>

  <div class="products-grid" id="products"></div>
</div>

<!-- PRODUCT DETAIL -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <h3 id="dName"></h3>
    <img id="dImg" style="width:100%;border-radius:10px">
    <p id="dDesc"></p>
    <p id="dPrice"></p>
    <select id="vehicleType">
      <option value="">Select Vehicle</option>
      <option value="two_wheeler">Two Wheeler</option>
      <option value="three_wheeler">Three Wheeler</option>
      <option value="four_wheeler">Four Wheeler</option>
    </select>
    <p id="dDelivery"></p>
    <p id="dTotal"></p>
    <button type="button" onclick="directBuy(event)">‚ö° Buy Now</button>
<button type="button" onclick="closeAll()">Close</button>
  </div>
</div>

<!-- CART -->
<div class="modal" id="cartModal">
  <div class="modal-content">
    <h3 style="text-align:center">üß∫ My Cart</h3>
    <div id="cartItems" style="margin-top:10px"></div>
    <div style="margin-top:12px">
      <select id="cartVehicle" onchange="updateCartTotal()">
        <option value="">üöö Select Vehicle</option>
        <option value="two_wheeler">Two Wheeler</option>
        <option value="three_wheeler">Three Wheeler</option>
        <option value="four_wheeler">Four Wheeler</option>
      </select>
    </div>
    <div style="background:#f8fafc;padding:12px;border-radius:10px;margin-top:12px">
      <div id="cartSubtotal" class="small"></div>
      <div id="cartDelivery" class="small"></div>
      <hr>
      <b id="cartGrandTotal"></b>
    </div>
    <button class="primary" style="margin-top:12px" onclick="payCart()">üí≥ Pay & Order</button>
    <button onclick="closeAll()">Close</button>
  </div>
</div>

<!-- PROFILE -->
<div class="modal" id="profileModal">
  <div class="modal-content">
    <h3>Retailer Profile</h3>
    <input id="profileName" placeholder="Name">
    <input id="profileMobile" placeholder="Mobile">
    <textarea id="profileAddress" placeholder="Address"></textarea>
    <button class="primary" onclick="saveProfile()">Save</button>
    <button onclick="closeAll()">Close</button>
  </div>
</div>

<!-- ORDER STATUS -->
<div class="modal" id="orderStatusModal">
  <div class="modal-content">
    <h3 style="text-align:center;margin-bottom:16px">üì¶ Order Status</h3>
    <div id="orderStatusData"></div>
    <button class="primary" onclick="closeAll()">Close</button>
  </div>
</div>

<!-- DELIVERY DETAILS -->
<div class="modal" id="deliveryModal">
  <div class="modal-content">
    <h3 style="text-align:center;margin-bottom:15px">üöö Delivery Details</h3>
    <div id="deliveryData"></div>
    <button class="primary" onclick="closeAll()">Close</button>
  </div>
</div>

<script>
const API = "https://shopbacked-vmhs.onrender.com";

let selectedProduct = null;
let cart = JSON.parse(localStorage.getItem("cart") || "[]");

// DOM elements
const products = document.getElementById("products");
const detailModal = document.getElementById("detailModal");
const dName = document.getElementById("dName");
const dImg = document.getElementById("dImg");
const dDesc = document.getElementById("dDesc");
const dPrice = document.getElementById("dPrice");
const dDelivery = document.getElementById("dDelivery");
const dTotal = document.getElementById("dTotal");
const vehicleType = document.getElementById("vehicleType");
const cartModal = document.getElementById("cartModal");
const cartItems = document.getElementById("cartItems");
const cartSubtotal = document.getElementById("cartSubtotal");
const cartDelivery = document.getElementById("cartDelivery");
const cartGrandTotal = document.getElementById("cartGrandTotal");
const cartVehicle = document.getElementById("cartVehicle");
const profileModal = document.getElementById("profileModal");
const profileName = document.getElementById("profileName");
const profileMobile = document.getElementById("profileMobile");
const profileAddress = document.getElementById("profileAddress");
const orderStatusModal = document.getElementById("orderStatusModal");
const orderStatusData = document.getElementById("orderStatusData");
const deliveryModal = document.getElementById("deliveryModal");
const deliveryData = document.getElementById("deliveryData");
const deliveryDot = document.getElementById("deliveryDot");

// Utility
function formatDT(d){ const dt=new Date(d); return dt.toLocaleDateString()+" "+dt.toLocaleTimeString(); }
function deliveryChargeByVehicle(v){ return v==="two_wheeler"?1:v==="three_wheeler"?50:80; }

// ------------------- PRODUCTS -------------------
async function loadProducts(){
  const wid = document.getElementById("wid").value.trim();
  if(!wid) return alert("Enter Wholesaler ID");
  try{
    const res = await fetch(`${API}/api/products/wholesaler/${wid}`);
    const data = await res.json();
    products.innerHTML = data.products.map(p => {
      const pdata = encodeURIComponent(JSON.stringify(p));
      return `
        <div class="product-card">
          <img src="${p.image}">
          <div>${p.productName}</div>
          <div class="price">‚Çπ${p.price}</div>
          <div class="actions">
            <button class="cart-btn" onclick='addToCart(JSON.parse(decodeURIComponent("${pdata}")))'>üõí</button>
            <button class="buy-btn" onclick='openDetail(JSON.parse(decodeURIComponent("${pdata}")))'>‚ö°</button>
          </div>
        </div>`;
    }).join("");
  }catch(e){
    alert("Products load failed");
  }
}


// ------------------- PRODUCT DETAIL -------------------
function openDetail(p){
  selectedProduct = p;
  dName.innerText = p.productName;
  dImg.src = p.image;
  dDesc.innerText = p.detail || "No description";
  dPrice.innerText = "Price ‚Çπ"+p.price;
  dDelivery.innerText = "";
  dTotal.innerText = "";
  vehicleType.value = "";
  detailModal.style.display = "flex";
}

async function directBuy(e) {
  e.preventDefault();

  if (!vehicleType.value) {
    alert("üöö Select vehicle first");
    return;
  }

  const retailerProfile = JSON.parse(
    localStorage.getItem("retailerProfile") || "{}"
  );

  if (!retailerProfile.mobile) {
    alert("üë§ Please save profile first");
    return;
  }

  const delivery = deliveryChargeByVehicle(vehicleType.value);
  const total = selectedProduct.price + delivery;

  const res = await fetch(`${API}/api/orders/pay-and-create`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: total,
      notes: {
        productId: selectedProduct._id,
        productName: selectedProduct.productName,
        price: selectedProduct.price,

        wholesalerId: selectedProduct.wholesalerId,
        wholesalerName: selectedProduct.shopName,
        wholesalerMobile: selectedProduct.mobile,
        wholesalerAddress: selectedProduct.address,

        retailerName: retailerProfile.name,
        retailerMobile: retailerProfile.mobile,
        retailerAddress: retailerProfile.address,

        vehicleType: vehicleType.value,
        deliveryCharge: delivery
      }
    })
  });

  const data = await res.json();
  if (!data.success) {
    alert("‚ùå Order create failed");
    return;
  }

  const rzp = new Razorpay({
    key: data.key,
    amount: data.amount,
    currency: "INR",
    order_id: data.order.id,

    handler: function (resp) {
      alert("‚úÖ Payment Successful üéâ");
      alert("üì¶ Order processing ho raha hai");

      closeAll();
      setTimeout(() => {
    openOrderStatus();
  }, 3000); // üî• direct show order
    },

    modal: {
      ondismiss: function () {
        alert("‚ùå Payment cancelled");
      }
    }
  });

  rzp.open();
}
// ------------------- CART -------------------
async function addToCart(p){

  const retailerId = localStorage.getItem("userId");
  if(!retailerId){
    alert("üîê Please login first");
    return;
  }

  // üîÅ DUPLICATE CHECK
  const already = cart.find(item => item._id === p._id);
  if(already){
    alert("‚ö†Ô∏è Product already in cart");
    return;
  }

  // ‚úÖ ADD TO CART (LOCAL)
  cart.push(p);

  try{
    const res = await fetch(`${API}/api/cart/save`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        retailerId: retailerId,
        items: cart
      })
    });

    const data = await res.json();

    if(data.success){
      localStorage.setItem("cart", JSON.stringify(cart));

      alert(
        "üõí Added to cart successfully ‚úÖ\n\n" +
        "Product: " + p.productName + "\n" +
        "Price: ‚Çπ" + p.price
      );
    }else{
      // ‚ùå rollback
      cart = cart.filter(item => item._id !== p._id);
      alert("‚ùå Failed to add item to cart");
    }

  }catch(err){
    console.error("ADD CART ERROR:", err);

    // ‚ùå rollback
    cart = cart.filter(item => item._id !== p._id);
    alert("‚ùå Server error while adding to cart");
  }
}

async function openCart(){
  try{
    const retailerId = localStorage.getItem("userId");
    const res = await fetch(`${API}/api/cart/${retailerId}`);
    const data = await res.json();
    cart = data.cart ? data.cart.items : [];
    localStorage.setItem("cart", JSON.stringify(cart));

    if(cart.length===0){
      cartItems.innerHTML="üõí Cart empty";
      cartSubtotal.innerText="";
      cartDelivery.innerText="";
      cartGrandTotal.innerText="";
      cartVehicle.value="";
      cartModal.style.display="flex";
      return;
    }

    let subtotal = 0;
    cartItems.innerHTML = cart.map((c,i)=>{
      subtotal += c.price;
      return `<div class="cart-item">${c.productName} ‚Çπ${c.price} <button onclick="removeCart(${i})">‚ùå</button></div>`;
    }).join("");
    cartSubtotal.innerText = "Subtotal ‚Çπ"+subtotal;
    cartDelivery.innerText = "Delivery ‚Çπ0";
    cartGrandTotal.innerText = "Total ‚Çπ"+subtotal;
    cartVehicle.value="";
    cartModal.style.display="flex";
  }catch(e){ alert("Failed to load cart"); }
}

async function removeCart(i){
  cart.splice(i,1);
  try{
    await fetch(`${API}/api/cart/save`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ retailerId: localStorage.getItem("userId"), items: cart })
    });
    localStorage.setItem("cart", JSON.stringify(cart));
    openCart();
  }catch(e){ alert("Failed to remove item"); }
}

function updateCartTotal(){
  const vehicle = cartVehicle.value;
  let subtotal = cart.reduce((s,i)=>s+i.price,0);
  let delivery = vehicle ? deliveryChargeByVehicle(vehicle) : 0;
  cartDelivery.innerText = "Delivery ‚Çπ"+delivery;
  cartGrandTotal.innerText = "Total ‚Çπ"+(subtotal+delivery);
}

async function payCart(){

  const vehicle = cartVehicle.value;
  if(!vehicle){
    alert("üöö Select vehicle first");
    return;
  }

  const profile = JSON.parse(localStorage.getItem("retailerProfile") || "{}");
  if(!profile.mobile){
    alert("üë§ Save profile first");
    return;
  }

  const delivery = deliveryChargeByVehicle(vehicle);
  const subtotal = cart.reduce((s,i)=>s + i.price, 0);
  const total = subtotal + delivery;

  try{

    // üîπ STEP 1: CREATE RAZORPAY ORDER
    const res = await fetch(`${API}/api/orders/pay-and-create`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ amount: total })
    });

    const data = await res.json();
    if(!data.success){
      alert("‚ùå Payment init failed");
      return;
    }

    // üîπ STEP 2: OPEN RAZORPAY
    const rzp = new Razorpay({
      key: data.key,
      amount: data.amount,
      currency: "INR",
      order_id: data.order.id,

      // üî¥ VERY IMPORTANT ‚Äî NOTES (WEBHOOK USES THIS)
      notes:{
        retailerName: profile.name,
        retailerMobile: profile.mobile,
        retailerAddress: profile.address,

        vehicleType: vehicle,
        deliveryCharge: delivery,

        products: JSON.stringify(
          cart.map(p => ({
            productId: p._id,
            productName: p.productName,
            price: p.price,
            wholesalerId: p.wholesalerId,
            wholesalerName: p.shopName,
            wholesalerMobile: p.mobile,
            wholesalerAddress: p.address
          }))
        )
      },

      handler: function (resp) {

        // ‚úÖ PAYMENT SUCCESS
        localStorage.removeItem("cart");
        cart = [];

        alert(
          "‚úÖ Cart Payment Successful üéâ\n\n" +
          "Payment ID: " + resp.razorpay_payment_id + "\n\n" +
          "Orders processing me hain üöö"
        );

        closeAll();
      },

      modal:{
        ondismiss:function(){
          alert("‚ùå Payment cancelled");
        }
      }
    });

    rzp.open(); // üî• MUST

  }catch(err){
    console.error("CART PAYMENT ERROR:", err);
    alert("‚ùå Payment failed");
  }
}
// ------------------- DELIVERY -------------------
async function openDeliveryDetails(){
  deliveryModal.style.display="flex";

  const profile = JSON.parse(localStorage.getItem("retailerProfile")||"{}");
  if(!profile.mobile){
    deliveryData.innerHTML="Profile not found";
    return;
  }

  try{
    const res = await fetch(`${API}/api/orders/retailer/${profile.mobile}`);
    const data = await res.json();

    const visibleOrders = data.orders.filter(o =>
      o.status === "delivery_code_generated" || o.status === "delivered"
    );

    if(visibleOrders.length===0){
      deliveryData.innerHTML="<p style='text-align:center;color:#666'>No delivery details yet</p>";
      return;
    }

    deliveryData.innerHTML = visibleOrders.map(o=>{
      const lastStatusTime =
        o.statusHistory && o.statusHistory.length
          ? o.statusHistory[o.statusHistory.length - 1].time
          : o.createdAt;

      const d = new Date(lastStatusTime);

      return `
      <div class="delivery-card">
        <div class="delivery-row">
          <span class="delivery-label">üì¶ Product</span>
          <span class="delivery-value">${o.productName || "-"}</span>
        </div>

        <div class="delivery-row">
          <span class="delivery-label">üë§ Delivery Boy</span>
          <span class="delivery-value">${o.deliveryBoyName || "Assigned"}</span>
        </div>

        <div class="delivery-row">
          <span class="delivery-label">üïí Time</span>
          <span class="delivery-value">${d.toLocaleDateString("en-IN")} ${d.toLocaleTimeString("en-IN")}</span>
        </div>

        ${o.deliveryCode
          ? `<div class="delivery-code">üîê Delivery Code : ${o.deliveryCode}</div>`
          : `<div class="delivery-code">‚è≥ Waiting for code...</div>`
        }
      </div>`;
    }).join("");

  }catch(e){
    deliveryData.innerHTML="Failed to load delivery details";
  }
}

// ------------------- ORDER STATUS -------------------
async function openOrderStatus(){
  orderStatusModal.style.display="flex";
  const profile = JSON.parse(localStorage.getItem("retailerProfile")||"{}");
  if(!profile.mobile){
    orderStatusData.innerHTML="Profile not found";
    return;
  }
  try{
    const res = await fetch(`${API}/api/orders/retailer/${profile.mobile}`);
    const data = await res.json();
    if(!data.orders || data.orders.length===0){
      orderStatusData.innerHTML="<p style='text-align:center;color:#666'>No orders found</p>";
      return;
    }
    orderStatusData.innerHTML = data.orders.map(o=>{
      const d = new Date(o.updatedAt || o.createdAt);
      let cls = "status-pending";
      if(o.status.includes("confirmed")) cls="status-confirmed";
      if(o.status.includes("delivery")) cls="status-delivery";
      if(o.status==="delivered") cls="status-delivered";
      return `<div class="status-card">
        <div class="status-product">${o.productName}</div>
        <div class="status-badge ${cls}">${o.status.replaceAll("_"," ").toUpperCase()}</div>
        <div class="status-time">üïí ${d.toLocaleDateString("en-IN")} ${d.toLocaleTimeString("en-IN")}</div>
      </div>`;
    }).join("");
  }catch(e){ orderStatusData.innerHTML="Failed to load orders"; }
}

// ------------------- PROFILE -------------------
/* PROFILE */

async function openRetailerProfile(){

  profileModal.style.display = "flex";

  const retailerId = localStorage.getItem("userId");
  if(!retailerId){
    alert("Login required");
    return;
  }

  try{
    const res = await fetch(`${API}/api/retailers/profile/${retailerId}`);
    const data = await res.json();

    if(data.success && data.profile){

      profileName.value    = data.profile.name || "";
      profileMobile.value  = data.profile.mobile || "";
      profileAddress.value = data.profile.address || "";

      // ‚úÖ IMPORTANT ‚Äî cache for order/delivery
      localStorage.setItem(
        "retailerProfile",
        JSON.stringify(data.profile)
      );

    }else{
      profileName.value="";
      profileMobile.value="";
      profileAddress.value="";
    }

  }catch(err){
    alert("Server error");
  }
}



async function saveProfile(){

  if(!profileMobile.value.trim()){
    alert("Mobile required");
    return;
  }

  const payload = {
    retailerId: localStorage.getItem("userId"),
    name: profileName.value.trim(),
    mobile: profileMobile.value.trim(),
    address: profileAddress.value.trim()
  };

  try{
    const res = await fetch(`${API}/api/retailers/saveProfile`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if(data.success){

      // ‚úÖ CRITICAL ‚Äî system dependency
      localStorage.setItem(
        "retailerProfile",
        JSON.stringify(payload)
      );

      alert("‚úÖ Profile server me save ho gaya");
      closeAll();

    }else{
      alert("‚ùå Save failed");
    }

  }catch(err){
    alert("Server error");
  }
}
// ------------------- NOTIFY -------------------
setInterval(async()=>{
  const profile = JSON.parse(localStorage.getItem("retailerProfile")||"{}");
  if(!profile.mobile) return;
  try{
    const res = await fetch(`${API}/api/orders/retailer/${profile.mobile}`);
    const data = await res.json();
    deliveryDot.style.display = data.orders.some(o=>o.deliveryBoyName) ? "block":"none";
  }catch(e){}
},8000);

// ------------------- CLOSE MODALS -------------------
function closeAll(){
  document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
}
</script>
</body>
</html>
