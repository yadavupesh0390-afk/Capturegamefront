<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Retailer Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:20px}
.icon-bar{display:flex;gap:20px;justify-content:center;background:#064e3b;padding:12px;border-radius:14px;max-width:700px;margin:auto}
.icon-btn{background:#16a34a;color:#fff;border:none;width:55px;height:55px;border-radius:50%;font-size:22px;cursor:pointer;position:relative}
.notify-dot{position:absolute;top:8px;right:8px;width:10px;height:10px;border-radius:50%;background:red;display:none}
.header{margin-top:15px;background:#fff;padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.08)}
.products-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px}
.product-card{background:#fff;padding:8px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.product-card img{width:100%;height:90px;object-fit:cover;border-radius:8px}
.price{color:#16a34a;font-weight:600;font-size:13px}
.actions{display:flex;gap:5px;margin-top:6px}
.actions button{flex:1;border:none;border-radius:8px;padding:6px;font-size:12px;cursor:pointer}
.cart-btn{background:#e5fbe9}
.buy-btn{background:#fee2e2}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
.modal-content{background:#fff;padding:20px;width:90%;max-width:500px;border-radius:15px;max-height:85vh;overflow:auto}
input,select,textarea{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc}
button.primary{background:#16a34a;color:#fff;border:none;padding:10px;border-radius:10px;cursor:pointer;width:100%}
.cart-item{border-bottom:1px solid #ddd;padding:8px 0}
</style>
</head>

<body>

<div class="main">

  <div class="icon-bar">
    <button class="icon-btn" onclick="openRetailerProfile()"><i class="bi bi-person-circle"></i></button>
    <button class="icon-btn" onclick="openOrderStatus()"><i class="bi bi-bag-check"></i></button>
    <button class="icon-btn" onclick="openCart()"><i class="bi bi-cart"></i></button>
    <button class="icon-btn" onclick="openDeliveryDetails()">
      <i class="bi bi-truck"></i><span id="deliveryDot" class="notify-dot"></span>
    </button>
  </div>

  <div class="header"><h3>ðŸ›’ Retailer Dashboard</h3></div>

  <div class="header">
    <input id="wid" placeholder="Enter Wholesaler ID">
    <button class="primary" onclick="loadProducts()">Search</button>
  </div>

  <div class="products-grid" id="products"></div>
</div>

<!-- PRODUCT DETAIL -->
<div class="modal" id="detailModal">
 <div class="modal-content">
  <h3 id="dName"></h3>
  <img id="dImg" style="width:100%;border-radius:10px">
  <p id="dDesc"></p>
  <p id="dPrice"></p>

  <select id="vehicleType">
    <option value="">Select Vehicle</option>
    <option value="two_wheeler">Two Wheeler</option>
    <option value="three_wheeler">Three Wheeler</option>
    <option value="four_wheeler">Four Wheeler</option>
  </select>

  <button class="primary" onclick="directBuy()">âš¡ Buy Now</button>
  <button onclick="closeAll()">Close</button>
 </div>
</div>

<!-- CART -->
<div class="modal" id="cartModal">
 <div class="modal-content">
  <h3>ðŸ§º My Cart</h3>
  <div id="cartItems"></div>

  <select id="cartVehicle" onchange="updateCartTotal()">
    <option value="">Select Vehicle</option>
    <option value="two_wheeler">Two Wheeler</option>
    <option value="three_wheeler">Three Wheeler</option>
    <option value="four_wheeler">Four Wheeler</option>
  </select>

  <div id="cartSubtotal"></div>
  <div id="cartDelivery"></div>
  <b id="cartGrandTotal"></b>

  <button class="primary" onclick="payCart()">Pay & Order</button>
  <button onclick="closeAll()">Close</button>
 </div>
</div>

<!-- PROFILE -->
<div class="modal" id="profileModal">
 <div class="modal-content">
  <h3>Retailer Profile</h3>
  <input id="profileName" placeholder="Name">
  <input id="profileMobile" placeholder="Mobile">
  <textarea id="profileAddress" placeholder="Address"></textarea>
  <button class="primary" onclick="saveProfile()">Save</button>
  <button onclick="closeAll()">Close</button>
 </div>
</div>

<!-- ORDER STATUS -->
<div class="modal" id="orderStatusModal">
 <div class="modal-content">
  <h3>ðŸ“¦ Order Status</h3>
  <div id="orderStatusData"></div>
  <button onclick="closeAll()">Close</button>
 </div>
</div>

<!-- DELIVERY -->
<div class="modal" id="deliveryModal">
 <div class="modal-content">
  <h3>ðŸšš Delivery</h3>
  <div id="deliveryData"></div>
  <button onclick="closeAll()">Close</button>
 </div>
</div>

<script>
const API="https://shopbacked-vmhs.onrender.com";
let selectedProduct=null;
let cart=[];

function dc(v){return v==="two_wheeler"?1:v==="three_wheeler"?50:80}
function closeAll(){document.querySelectorAll(".modal").forEach(m=>m.style.display="none")}

/* PRODUCTS */
async function loadProducts(){
 const wid=document.getElementById("wid").value;
 const r=await fetch(`${API}/api/products/wholesaler/${wid}`);
 const d=await r.json();
 products.innerHTML=d.products.map(p=>`
 <div class="product-card">
  <img src="${p.image}">
  <div>${p.productName}</div>
  <div class="price">â‚¹${p.price}</div>
  <div class="actions">
   <button onclick="addToCart('${p._id}')">ðŸ›’</button>
   <button onclick='openDetail(${JSON.stringify(p)})'>âš¡</button>
  </div>
 </div>`).join("");
}

/* DETAIL BUY */
function openDetail(p){
 selectedProduct=p;
 dName.innerText=p.productName;
 dImg.src=p.image;
 dDesc.innerText=p.detail||"";
 dPrice.innerText="â‚¹"+p.price;
 detailModal.style.display="flex";
}

async function directBuy(){
 const v=vehicleType.value;
 if(!v) return alert("Vehicle select karo");
 const profile=await getProfile();
 const total=selectedProduct.price+dc(v);

 const r=await fetch(API+"/api/orders/pay-and-create",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:total})});
 const d=await r.json();

 new Razorpay({
  key:d.key,amount:d.amount,order_id:d.order.id,
  handler:async resp=>{
   await fetch(API+"/api/orders/confirm-after-payment",{
    method:"POST",headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
     paymentId:resp.razorpay_payment_id,
     productId:selectedProduct._id,
     totalAmount:total,
     deliveryCharge:dc(v),
     retailer:profile
    })
   });
   alert("Order placed");
   closeAll();
  }
 }).open();
}

/* CART */
async function addToCart(pid){
 await fetch(`${API}/api/cart/add`,{
  method:"POST",headers:{'Content-Type':'application/json'},
  body:JSON.stringify({retailerId:localStorage.getItem("userId"),productId:pid})
 });
 alert("Cart added");
}

async function openCart(){
 const r=await fetch(`${API}/api/cart/${localStorage.getItem("userId")}`);
 const d=await r.json();
 cart=d.items||[];
 let sub=0;
 cartItems.innerHTML=cart.map(c=>{sub+=c.price;return `<div>${c.productName} â‚¹${c.price}</div>`}).join("");
 cartSubtotal.innerText="Subtotal â‚¹"+sub;
 cartDelivery.innerText="Delivery â‚¹0";
 cartGrandTotal.innerText="Total â‚¹"+sub;
 cartModal.style.display="flex";
}

function updateCartTotal(){
 const sub=cart.reduce((s,i)=>s+i.price,0);
 const d=dc(cartVehicle.value);
 cartDelivery.innerText="Delivery â‚¹"+d;
 cartGrandTotal.innerText="Total â‚¹"+(sub+d);
}

async function payCart(){
 const v=cartVehicle.value;
 const profile=await getProfile();
 const sub=cart.reduce((s,i)=>s+i.price,0);
 const total=sub+dc(v);

 const r=await fetch(API+"/api/orders/pay-and-create",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:total})});
 const d=await r.json();

 new Razorpay({
  key:d.key,amount:d.amount,order_id:d.order.id,
  handler:async resp=>{
   await fetch(API+"/api/orders/confirm-after-payment",{
    method:"POST",headers:{'Content-Type':'application/json'},
    body:JSON.stringify({paymentId:resp.razorpay_payment_id,products:cart,totalAmount:total,deliveryCharge:dc(v),retailer:profile})
   });
   alert("Order placed");
   closeAll();
  }
 }).open();
}

/* PROFILE */
async function getProfile(){
 const r=await fetch(`${API}/api/retailers/profile/${localStorage.getItem("userId")}`);
 const d=await r.json();
 return d.profile;
}
async function openRetailerProfile(){
 const p=await getProfile();
 profileName.value=p?.name||"";
 profileMobile.value=p?.mobile||"";
 profileAddress.value=p?.address||"";
 profileModal.style.display="flex";
}
async function saveProfile(){
 await fetch(`${API}/api/retailers/saveProfile`,{
  method:"POST",headers:{'Content-Type':'application/json'},
  body:JSON.stringify({retailerId:localStorage.getItem("userId"),name:profileName.value,mobile:profileMobile.value,address:profileAddress.value})
 });
 alert("Profile saved");
 closeAll();
}
</script>

</body>
</html>
