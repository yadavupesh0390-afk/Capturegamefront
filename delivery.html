<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Delivery Partner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#eef2f7}
.main{max-width:900px;margin:auto;padding:16px}

.top{
 background:#0f172a;color:#fff;
 display:flex;justify-content:space-between;align-items:center;
 padding:14px;border-radius:16px
}
.icon-btn{
 background:#2563eb;border:none;color:#fff;
 width:44px;height:44px;border-radius:50%;
 font-size:20px;cursor:pointer
}
.card{
 background:#fff;margin-top:14px;padding:14px;
 border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08)
}
.order{display:flex;gap:12px;margin-top:12px}
.order img{width:90px;height:80px;object-fit:cover;border-radius:10px}

.badge{padding:4px 10px;border-radius:20px;font-size:12px}
.green{background:#dcfce7;color:#166534}
.blue{background:#e0f2fe;color:#075985}

.btn{
 padding:8px 14px;border:none;border-radius:10px;
 cursor:pointer;margin-top:8px;font-size:13px
}
.accept{background:#16a34a;color:#fff}
.pickup{background:#f59e0b;color:#fff}
.done{background:#2563eb;color:#fff}

/* MODAL */
.modal{
 position:fixed;inset:0;background:rgba(0,0,0,.5);
 display:none;align-items:center;justify-content:center;z-index:50
}
.modal-box{
 background:#fff;width:92%;max-width:400px;
 border-radius:16px;padding:20px
}
.modal-box input{
 width:100%;padding:10px;margin:10px 0;
 border-radius:10px;border:1px solid #ccc
}
</style>
</head>

<body>
<div class="main">

<div class="top">
 <h3>üöö Delivery Partner</h3>
 <button class="icon-btn" onclick="openProfile()">
  <i class="bi bi-person-circle"></i>
 </button>
</div>

<div class="card">
 <b>ID:</b> <span id="dbId"></span><br>
 <span class="badge green">ACTIVE</span>
</div>

<div id="orders"></div>
</div>

<!-- PROFILE MODAL -->
<div class="modal" id="profileModal">
 <div class="modal-box">
  <h3>üë§ Delivery Profile</h3>
  <input id="pName" placeholder="Full Name">
  <input id="pMobile" placeholder="Mobile Number">
  <input id="pVehicle" placeholder="Vehicle Type">
  <input id="pVehicleNo" placeholder="Vehicle Number">
  <input id="pCity" placeholder="City">
  <button class="btn accept" onclick="saveProfile()">Save</button>
  <button class="btn" onclick="closeProfile()">Close</button>
 </div>
</div>

<!-- DELIVERY CODE MODAL -->
<div class="modal" id="codeModal">
 <div class="modal-box">
  <h3>üîê Enter Delivery Code</h3>
  <input id="deliveryCodeInput" placeholder="Enter 6 digit code">
  <button class="btn done" onclick="submitDeliveryCode()">Submit</button>
  <button class="btn" onclick="closeCodeModal()">Cancel</button>
 </div>
</div>

<script>
const API="https://shopbacked-vmhs.onrender.com";
const DBID=localStorage.getItem("userId");
const TOKEN=localStorage.getItem("token");
let CURRENT_ORDER_ID=null;

dbId.innerText=DBID?DBID.slice(0,8).toUpperCase():"N/A";

/* PROFILE */
function openProfile(){
 profileModal.style.display="flex";
 const p=JSON.parse(localStorage.getItem("deliveryProfile_"+DBID)||"{}");
 pName.value=p.name||"";pMobile.value=p.mobile||"";
 pVehicle.value=p.vehicle||"";pVehicleNo.value=p.vehicleNo||"";
 pCity.value=p.city||"";
}
function saveProfile(){
 localStorage.setItem("deliveryProfile_"+DBID,JSON.stringify({
  name:pName.value,mobile:pMobile.value,
  vehicle:pVehicle.value,vehicleNo:pVehicleNo.value,city:pCity.value
 }));
 alert("Profile Saved ‚úÖ");closeProfile();
}
function closeProfile(){profileModal.style.display="none";}

/* LOAD ORDERS */
async function loadOrders(){
 const res=await fetch(`${API}/api/orders/delivery/${DBID}`,{
  headers:{Authorization:"Bearer "+TOKEN}
 });
 const data=await res.json();
 renderOrders(data.orders||[]);
}

/* RENDER */
function renderOrders(list){
 if(!list.length){
  orders.innerHTML="<p style='text-align:center'>No Orders</p>";
  return;
 }
 orders.innerHTML=list.map(o=>`
 <div class="card order">
  <img src="${o.productImg}">
  <div style="flex:1">
   <b>${o.productName}</b> ‚Çπ${o.price}<br><br>

   üè™ <b>${o.wholesalerName||"N/A"}</b><br>
   üìû ${o.wholesalerMobile||"N/A"}<br>
   üè† ${o.wholesalerAddress||"Address not available"}<br><br>

   üè¨ <b>${o.retailerName||"N/A"}</b><br>
   üìû ${o.retailerMobile||"N/A"}<br>
   üè† ${o.retailerAddress||"Address not available"}<br><br>

   <span class="badge blue">${o.status}</span><br>

   ${o.status==="confirmed_by_wholesaler"
    ?`<button class="btn accept" onclick="acceptOrder('${o._id}')">Accept</button>`:""}

   ${o.status==="delivery_accepted"
    ?`<button class="btn pickup" onclick="pickupOrder('${o._id}')">Pickup</button>`:""}

   ${(o.status==="picked_up"||o.status==="delivery_code_generated")
    ?`<button class="btn done" onclick="deliverFlow('${o._id}','${o.status}')">Delivered</button>`:""}
  </div>
 </div>`).join("");
}

/* ACTIONS */
async function acceptOrder(id){
 await fetch(`${API}/api/orders/${id}/delivery-accept`,{method:"POST"});
 loadOrders();
}
async function pickupOrder(id){
 await fetch(`${API}/api/orders/${id}/pickup`,{method:"POST"});
 loadOrders();
}

/* DELIVERY FLOW */
async function deliverFlow(orderId,status){
 if(status==="picked_up"){
  await fetch(`${API}/api/orders/generate-delivery-code/${orderId}`,{method:"POST"});
  alert("Delivery code generated. Ask retailer for code.");
  loadOrders();return;
 }
 if(status==="delivery_code_generated"){
  CURRENT_ORDER_ID=orderId;
  deliveryCodeInput.value="";
  codeModal.style.display="flex";
 }
}
async function submitDeliveryCode(){
 const code=deliveryCodeInput.value.trim();
 if(!code) return alert("Enter delivery code");

 const res=await fetch(`${API}/api/orders/verify-delivery-code/${CURRENT_ORDER_ID}`,{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({code})
 });
 const data=await res.json();
 if(data.success){
  alert("Order Delivered ‚úÖ");
  closeCodeModal();loadOrders();
 }else alert("Invalid Code ‚ùå");
}
function closeCodeModal(){
 codeModal.style.display="none";
 CURRENT_ORDER_ID=null;
}

loadOrders();
setInterval(loadOrders,8000);
</script>
</body>
</html>
