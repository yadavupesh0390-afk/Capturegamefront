<!DOCTYPE html>  <html lang="en">  
<head>  
<meta charset="UTF-8">  
<title>Delivery Partner Dashboard</title>  
<meta name="viewport" content="width=device-width, initial-scale=1.0">  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">  
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">  <style>  

  
  *{
  box-sizing:border-box;
  font-family:Poppins,sans-serif;
  margin:0;
  padding:0;
}

body{
  background:#eef2f7;
}

/* ===================== MAIN ===================== */
.main{
  max-width:900px;
  margin:0 auto;
  padding:14px;

  /* üî• fixed top + active card ka exact offset */
  padding-top: calc(14px + 160px);
}

/* ===================== TOP BAR ===================== */
.top{
  position: fixed;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);

  width: calc(100% - 24px);
  max-width: 900px;

  background:#0f172a;
  color:#fff;

  display:flex;
  justify-content:space-between;
  align-items:center;

  padding:14px;
  border-radius:16px;
  z-index:100;
}

.icon-btn{
  background:#2563eb;
  border:none;
  color:#fff;
  width:42px;
  height:42px;
  border-radius:50%;
  font-size:20px;
  cursor:pointer;
}
.active-card{
  position: fixed;
  top: 86px;                 /* top bar ke niche */
  left: 50%;
  transform: translateX(-50%);

  width: calc(100% - 24px);
  max-width: 900px;

  background:#ffffff;
  padding:10px 14px;
  border-radius:14px;

  box-shadow:0 4px 14px rgba(0,0,0,.08);
  z-index:90;
}


/* ===================== ORDER CARD ===================== */
/* ===================== ORDER CARD ===================== */
/* üî• ORDER CARD GAP FIX */
.card.order{
  display:flex;
  flex-direction:column;
  gap:14px;
  margin-bottom:16px;   /* üëà cards ke beech gap */
  padding:14px;
  background:#fff;
  border-radius:14px;
  box-shadow:0 4px 14px rgba(0,0,0,.06);
}

/* ===================== STATUS WRAPPER ===================== */
.status-wrap{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:10px;  
}
/* STATUS LINE WRAP */
.status-line{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:10px;   /* üëà status & next content gap */
}
/* ===================== STATUS (ULTRA COMPACT) ===================== */
.status-box{
  display:inline-flex;
  align-items:center;
  gap:4px;

  padding:3px 8px;         /* üî• aur chhota */
  font-size:11px;          /* compact text */
  font-weight:600;

  border-radius:999px;     /* perfect pill */
  white-space:nowrap;
  line-height:1;

  box-shadow:0 1px 4px rgba(0,0,0,.08);
}

/* ===================== STATUS COLORS (SOFT + CLEAR) ===================== */
.status-pending{
  background:#fff1e6;      /* soft orange */
  color:#9a3412;
  border:1px solid #fdba74;
}

.status-assigned{
  background:#e8f2ff;      /* clean blue */
  color:#1e40af;
  border:1px solid #93c5fd;
}

.status-delivered{
  background:#e7f9ef;      /* fresh green */
  color:#166534;
  border:1px solid #86efac;
}

.status-default{
  background:#f3f4f6;      /* neutral */
  color:#374151;
  border:1px solid #d1d5db;
}

.btn.accept{background:#16a34a;color:#fff;}
.btn.pickup{background:#f59e0b;color:#fff;}
.btn.done{background:#2563eb;color:#fff;}

/* ===================== MODAL ===================== */
.modal{
  position:fixed;
  top:160px;                 /* üî• header + active card height */
  left:0;
  right:0;
  bottom:0;

  background:rgba(0,0,0,.45);
  display:none;
  align-items:flex-start;    /* center nahi */
  justify-content:center;

  overflow-y:auto;
  z-index:200;               /* üî• sabse upar */
}

/* üî• COMPACT POPUP */
.modal-box{
  background:#fff;
  width:90%;
  max-width:320px;
  border-radius:14px;
  padding:14px;
  box-shadow:0 6px 20px rgba(0,0,0,.2);
  margin-top:12px;
}

.modal-box h3{
  font-size:16px;
  margin-bottom:10px;
}

.modal-box input,
.modal-box select{
  width:100%;
  padding:8px 10px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:13px;
}

/* ===================== LOCATION ===================== */
.location-group{
  margin:8px 0;
}

.location-group label{
  font-size:12px;
  font-weight:600;
}

.location-group input{
  background:#f8fafc;
  border:1px solid #2563eb;
}

/* ===================== UTIL ===================== */
hr{
  border:none;
  border-top:1px solid #e5e7eb;
}

</style>  </head>  <body>  <div class="main">    <div class="top">  
    <h3>üöö Delivery Partner</h3>  
    <button class="icon-btn" onclick="openProfile()">  
      <i class="bi bi-person-circle"></i>  
    </button>  
  </div>    <div class="card active-card">
  <b>ID:</b> <span id="dbId"></span><br>
  <span class="badge green">ACTIVE</span>
</div> <div id="orders"></div>  
</div>  <!-- PROFILE MODAL -->
<div class="modal" id="profileModal">
 <div class="modal-box">
  <h3>üë§ Delivery Profile</h3>

  <input id="pName" placeholder="Full Name">
  <input id="pMobile" placeholder="Mobile Number">

  <select id="pVehicle">
   <option value="">Vehicle Type</option>
   <option value="two_wheeler">Two Wheeler</option>
   <option value="three_wheeler">Three Wheeler</option>
   <option value="four_wheeler">Four Wheeler</option>
  </select>

  <input id="pVehicleNo" placeholder="Vehicle Number">
  <input id="pCity" placeholder="City">

  <!-- ‚úÖ LIVE LOCATION -->
  <div class="location-group">
    <label>üìç Live Location (lat, lng)</label>
    <input id="pLocation" placeholder="Live location not set" readonly>
    <button class="btn accept" onclick="getLiveLocation()">üì° Set Live Location</button>
  </div>

  <button class="btn accept" onclick="saveProfile()">Save Profile</button>
  <button class="btn" onclick="closeProfile()">Close</button>
 </div>
</div>  <!-- DELIVERY CODE MODAL -->  <div class="modal" id="codeModal">  
 <div class="modal-box">  
  <h3>üîê Enter Delivery Code</h3>  
  <input id="deliveryCodeInput" placeholder="Enter delivery code">  
  <button class="btn done" onclick="submitDeliveryCode()">Submit</button>  
  <button class="btn" onclick="closeCodeModal()">Cancel</button>  
 </div>  
</div>  <script>  


// ================= CONFIG =================
const API="https://shopbacked-vmhs.onrender.com",DBID=localStorage.getItem("userId"),TOKEN=localStorage.getItem("token");
let lastOrders=[],currentOrderId=null,liveLat=null,liveLng=null;
dbId.innerText=DBID?DBID.slice(0,8).toUpperCase():"N/A";

// ================= HELPERS =================
const statusMap={paid:"Pending",pending:"Pending",delivery_accepted:"Assigned",assigned:"Assigned",picked_up:"Picked Up",delivery_code_generated:"Out for Delivery",delivered:"Delivered"};
const statusClass={paid:"status-pending",pending:"status-pending",delivery_accepted:"status-assigned",assigned:"status-assigned",picked_up:"status-delivered",delivery_code_generated:"status-delivered",delivered:"status-delivered"};
function getStatusHTML(s,t){return `<div class="status-line"><span class="status-box ${statusClass[s]||'status-default'}">${statusMap[s]||s.replace(/_/g,' ')}</span><span class="status-time">üïí ${t?new Date(t).toLocaleString():""}</span></div>`;}

// ================= PROFILE =================
async function openProfile(){profileModal.style.display="flex";try{const res=await fetch(`${API}/api/delivery/profile/${DBID}`,{headers:{"Authorization":"Bearer "+TOKEN}});const data=await res.json();if(!data.success||!data.profile)return;const p=data.profile;pName.value=p.name||"";pMobile.value=p.mobile||"";pVehicle.value=p.vehicle||"";pVehicleNo.value=p.vehicleNo||"";pCity.value=p.city||"";if(p.location){liveLat=p.location.lat;liveLng=p.location.lng;pLocation.value=`${liveLat.toFixed(6)}, ${liveLng.toFixed(6)}`;}}catch(e){console.error(e);alert("‚ùå Profile load failed");}}
function closeProfile(){profileModal.style.display="none";}
async function saveProfile(){if(!pMobile.value.trim()){alert("Mobile number required");return;}const payload={deliveryBoyId:DBID,name:pName.value.trim(),mobile:pMobile.value.trim(),vehicle:pVehicle.value,vehicleNo:pVehicleNo.value.trim(),city:pCity.value.trim(),location:liveLat&&liveLng?{lat:liveLat,lng:liveLng}:null};try{const res=await fetch(`${API}/api/delivery/profile/save`,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+TOKEN},body:JSON.stringify(payload)});const data=await res.json();if(data.success){localStorage.setItem("deliveryProfile_"+DBID,JSON.stringify(payload));alert("‚úÖ Profile + Live location saved");closeProfile();}else alert("‚ùå Profile save failed");}catch(e){alert("‚ùå Server error");}
function getLiveLocation(){if(!navigator.geolocation){alert("Geolocation not supported");return;}navigator.geolocation.getCurrentPosition(pos=>{liveLat=pos.coords.latitude;liveLng=pos.coords.longitude;pLocation.value=`${liveLat.toFixed(6)}, ${liveLng.toFixed(6)}`;fetch(`${API}/api/delivery/profile/save`,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+TOKEN},body:JSON.stringify({deliveryBoyId:DBID,location:{lat:liveLat,lng:liveLng}})});},err=>console.log("Location error:",err.message),{enableHighAccuracy:true,timeout:10000});}

// ================= ORDERS =================
async function loadOrders(){try{const res=await fetch(`${API}/api/orders/delivery/${DBID}`,{headers:{Authorization:"Bearer "+TOKEN}});const data=await res.json();lastOrders=(data.orders||[]).filter(o=>!o.deliveryBoyId||o.deliveryBoyId===DBID);renderOrders(lastOrders);}catch(e){orders.innerHTML="<p style='text-align:center;color:red'>Failed to load orders</p>";}}
function groupOrdersByCart(list){const map={};list.forEach(o=>{const key=o.cartGroupId||o._id;if(!map[key])map[key]={...o,key,products:[]};map[key].products.push(o);});return Object.values(map);}
function renderOrders(list){if(!list.length){orders.innerHTML="<p style='text-align:center'>No Orders</p>";return;}orders.innerHTML=groupOrdersByCart(list).map(o=>`<div class="card order">${getStatusHTML(o.status,o.time)}<hr><b>üì¶ Products:</b><ul>${o.products.map(p=>`<li>${p.productName}</li>`).join("")}</ul><hr>üè™ <b>Wholesaler:</b> ${o.wholesalerName}<br>üìû ${o.wholesalerMobile||"N/A"}<br><br>üè¨ <b>Retailer:</b> ${o.retailerName}<br>üìû ${o.retailerMobile||"N/A"}<br><br>üöó <b>Vehicle:</b> ${o.vehicleType==="two_wheeler"?"Two Wheeler":o.vehicleType==="three_wheeler"?"Three Wheeler":o.vehicleType==="four_wheeler"?"Four Wheeler":"N/A"}<br><br>${o.status==="paid"?`<button class="btn accept" onclick="acceptOrder('${o.key}')">Accept</button>`:""}${o.status==="delivery_accepted"?`<button class="btn pickup" onclick="pickupOrder('${o.key}')">Pickup</button>`:""}${o.status==="picked_up"?`<button class="btn pickup" onclick="deliverFlow('${o.key}')">Generate Code</button>`:""}${o.status==="delivery_code_generated"?`<button class="btn done" onclick="deliverFlow('${o.key}')">Delivered</button>`:""}</div>`).join("");}

// ================= ACTIONS =================
async function acceptOrder(id){const p=JSON.parse(localStorage.getItem("deliveryProfile_"+DBID)||"{}");await fetch(`${API}/api/orders/${id}/delivery-accept`,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+TOKEN},body:JSON.stringify({deliveryBoyId:DBID,deliveryBoyName:p.name||"Delivery Partner",deliveryBoyMobile:p.mobile||""})});loadOrders();}
async function pickupOrder(id){const p=JSON.parse(localStorage.getItem("deliveryProfile_"+DBID)||"{}");const res=await fetch(`${API}/api/orders/${id}/pickup`,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+TOKEN},body:JSON.stringify({deliveryBoyId:DBID,deliveryBoyName:p.name||"Delivery Partner",deliveryBoyMobile:p.mobile||""})});const data=await res.json();alert(data.success?"‚úÖ Order picked up":(data.message||"Pickup failed ‚ùå"));loadOrders();}
async function deliverFlow(id){const order=lastOrders.find(o=>o._id===id);if(!order){alert("Order not found");return;}if(order.status==="picked_up"){const res=await fetch(`${API}/api/orders/generate-delivery-code/${id}`,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+TOKEN},body:JSON.stringify({deliveryBoyId:DBID})});const data=await res.json();alert(data.success?"üîê Code generated & sent to retailer":(data.message||"Code generation failed"));loadOrders();return;}if(order.status==="delivery_code_generated"){currentOrderId=id;deliveryCodeInput.value="";codeModal.style.display="flex";return;}alert("‚ùå Order not ready for delivery");}
async function submitDeliveryCode(){const code=deliveryCodeInput.value.trim();if(!code)return alert("Enter delivery code");const res=await fetch(`${API}/api/orders/verify-delivery-code/${currentOrderId}`,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+TOKEN},body:JSON.stringify({code,deliveryBoyId:DBID})});const data=await res.json();if(data.success){alert("‚úÖ Order delivered");closeCodeModal();loadOrders();return;}if(data.message?.includes("expired")){alert(data.message);closeCodeModal();loadOrders();return;}alert("‚ùå Wrong code");}
function closeCodeModal(){codeModal.style.display="none";}

// ================= FCM PUSH =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

const firebaseConfig={apiKey:"AIzaSyBioiLSE3HyZh49yJv93MwnQFrmAm6wJ5g",authDomain:"shop-ab586.firebaseapp.com",projectId:"shop-ab586",messagingSenderId:"603669325846",appId:"1:603669325846:web:00f3ccff7fa977bf542d37"};
const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

// Service Worker registration
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("/firebase-messaging-sw.js")
    .then(()=>console.log("‚úÖ Service Worker Registered"))
    .catch(err=>console.error("‚ùå SW Registration Error",err));
}

// Init FCM for delivery dashboard
async function initFCM(){
  if(!DBID || localStorage.getItem("role")!=="delivery") return;
  const permission = await Notification.requestPermission();
  if(permission!=="granted"){console.log("‚ùå Notification permission denied"); return;}
  const fcmToken = await getToken(messaging,{vapidKey:"BFcKfbosO2sXWogZ5fBBt31vEkw_1iwgQWVrZjAJ90pXdhdFBSbXM_Oppuoxm-QIidekMzIQdcl3XrJy0ltkC8s"});
  if(!fcmToken){console.log("‚ùå FCM Token not generated"); return;}
  console.log("üî• DELIVERY FCM TOKEN:",fcmToken);
  await fetch(`${API}/api/notifications/saveToken`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:DBID,role:"delivery",fcmToken})});
}

// Foreground notifications
onMessage(messaging,payload=>{alert("üì© New Order: "+payload.notification?.title);loadOrders();});

// ================= INIT =================
window.addEventListener("load",()=>{
  loadOrders();
  setInterval(loadOrders,8000);
  setInterval(getLiveLocation,15000);
  initFCM();
});
    
  

  

  </script>

</body>  
</html>
