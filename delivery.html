<!DOCTYPE html>  <html lang="en">  
<head>  
<meta charset="UTF-8">  
<title>Delivery Partner Dashboard</title>  
<meta name="viewport" content="width=device-width, initial-scale=1.0">  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">  
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">  <style>  
*{box-sizing:border-box;font-family:Poppins,sans-serif}  
body{margin:0;background:#eef2f7}  
.main{max-width:900px;margin:auto;padding:16px}  
  
.top{  
 background:#0f172a;color:#fff;  
 display:flex;justify-content:space-between;align-items:center;  
 padding:14px;border-radius:16px  
}  
.icon-btn{  
 background:#2563eb;border:none;color:#fff;  
 width:44px;height:44px;border-radius:50%;  
 font-size:20px;cursor:pointer  
}  
  
.card{  
 background:#fff;margin-top:14px;padding:14px;  
 border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08)  
}  
  
.order{  
 display:flex;gap:12px;margin-top:12px  
}  
.order img{  
 width:90px;height:80px;object-fit:cover;border-radius:10px  
}  
  
.badge{  
 padding:4px 10px;border-radius:20px;  
 font-size:12px;display:inline-block  
}  
.green{background:#dcfce7;color:#166534}  
.blue{background:#e0f2fe;color:#075985}  
  
.btn{  
 display:inline-flex;align-items:center;gap:6px;  
 padding:8px 14px;border:none;border-radius:10px;  
 cursor:pointer;margin-top:8px;font-size:13px  
}  
.accept{background:#16a34a;color:#fff}  
.pickup{background:#f59e0b;color:#fff}  
.done{background:#2563eb;color:#fff}  
  
/* MODALS */  
.modal{  
 position:fixed;inset:0;background:rgba(0,0,0,.5);  
 display:none;align-items:center;justify-content:center;z-index:20  
}  
.modal-box{  
 background:#fff;width:92%;max-width:420px;  
 border-radius:16px;padding:20px  
}  
.modal-box input,select{  
 width:100%;padding:10px;margin:8px 0;  
 border-radius:10px;border:1px solid #ccc  
}  
  /* ===== LIVE LOCATION ===== */
.location-group{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin:12px 0;
}

.location-group label{
  font-size:13px;
  color:#0f172a;
  font-weight:600;
}

.location-group input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #2563eb;
  background:#f8fafc;
  font-size:13px;
}
</style>  </head>  <body>  <div class="main">    <div class="top">  
    <h3>üöö Delivery Partner</h3>  
    <button class="icon-btn" onclick="openProfile()">  
      <i class="bi bi-person-circle"></i>  
    </button>  
  </div>    <div class="card">  
    <b>ID:</b> <span id="dbId"></span><br>  
    <span class="badge green">ACTIVE</span>  
  </div>    <div id="orders"></div>  
</div>  <!-- PROFILE MODAL -->
<div class="modal" id="profileModal">
 <div class="modal-box">
  <h3>üë§ Delivery Profile</h3>

  <input id="pName" placeholder="Full Name">
  <input id="pMobile" placeholder="Mobile Number">

  <select id="pVehicle">
   <option value="">Vehicle Type</option>
   <option value="two_wheeler">Two Wheeler</option>
   <option value="three_wheeler">Three Wheeler</option>
   <option value="four_wheeler">Four Wheeler</option>
  </select>

  <input id="pVehicleNo" placeholder="Vehicle Number">
  <input id="pCity" placeholder="City">

  <!-- ‚úÖ LIVE LOCATION -->
  <div class="location-group">
    <label>üìç Live Location (lat, lng)</label>
    <input id="pLocation" placeholder="Live location not set" readonly>
    <button class="btn accept" onclick="getLiveLocation()">üì° Set Live Location</button>
  </div>

  <button class="btn accept" onclick="saveProfile()">Save Profile</button>
  <button class="btn" onclick="closeProfile()">Close</button>
 </div>
</div>  <!-- DELIVERY CODE MODAL -->  <div class="modal" id="codeModal">  
 <div class="modal-box">  
  <h3>üîê Enter Delivery Code</h3>  
  <input id="deliveryCodeInput" placeholder="Enter delivery code">  
  <button class="btn done" onclick="submitDeliveryCode()">Submit</button>  
  <button class="btn" onclick="closeCodeModal()">Cancel</button>  
 </div>  
</div>  <script>  
const API = "https://shopbacked-vmhs.onrender.com";  
const DBID = localStorage.getItem("userId");  
const TOKEN = localStorage.getItem("token");  
  
let lastOrders = [];  
let currentOrderId = null;  
  
dbId.innerText = DBID ? DBID.slice(0,8).toUpperCase() : "N/A";  
  
/* PROFILE */  
  
async function openProfile(){  
  profileModal.style.display = "flex";  
  
  try{  
    const res = await fetch(
      `${API}/api/delivery/profile/${DBID}`,
      {
        headers:{ "Authorization":"Bearer "+TOKEN }
      }
    );  
  
    const data = await res.json();  
    if(!data.success || !data.profile) return;  
  
    const p = data.profile;  

    // BASIC DETAILS
    pName.value      = p.name || "";  
    pMobile.value    = p.mobile || "";  
    pVehicle.value   = p.vehicle || "";  
    pVehicleNo.value = p.vehicleNo || "";  
    pCity.value      = p.city || "";  

    // ‚úÖ LIVE LOCATION LOAD
    if(p.location && p.location.lat && p.location.lng){
      liveLat = p.location.lat;
      liveLng = p.location.lng;

      document.getElementById("pLocation").value =
        liveLat.toFixed(6) + ", " + liveLng.toFixed(6);
    }else{
      document.getElementById("pLocation").value = "";
      liveLat = null;
      liveLng = null;
    }

  }catch(err){  
    console.error("Open profile error:", err);  
    alert("‚ùå Profile load failed");
  }  
}
  
  
  
async function saveProfile(){    

  if(!pMobile.value.trim()){    
    alert("Mobile number required");    
    return;    
  }    

  const payload = {    
    deliveryBoyId: DBID,  
    name: pName.value.trim(),    
    mobile: pMobile.value.trim(),    
    vehicle: pVehicle.value,    
    vehicleNo: pVehicleNo.value.trim(),    
    city: pCity.value.trim(),
    location: liveLat && liveLng ? {
      lat: liveLat,
      lng: liveLng
    } : null
  };    

  try{    
    const res = await fetch(`${API}/api/delivery/profile/save`,{    
      method:"POST",    
      headers:{    
        "Content-Type":"application/json",    
        "Authorization":"Bearer "+TOKEN    
      },    
      body: JSON.stringify(payload)    
    });    

    const data = await res.json();    

    if(data.success){

      localStorage.setItem(
        "deliveryProfile_"+DBID,
        JSON.stringify(payload)
      );

      alert("‚úÖ Profile + Live location saved");
      closeProfile();

    }else{
      alert("‚ùå Profile save failed");
    }    

  }catch(err){    
    alert("‚ùå Server error");    
  }    
}
        
  
window.closeProfile = function(){  
  const modal = document.getElementById("profileModal");  
  if(modal){  
    modal.style.display = "none";  
  }  
}  

  let liveLat = null;
let liveLng = null;

function getLiveLocation(){
  if(!navigator.geolocation){
    alert("‚ùå Location not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos=>{
      liveLat = pos.coords.latitude;
      liveLng = pos.coords.longitude;

      document.getElementById("pLocation").value =
        liveLat.toFixed(6) + ", " + liveLng.toFixed(6);
    },
    err=>{
      alert("‚ùå Location permission denied");
    },
    { enableHighAccuracy:true }
  );
}
   
/* LOAD ORDERS */  
async function loadOrders(){  
 try{  
  const res = await fetch(`${API}/api/orders/delivery/${DBID}`,{  
    headers:{ Authorization:"Bearer "+TOKEN }  
  });  
  const data = await res.json();  
  // ‚úÖ Only show unassigned orders or assigned to current delivery boy  
  lastOrders = (data.orders || []).filter(o => !o.deliveryBoyId || o.deliveryBoyId === DBID);  
  renderOrders(lastOrders);  
 }catch(err){  
  orders.innerHTML="<p style='text-align:center;color:red'>Failed to load orders</p>";  
 }  
}  
  
/* RENDER ORDERS */  
function renderOrders(list){  
 if(!list.length){  
  orders.innerHTML="<p style='text-align:center'>No Orders</p>";  
  return;  
 }  
  
 orders.innerHTML = list.map(o=>`  
 <div class="card order">  
  <img src="${o.productImg}">  
  <div style="flex:1">  
   <b>${o.productName}</b><br>  
   <span class="badge blue">${o.status}</span><br>  
   <small>${o.statusHistory[o.statusHistory.length-1]?.time ? new Date(o.statusHistory[o.statusHistory.length-1].time).toLocaleString() : ""}</small><br><br>  
   üè™ <b>Wholesaler:</b> ${o.wholesalerName}<br>  
   üìç ${o.wholesalerAddress || "Address N/A"}<br>  
   üìû ${o.wholesalerMobile || "N/A"}<br><br>  
   üè¨ <b>Retailer:</b> ${o.retailerName}<br>  
   üìç ${o.retailerAddress || "Address N/A"}<br>  
   üìû ${o.retailerMobile || "N/A"}<br><br>  
   üöó <b>Vehicle:</b> ${o.vehicleType==="two_wheeler"?"Two Wheeler":o.vehicleType==="three_wheeler"?"Three Wheeler":o.vehicleType==="four_wheeler"?"Four Wheeler":"N/A"}<br><br>  
  
        ${o.status==="paid"
  ? `<button class="btn accept" onclick="acceptOrder('${o._id}')">Accept</button>`:""}

${o.status==="delivery_accepted"
  ? `<button class="btn pickup" onclick="pickupOrder('${o._id}')">Pickup</button>`:""}

${o.status==="picked_up"
  ? `<button class="btn pickup" onclick="deliverFlow('${o._id}')">Generate Code</button>`:""}

${o.status==="delivery_code_generated"
  ? `<button class="btn done" onclick="deliverFlow('${o._id}')">Delivered</button>`:""}
      </div>
    </div>
  `).join("");
}  
  
/* ACTIONS */  
async function acceptOrder(id){  
 const p = JSON.parse(localStorage.getItem("deliveryProfile_"+DBID)||"{}");  
 await fetch(`${API}/api/orders/${id}/delivery-accept`,{  
  method:"POST",  
  headers:{ "Content-Type":"application/json","Authorization":"Bearer "+TOKEN },  
  body:JSON.stringify({ deliveryBoyId:DBID,deliveryBoyName:p.name||"Delivery Partner",deliveryBoyMobile:p.mobile||"" })  
 });  
 loadOrders();  
}  
// pickupOrder
async function pickupOrder(orderId){
  const p = JSON.parse(localStorage.getItem("deliveryProfile_"+DBID)||"{}");

  const res = await fetch(`${API}/api/orders/${orderId}/pickup`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+TOKEN
    },
    body: JSON.stringify({
      deliveryBoyId: DBID,
      deliveryBoyName: p.name || "Delivery Partner",
      deliveryBoyMobile: p.mobile || ""
    })
  });

  const data = await res.json();
  if(data.success){
    alert("Order picked up ‚úÖ");
    loadOrders();
  }else{
    alert(data.message || "Pickup failed ‚ùå");
  }
}
  
/* DELIVERY FLOW */  
async function deliverFlow(orderId){
  const order = lastOrders.find(o => o._id === orderId);
  if(!order){
    alert("Order not found");
    return;
  }

  // üîπ STEP 1: GENERATE DELIVERY CODE
  if(order.status === "picked_up"){
    try{
      const res = await fetch(
        `${API}/api/orders/generate-delivery-code/${orderId}`,
        {
          method: "POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer " + TOKEN
          },
          body: JSON.stringify({
            deliveryBoyId: DBID   // ‚úÖ MUST
          })
        }
      );

      const data = await res.json();

      if(data.success){
        alert("üîê Delivery code generated & sent to retailer");
        loadOrders(); // refresh
        return;
      }else{
        alert(data.message || "‚ùå Code generation failed");
        return;
      }

    }catch(err){
      console.error(err);
      alert("‚ùå Server error while generating code");
      return;
    }
  }

  // üîπ STEP 2: VERIFY DELIVERY CODE
  if(order.status === "delivery_code_generated"){
    currentOrderId = orderId;
    deliveryCodeInput.value = "";
    codeModal.style.display = "flex";
    return;
  }

  alert("‚ùå Order not ready for delivery");
}
  
async function submitDeliveryCode(){  
  const code = deliveryCodeInput.value.trim();  
  if(!code) return alert("Enter delivery code");  

  const res = await fetch(`${API}/api/orders/verify-delivery-code/${currentOrderId}`,{
    method:"POST",
    headers:{ 
      "Content-Type":"application/json",
      "Authorization":"Bearer "+TOKEN 
    },
    body: JSON.stringify({
  code,
  deliveryBoyId: DBID
})
  });  

  const data = await res.json();  

  // ‚úÖ SUCCESS ‚Üí DELIVERED
  if(data.success){
    alert("‚úÖ Order delivered successfully");
    closeCodeModal();
    loadOrders();
    return;
  }

  // ‚è±Ô∏è CODE EXPIRED ‚Üí AUTO SHOW GENERATE BUTTON
  if(data.message && data.message.includes("expired")){
    alert(data.message);              // "Delivery code expired..."
    closeCodeModal();
    loadOrders();                     // üî• status ‚Üí picked_up
    return;
  }

  // ‚ùå WRONG CODE
  alert("‚ùå Wrong delivery code");
}
  
function closeCodeModal(){ codeModal.style.display="none"; }  
  
/* INIT */  
loadOrders();  
setInterval(loadOrders,8000);  
</script>  </body>  
</html>
