<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Delivery Partner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif;margin:0;padding:0;}
body{background:#eef2f7;}

/* ===================== MAIN ===================== */
.main{
  max-width:900px;
  margin:0 auto;
  padding:14px;
  padding-top:calc(14px + 160px);
}

/* ===================== TOP BAR ===================== */
.top{
  position: fixed;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  width: calc(100% - 24px);
  max-width: 900px;
  background:#0f172a;
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px;
  border-radius:16px;
  z-index:100;
}
.icon-btn{
  background:#2563eb;
  border:none;
  color:#fff;
  width:42px;
  height:42px;
  border-radius:50%;
  font-size:20px;
  cursor:pointer;
}

/* ===================== ACTIVE CARD ===================== */
.active-card{
  position: fixed;
  top: 86px;
  left: 50%;
  transform: translateX(-50%);
  width: calc(100% - 24px);
  max-width: 900px;
  background:#ffffff;
  padding:10px 14px;
  border-radius:14px;
  box-shadow:0 4px 14px rgba(0,0,0,.08);
  z-index:90;
}

/* ===================== ORDER CARD ===================== */
.card.order{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-bottom:12px;
  padding:12px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 3px 10px rgba(0,0,0,.05);
}

/* ===================== STATUS WRAPPER ===================== */
.status-line{
  display:flex;
  align-items:center;
  gap:6px;
  flex-wrap:wrap;
}
.status-box{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:3px 8px;
  font-size:11px;
  font-weight:600;
  border-radius:999px;
  white-space:nowrap;
  line-height:1;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
}
/* STATUS COLORS */
.status-pending{background:#fff1e6;color:#9a3412;border:1px solid #fdba74;}
.status-assigned{background:#e8f2ff;color:#1e40af;border:1px solid #93c5fd;}
.status-delivered{background:#e7f9ef;color:#166534;border:1px solid #86efac;}
.status-default{background:#f3f4f6;color:#374151;border:1px solid #d1d5db;}

/* ===================== PRODUCTS ===================== */
.card.order ul{margin-left:18px;}
.card.order li{font-size:13.5px;line-height:1.5;}

/* ===================== BUTTONS ===================== */
.btn{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:12.5px;
  font-weight:500;
}
.btn.accept{background:#16a34a;color:#fff;}
.btn.pickup{background:#f59e0b;color:#fff;}
.btn.done{background:#2563eb;color:#fff;}

/* ===================== MODAL ===================== */
.modal{
  position:fixed;
  top:160px;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:flex-start;
  justify-content:center;
  overflow-y:auto;
  z-index:200;
}
.modal-box{
  background:#fff;
  width:90%;
  max-width:320px;
  border-radius:14px;
  padding:14px;
  box-shadow:0 6px 20px rgba(0,0,0,.2);
  margin-top:12px;
}
.modal-box h3{font-size:16px;margin-bottom:10px;}
.modal-box input,
.modal-box select{
  width:100%;
  padding:8px 10px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:13px;
}
.location-group{margin:8px 0;}
.location-group label{font-size:12px;font-weight:600;}
.location-group input{background:#f8fafc;border:1px solid #2563eb;}
hr{border:none;border-top:1px solid #e5e7eb;}
</style>
</head>
<body>

<div class="main">
  <div class="top">
    <h3>üöö Delivery Partner</h3>
    <button class="icon-btn" onclick="openProfile()">
      <i class="bi bi-person-circle"></i>
    </button>
  </div>

  <div class="card active-card">
    <b>ID:</b> <span id="dbId"></span><br>
    <span class="badge green">ACTIVE</span>
  </div>

  <div id="orders"></div>
</div>

<!-- PROFILE MODAL -->
<div class="modal" id="profileModal">
 <div class="modal-box">
  <h3>üë§ Delivery Profile</h3>
  <input id="pName" placeholder="Full Name">
  <input id="pMobile" placeholder="Mobile Number">
  <select id="pVehicle">
   <option value="">Vehicle Type</option>
   <option value="two_wheeler">Two Wheeler</option>
   <option value="three_wheeler">Three Wheeler</option>
   <option value="four_wheeler">Four Wheeler</option>
  </select>
  <input id="pVehicleNo" placeholder="Vehicle Number">
  <input id="pCity" placeholder="City">

  <div class="location-group">
    <label>üìç Live Location (lat, lng)</label>
    <input id="pLocation" placeholder="Live location not set" readonly>
    <button class="btn accept" onclick="getLiveLocation()">üì° Set Live Location</button>
  </div>

  <button class="btn accept" onclick="saveProfile()">Save Profile</button>
  <button class="btn" onclick="closeProfile()">Close</button>
 </div>
</div>

<!-- DELIVERY CODE MODAL -->
<div class="modal" id="codeModal">
 <div class="modal-box">
  <h3>üîê Enter Delivery Code</h3>
  <input id="deliveryCodeInput" placeholder="Enter delivery code">
  <button class="btn done" onclick="submitDeliveryCode()">Submit</button>
  <button class="btn" onclick="closeCodeModal()">Cancel</button>
 </div>
</div>

<script>
const API = "https://shopbacked-vmhs.onrender.com";
const DBID = localStorage.getItem("userId");
const TOKEN = localStorage.getItem("token");
const orders = document.getElementById("orders");

let lastOrders = [];
let currentOrderId = null;

dbId.innerText = DBID ? DBID.slice(0,8).toUpperCase() : "N/A";

/* ===================== STATUS FUNCTIONS ===================== */
function getStatusClass(status){
  if(status==="paid"||status==="pending") return "status-pending";
  if(status==="delivery_accepted"||status==="assigned") return "status-assigned";
  if(status==="picked_up"||status==="delivery_code_generated"||status==="delivered") return "status-delivered";
  return "status-default";
}
function getStatusText(status){
  if(status==="paid"||status==="pending") return "Pending";
  if(status==="delivery_accepted"||status==="assigned") return "Assigned";
  if(status==="picked_up") return "Picked Up";
  if(status==="delivery_code_generated") return "Out for Delivery";
  if(status==="delivered") return "Delivered";
  return status.replace(/_/g," ");
}
function getStatusHTML(status,time){
  const cls = getStatusClass(status);
  const txt = getStatusText(status);
  return `<div class="status-line">
    <span class="status-box ${cls}">${txt}</span>
    <span class="status-time">üïí ${time?new Date(time).toLocaleString():""}</span>
  </div>`;
}

/* ===================== RENDER ORDERS ===================== */
function groupOrdersByCart(orders){
  const map={};
  orders.forEach(o=>{
    const key=o.cartGroupId||o._id;
    if(!map[key]){
      map[key]={key,status:o.status,time:o.statusHistory?.[0]?.time||o.createdAt,retailerName:o.retailerName,retailerMobile:o.retailerMobile,wholesalerName:o.wholesalerName,wholesalerMobile:o.wholesalerMobile,vehicleType:o.vehicleType,deliveryBoyId:o.deliveryBoyId,products:[]};
    }
    map[key].products.push(o);
  });
  return Object.values(map);
}
function renderOrders(list){
  if(!list.length){orders.innerHTML="<p style='text-align:center'>No Orders</p>";return;}
  const grouped = groupOrdersByCart(list);
  orders.innerHTML = grouped.map(o=>{
    return `<div class="card order">
      ${getStatusHTML(o.status,o.time)}
      <hr>
      <b>üì¶ Products:</b>
      <ul>${o.products.map(p=>`<li>${p.productName}</li>`).join("")}</ul>
      <hr>
      üè™ <b>Wholesaler:</b> ${o.wholesalerName}<br>üìû ${o.wholesalerMobile||"N/A"}<br><br>
      üè¨ <b>Retailer:</b> ${o.retailerName}<br>üìû ${o.retailerMobile||"N/A"}<br><br>
      üöó <b>Vehicle:</b> ${o.vehicleType==="two_wheeler"?"Two Wheeler":o.vehicleType==="three_wheeler"?"Three Wheeler":o.vehicleType==="four_wheeler"?"Four Wheeler":"N/A"}<br><br>
      ${o.status==="paid"?`<button class="btn accept" onclick="acceptOrder('${o.key}')">Accept</button>`:""}
      ${o.status==="delivery_accepted"?`<button class="btn pickup" onclick="pickupOrder('${o.key}')">Pickup</button>`:""}
      ${o.status==="picked_up"?`<button class="btn pickup" onclick="deliverFlow('${o.key}')">Generate Code</button>`:""}
      ${o.status==="delivery_code_generated"?`<button class="btn done" onclick="deliverFlow('${o.key}')">Delivered</button>`:""}
    </div>`;
  }).join("");
}

/* ===================== ACTIONS ===================== */
window.acceptOrder = async function(id){
  const p = JSON.parse(localStorage.getItem("deliveryProfile_"+DBID)||"{}");
  await fetch(`${API}/api/orders/${id}/delivery-accept`,{
    method:"POST",
    headers:{"Content-Type":"application/json","Authorization":"Bearer "+TOKEN},
    body:JSON.stringify({deliveryBoyId:DBID,deliveryBoyName:p.name||"Delivery Partner",deliveryBoyMobile:p.mobile||""})
  });
  loadOrders();
}
window.pickupOrder = async function(id){
  const p = JSON.parse(localStorage.getItem("deliveryProfile_"+DBID)||"{}");
  const res = await fetch(`${API}/api/orders/${id}/pickup`,{
    method:"POST",
    headers:{"Content-Type":"application/json","Authorization":"Bearer "+TOKEN},
    body:JSON.stringify({deliveryBoyId:DBID,deliveryBoyName:p.name||"Delivery Partner",deliveryBoyMobile:p.mobile||""})
  });
  const data = await res.json();
  if(data.success){alert("Order picked up ‚úÖ");loadOrders();}else{alert(data.message||"Pickup failed ‚ùå");}
}
window.deliverFlow = async function(orderId){
  alert("Delivery code workflow (use previous functions)");
}

/* ===================== PROFILE MODAL ===================== */
window.openProfile = function(){document.getElementById("profileModal").style.display="flex";}
window.closeProfile = function(){document.getElementById("profileModal").style.display="none";}
function closeCodeModal(){document.getElementById("codeModal").style.display="none";}

/* ===================== LOAD ORDERS ===================== */
async function loadOrders(){
  try{
    const res = await fetch(`${API}/api/orders/delivery/${DBID}`,{headers:{Authorization:"Bearer "+TOKEN}});
    const data = await res.json();
    lastOrders = (data.orders||[]).filter(o=>!o.deliveryBoyId||o.deliveryBoyId===DBID);
    renderOrders(lastOrders);
  }catch(err){
    orders.innerHTML="<p style='text-align:center;color:red'>Failed to load orders</p>";
  }
}
loadOrders();
setInterval(loadOrders,8000);
</script>

</body>
</html>
