<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Delivery Boy Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- GOOGLE FONT -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<!-- BOOTSTRAP ICONS (IMPORTANT) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:15px;max-width:900px;margin:auto}

.top-bar{
 display:flex;justify-content:space-between;align-items:center;
 background:#0f172a;color:#fff;padding:12px 16px;border-radius:14px
}
.icon-btn{
 background:#2563eb;border:none;color:#fff;
 width:42px;height:42px;border-radius:50%;
 font-size:20px;cursor:pointer
}

.status-box,.order-card{
 background:#fff;margin-top:12px;padding:12px;
 border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08)
}

.order-card{display:flex;gap:10px}
.order-card img{
 width:80px;height:70px;object-fit:cover;border-radius:8px
}

.action-btn{
 display:inline-flex;align-items:center;gap:6px;
 border:none;padding:7px 12px;border-radius:8px;
 cursor:pointer;margin-top:6px;font-size:13px
}
.accept{background:#16a34a;color:#fff}
.pickup{background:#f59e0b;color:#fff}
.submit{background:#2563eb;color:#fff}

.submit-code{
 display:flex;gap:6px;margin-top:6px
}
.submit-code input{
 flex:1;padding:6px;border-radius:6px;border:1px solid #ccc
}

/* MODAL */
.modal{
 position:fixed;inset:0;background:rgba(0,0,0,.5);
 display:none;align-items:center;justify-content:center;z-index:50
}
.modal-content{
 background:#fff;padding:20px;border-radius:14px;
 width:90%;max-width:400px
}
input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc}
</style>
</head>

<body>
<div class="main">

<div class="top-bar">
 <h3>üöö Delivery Dashboard</h3>
 <div>
  <button class="icon-btn" onclick="updateLocation()">
   <i class="bi bi-geo-alt-fill"></i>
  </button>
  <button class="icon-btn" onclick="openProfile()">
   <i class="bi bi-person-circle"></i>
  </button>
 </div>
</div>

<div class="status-box">
 <b>ID:</b> <span id="dbId"></span><br>
 <b>Status:</b> üü¢ ACTIVE<br>
 <small id="locText">üìç Location not set</small>
</div>

<div id="orders"></div>
</div>

<!-- PROFILE MODAL -->
<div class="modal" id="profileModal">
 <div class="modal-content">
  <h3>Delivery Profile</h3>
  <input id="dbName" placeholder="Full Name">
  <input id="dbMobile" placeholder="Mobile Number">
  <button class="action-btn accept" onclick="saveProfile()">
   <i class="bi bi-save"></i> Save
  </button>
 </div>
</div>

<script>
const API="https://shopbacked-vmhs.onrender.com";
const TOKEN=localStorage.getItem("token");
const DBID=localStorage.getItem("userId");
const ROLE=localStorage.getItem("role");

if(!DBID||ROLE!=="delivery"){
 alert("Login again");location.href="index.html";
}

dbId.innerText=DBID.substring(0,8).toUpperCase();

/* PROFILE */
function openProfile(){
 profileModal.style.display="flex";
 const p=JSON.parse(localStorage.getItem("deliveryProfile_"+DBID)||"{}");
 dbName.value=p.name||"";
 dbMobile.value=p.mobile||"";
}
function saveProfile(){
 localStorage.setItem(
  "deliveryProfile_"+DBID,
  JSON.stringify({name:dbName.value,mobile:dbMobile.value})
 );
 alert("Profile Saved");
 profileModal.style.display="none";
}

/* LOCATION */
function updateLocation(){
 navigator.geolocation.getCurrentPosition(pos=>{
  locText.innerText=`üìç ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
 });
}

/* LOAD ORDERS */
async function loadOrders(){
 const res=await fetch(API+"/api/orders/delivery/available",{
  headers:{Authorization:"Bearer "+TOKEN}
 });
 const data=await res.json();
 renderOrders(data.orders||[]);
}

function renderOrders(list){
 orders.innerHTML=list.map(o=>`
 <div class="order-card">
  <img src="${o.productImg}">
  <div style="flex:1">
   <b>${o.productName}</b> ‚Çπ${o.price}<br>
   üè™ ${o.wholesalerName}<br>
   üè¨ ${o.retailerName}<br>
   üöö Vehicle: ${o.vehicleType}<br>
   <b>Status:</b> ${o.status}<br>

   ${o.status==="confirmed_by_wholesaler"?`
    <button class="action-btn accept" onclick="acceptOrder('${o._id}')">
     <i class="bi bi-check-circle-fill"></i> Accept
    </button>`:""}

   ${o.status==="delivery_accepted"?`
    <button class="action-btn pickup" onclick="pickupOrder('${o._id}')">
     <i class="bi bi-box-seam-fill"></i> Pickup
    </button>`:""}

   ${o.status==="picked_up"?`
    <div class="submit-code">
     <input id="code_${o._id}" placeholder="Delivery Code">
     <button class="action-btn submit" onclick="deliver('${o._id}')">
      <i class="bi bi-check2-circle"></i>
     </button>
    </div>`:""}
  </div>
 </div>
 `).join("") || "<p>No Orders</p>";
}

/* ACTIONS */
async function acceptOrder(id){
 await fetch(API+"/api/orders/"+id+"/delivery-accept",{method:"POST"});
 loadOrders();
}
async function pickupOrder(id){
 await fetch(API+"/api/orders/"+id+"/pickup",{method:"POST"});
 loadOrders();
}
async function deliver(id){
 const code=document.getElementById("code_"+id).value;
 await fetch(API+"/api/orders/"+id+"/delivered",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({code})
 });
 loadOrders();
}

loadOrders();
setInterval(loadOrders,8000);
</script>
</body>
</html>
