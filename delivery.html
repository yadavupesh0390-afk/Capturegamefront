<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Delivery Partner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#eef2f7}
.main{max-width:900px;margin:auto;padding:16px}

.top{
 background:#0f172a;color:#fff;
 display:flex;justify-content:space-between;align-items:center;
 padding:14px;border-radius:16px
}
.icon-btn{
 background:#2563eb;border:none;color:#fff;
 width:44px;height:44px;border-radius:50%;
 font-size:20px;cursor:pointer
}
.card{
 background:#fff;margin-top:14px;padding:14px;
 border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08)
}
.order{display:flex;gap:12px;margin-top:12px}
.order img{width:90px;height:80px;object-fit:cover;border-radius:10px}

.badge{
 padding:4px 10px;border-radius:20px;
 font-size:12px;display:inline-block
}
.blue{background:#e0f2fe;color:#075985}
.green{background:#dcfce7;color:#166534}

.btn{
 padding:8px 14px;border:none;border-radius:10px;
 cursor:pointer;margin-top:8px;font-size:13px
}
.accept{background:#16a34a;color:#fff}
.pickup{background:#f59e0b;color:#fff}
.done{background:#2563eb;color:#fff}
</style>
</head>

<body>
<div class="main">

<!-- HEADER -->
<div class="top">
 <h3>üöö Delivery Partner</h3>
 <button class="icon-btn" onclick="openProfile()">
  <i class="bi bi-person-circle"></i>
 </button>
</div>

<!-- INFO -->
<div class="card">
 <b>ID:</b> <span id="dbId"></span><br>
 <span class="badge green">ACTIVE</span>
</div>

<!-- ORDERS -->
<div id="orders"></div>

</div>

<script>
const API="https://shopbacked-vmhs.onrender.com";
const DBID=localStorage.getItem("userId");
const TOKEN=localStorage.getItem("token");

dbId.innerText = DBID ? DBID.slice(0,8).toUpperCase() : "N/A";

/* LOAD ORDERS */
async function loadOrders(){
 const res = await fetch(`${API}/api/orders/delivery/${DBID}`,{
  headers:{ "Authorization":"Bearer "+TOKEN }
 });
 const data = await res.json();
 renderOrders(data.orders || []);
}

/* RENDER ORDERS */
function renderOrders(list){
 if(!list.length){
  orders.innerHTML="<p style='text-align:center'>No Orders</p>";
  return;
 }

 orders.innerHTML=list.map(o=>`
 <div class="card order">
  <img src="${o.productImg}">
  <div style="flex:1">
   <b>${o.productName}</b> ‚Çπ${o.price}<br><br>

   üè™ ${o.wholesalerName}<br>
   üìû ${o.wholesalerMobile}<br><br>

   üè¨ ${o.retailerName}<br>
   üìû ${o.retailerMobile}<br><br>

   <span class="badge blue">${o.status}</span><br>

   ${o.status==="confirmed_by_wholesaler"
     ? `<button class="btn accept" onclick="acceptOrder('${o._id}')">Accept</button>` : ""}

   ${o.status==="delivery_accepted"
     ? `<button class="btn pickup" onclick="pickupOrder('${o._id}')">Pickup</button>` : ""}

   ${o.status==="picked_up"
     ? `<button class="btn done" onclick="generateCode('${o._id}')">Delivered</button>` : ""}

   ${o.status==="delivery_code_generated"
     ? `<button class="btn done" onclick="verifyCode('${o._id}')">Enter Code</button>` : ""}
  </div>
 </div>
 `).join("");
}

/* ACTIONS */
async function acceptOrder(id){
 const p=JSON.parse(localStorage.getItem("deliveryProfile_"+DBID)||"{}");
 await fetch(`${API}/api/orders/${id}/delivery-accept`,{
  method:"POST",
  headers:{ "Content-Type":"application/json","Authorization":"Bearer "+TOKEN },
  body:JSON.stringify({
   deliveryBoyId:DBID,
   deliveryBoyName:p.name||"Delivery Partner",
   deliveryBoyMobile:p.mobile||""
  })
 });
 loadOrders();
}

async function pickupOrder(id){
 await fetch(`${API}/api/orders/${id}/pickup`,{method:"POST"});
 loadOrders();
}

async function generateCode(id){
 await fetch(`${API}/api/orders/generate-delivery-code/${id}`,{method:"POST"});
 alert("Code generated. Ask retailer for code.");
 loadOrders();
}

async function verifyCode(id){
 const code=prompt("Enter delivery code");
 if(!code) return;

 const res=await fetch(`${API}/api/orders/verify-delivery-code/${id}`,{
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({code})
 });
 const data=await res.json();

 data.success ? alert("Delivered ‚úÖ") : alert("Wrong Code ‚ùå");
 loadOrders();
}

loadOrders();
setInterval(loadOrders,8000);
</script>
</body>
</html>
