<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Delivery Partner Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
*{font-family:Poppins,sans-serif;box-sizing:border-box}
body{margin:0;background:#eef2f7}
.main{max-width:900px;margin:auto;padding:14px}

.top{
 background:#0f172a;color:#fff;
 display:flex;justify-content:space-between;align-items:center;
 padding:14px;border-radius:16px
}
.icon-btn{
 background:#2563eb;border:none;color:#fff;
 width:44px;height:44px;border-radius:50%;
 font-size:20px;cursor:pointer
}

.card{
 background:#fff;margin-top:14px;padding:14px;
 border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08)
}

.order{
 display:flex;gap:12px;margin-top:12px
}
.order img{
 width:90px;height:80px;object-fit:cover;border-radius:10px
}

.badge{padding:4px 10px;border-radius:20px;font-size:12px}
.green{background:#dcfce7;color:#166534}
.orange{background:#fff7ed;color:#9a3412}
.blue{background:#e0f2fe;color:#075985}

.btn{
 display:inline-flex;align-items:center;gap:6px;
 padding:8px 14px;border:none;border-radius:10px;
 cursor:pointer;margin-top:8px;font-size:13px
}
.accept{background:#16a34a;color:#fff}
.pickup{background:#f59e0b;color:#fff}
.done{background:#2563eb;color:#fff}

.modal{
 position:fixed;inset:0;background:rgba(0,0,0,.45);
 display:none;align-items:center;justify-content:center;z-index:99
}
.modal-box{
 background:#fff;width:92%;max-width:420px;
 border-radius:16px;padding:20px
}
input,select{
 width:100%;padding:10px;margin-top:8px;
 border-radius:10px;border:1px solid #ccc
}

.notify{
 position:fixed;top:15px;right:15px;
 background:#0f172a;color:#fff;
 padding:12px 18px;border-radius:14px;
 display:none;align-items:center;gap:10px
}
</style>
</head>

<body>
<div class="notify" id="notify">
 <i class="bi bi-bell-fill"></i>
 <span id="notifyText"></span>
</div>

<div class="main">
<div class="top">
 <h3>üöö Delivery Partner</h3>
 <div>
  <button class="icon-btn" onclick="openProfile()"><i class="bi bi-person-circle"></i></button>
 </div>
</div>

<div class="card">
 <b>ID:</b> <span id="dbId"></span><br>
 <span class="badge green">ACTIVE</span>
</div>

<div id="orders"></div>
</div>

<!-- PROFILE -->
<div class="modal" id="profileModal">
 <div class="modal-box">
  <h3>Delivery Profile</h3>
  <input id="pName" placeholder="Full Name">
  <input id="pMobile" placeholder="Mobile">
  <select id="pVehicle">
   <option value="">Vehicle Type</option>
   <option>Two Wheeler</option>
   <option>Three Wheeler</option>
   <option>Four Wheeler</option>
  </select>
  <input id="pVehicleNo" placeholder="Vehicle Number">
  <input id="pCity" placeholder="City">
  <button class="btn accept" onclick="saveProfile()">
   <i class="bi bi-save"></i> Save Profile
  </button>
 </div>
</div>

<script>
const API="https://shopbacked-vmhs.onrender.com";
const DBID=localStorage.getItem("userId");
dbId.innerText=DBID?.slice(0,8).toUpperCase();

/* PROFILE */
function openProfile(){
 profileModal.style.display="flex";
 const p=JSON.parse(localStorage.getItem("deliveryProfile")||"{}");
 pName.value=p.name||"";
 pMobile.value=p.mobile||"";
 pVehicle.value=p.vehicle||"";
 pVehicleNo.value=p.vehicleNo||"";
 pCity.value=p.city||"";
}
function saveProfile(){
 localStorage.setItem("deliveryProfile",JSON.stringify({
  name:pName.value,
  mobile:pMobile.value,
  vehicle:pVehicle.value,
  vehicleNo:pVehicleNo.value,
  city:pCity.value
 }));
 alert("Profile Saved");
 profileModal.style.display="none";
}

/* NOTIFICATION */
function notify(msg){
 notifyText.innerText=msg;
 notify.style.display="flex";
 setTimeout(()=>notify.style.display="none",3000);
}

/* LOAD ORDERS */
async function loadOrders(){
  const res = await fetch(
    `${API}/api/orders/delivery/${DBID}`,
    { headers:{Authorization:"Bearer "+TOKEN} }
  );
  const data = await res.json();
  ordersList = data.orders;
  renderOrders();
}

function renderOrders(list){
 orders.innerHTML=list.map(o=>`
 <div class="card order">
  <img src="${o.productImg}">
  <div style="flex:1">
   <b>${o.productName}</b> ‚Çπ${o.price}<br><br>

   üè™ <b>${o.wholesalerName}</b><br>
   üìû ${o.wholesalerMobile}<br>
   üè† ${o.wholesalerAddress}<br><br>

   üè¨ <b>${o.retailerName}</b><br>
   üìû ${o.retailerMobile}<br>
   üè† ${o.retailerAddress}<br><br>

   üöö Vehicle: ${o.vehicleType}<br>
   <span class="badge blue">${o.status}</span><br>

   ${o.status==="confirmed_by_wholesaler"?`
    <button class="btn accept" onclick="accept('${o._id}')">
     <i class="bi bi-check-circle-fill"></i> Accept
    </button>`:""}

   ${o.status==="delivery_accepted"?`
    <button class="btn pickup" onclick="pickup('${o._id}')">
     <i class="bi bi-box-seam-fill"></i> Pickup
    </button>`:""}

   ${o.status==="picked_up"?`
    <button class="btn done">
     <i class="bi bi-check2-circle"></i> Delivered
    </button>`:""}
  </div>
 </div>
 `).join("")||"<p>No Orders</p>";
}

async function acceptOrder(id){
  const profile = JSON.parse(
    localStorage.getItem("deliveryProfile_"+DBID) || "{}"
  );

  await fetch(`${API}/api/orders/${id}/delivery-accept`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+TOKEN
    },
    body:JSON.stringify({
      deliveryBoyId: DBID,
      deliveryBoyName: profile.name,
      deliveryBoyMobile: profile.mobile
    })
  });

  loadOrders(); // refresh
}
async function pickup(id){
 await fetch(API+"/api/orders/"+id+"/pickup",{method:"POST"});
 notify("Order Picked Up");
 loadOrders();
}

loadOrders();
setInterval(loadOrders,8000);
</script>
</body>
</html>
