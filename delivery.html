<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Delivery Boy Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:15px;max-width:900px;margin:auto}
.top-bar{display:flex;justify-content:space-between;align-items:center;background:#0f172a;color:#fff;padding:12px 16px;border-radius:14px}
.icon-btn{background:#2563eb;border:none;color:#fff;width:42px;height:42px;border-radius:50%;font-size:20px;cursor:pointer}
.status-box,.order-card{background:#fff;margin-top:12px;padding:12px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
.order-card{display:flex;gap:10px}
.order-card img{width:80px;height:70px;object-fit:cover;border-radius:8px}
button.primary{background:#16a34a;color:#fff;border:none;padding:7px 12px;border-radius:8px;cursor:pointer;margin-top:5px}
button.warn{background:#f59e0b;color:#fff;border:none;padding:7px 12px;border-radius:8px;cursor:pointer;margin-top:5px}
button.done{background:#2563eb;color:#fff;border:none;padding:7px 12px;border-radius:8px;cursor:pointer;margin-top:5px}
</style>
</head>

<body>
<div class="main">

<div class="top-bar">
 <h3>üöö Delivery Dashboard</h3>
 <div>
  <button class="icon-btn" onclick="updateLocation()"><i class="bi bi-geo-alt-fill"></i></button>
  <button class="icon-btn" onclick="loadOrders()"><i class="bi bi-bag-check"></i></button>
 </div>
</div>

<div class="status-box">
 <b>ID:</b> <span id="dbId"></span><br>
 <b>Status:</b> üü¢ ACTIVE<br>
 <small id="locText">üìç Location not set</small>
</div>

<div id="orders"></div>
</div>

<script>
const API = "https://shopbacked-vmhs.onrender.com";
const deliveryBoyId = localStorage.getItem("userId");
const role = localStorage.getItem("role");
const TOKEN = localStorage.getItem("token");

if(!deliveryBoyId || role!=="delivery"){
 alert("Login again");
 location.href="index.html";
}

dbId.innerText = deliveryBoyId.substring(0,8).toUpperCase();

/* ===== LIVE LOCATION TO SERVER ===== */
function updateLocation(){
 navigator.geolocation.getCurrentPosition(async pos=>{
  const body={
   deliveryBoyId,
   lat:pos.coords.latitude,
   lng:pos.coords.longitude
  };
  await fetch(API+"/api/delivery/location",{
   method:"POST",
   headers:{"Content-Type":"application/json","Authorization":"Bearer "+TOKEN},
   body:JSON.stringify(body)
  });
  locText.innerText=`üìç ${body.lat.toFixed(4)}, ${body.lng.toFixed(4)}`;
  alert("Location updated");
 });
}

/* ===== LOAD ASSIGNED / AVAILABLE ORDERS ===== */
async function loadOrders(){
 const res = await fetch(API+"/api/orders/delivery/available",{
  headers:{ "Authorization":"Bearer "+TOKEN }
 });
 const data = await res.json();

 orders.innerHTML = data.orders.map(o=>`
  <div class="order-card">
   <img src="${o.productImg}">
   <div style="flex:1">
    <b>${o.productName}</b><br>
    ‚Çπ${o.price}<br>
    üè™ ${o.shopName}<br>
    üè¨ ${o.retailerName}<br>
    üìû ${o.retailerMobile}<br>

    ${o.status==="delivery_assigned" ? `
      <button class="primary" onclick="acceptOrder('${o._id}')">Accept Delivery</button>
    `:""}

    ${o.status==="delivery_accepted" ? `
      <button class="warn" onclick="pickupOrder('${o._id}')">Picked Up</button>
    `:""}

    ${o.status==="pickup" ? `
      <button class="done" onclick="deliverOrder('${o._id}')">Delivered</button>
    `:""}

    <div><small>Status: <b>${o.status}</b></small></div>
   </div>
  </div>
 `).join("") || "<p>No orders</p>";
}

/* ===== ACTIONS ===== */
async function acceptOrder(id){
 await fetch(API+"/api/orders/"+id+"/accept",{method:"POST"});
 loadOrders();
}

async function pickupOrder(id){
 await fetch(API+"/api/orders/"+id+"/pickup",{method:"POST"});
 loadOrders();
}

async function deliverOrder(id){
 await fetch(API+"/api/orders/"+id+"/delivered",{method:"POST"});
 loadOrders();
}

loadOrders();
setInterval(loadOrders,5000);
</script>
</body>
</html>
