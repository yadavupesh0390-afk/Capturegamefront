<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Delivery Partner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#eef2f7}
.main{max-width:900px;margin:auto;padding:16px}

.top{
 background:#0f172a;color:#fff;
 display:flex;justify-content:space-between;align-items:center;
 padding:14px;border-radius:16px
}
.icon-btn{
 background:#2563eb;border:none;color:#fff;
 width:44px;height:44px;border-radius:50%;
 font-size:20px;cursor:pointer
}

.card{
 background:#fff;margin-top:14px;padding:14px;
 border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08)
}

.order{
 display:flex;gap:12px;margin-top:12px
}
.order img{
 width:90px;height:80px;object-fit:cover;border-radius:10px
}

.badge{
 padding:4px 10px;border-radius:20px;
 font-size:12px;display:inline-block
}
.green{background:#dcfce7;color:#166534}
.blue{background:#e0f2fe;color:#075985}

.btn{
 display:inline-flex;align-items:center;gap:6px;
 padding:8px 14px;border:none;border-radius:10px;
 cursor:pointer;margin-top:8px;font-size:13px
}
.accept{background:#16a34a;color:#fff}
.pickup{background:#f59e0b;color:#fff}
.done{background:#2563eb;color:#fff}

/* MODAL */
.modal{
 position:fixed;inset:0;
 background:rgba(0,0,0,.5);
 display:none;align-items:center;justify-content:center;
 z-index:50
}
.modal-box{
 background:#fff;width:90%;max-width:360px;
 border-radius:16px;padding:20px
}
.modal-box input{
 width:100%;padding:10px;margin-top:10px;
 border-radius:10px;border:1px solid #ccc
}
</style>
</head>

<body>

<div class="main">

<!-- HEADER -->
<div class="top">
 <h3>üöö Delivery Partner</h3>
 <button class="icon-btn"><i class="bi bi-person-circle"></i></button>
</div>

<div class="card">
 <b>ID:</b> <span id="dbId"></span><br>
 <span class="badge green">ACTIVE</span>
</div>

<div id="orders"></div>

</div>

<!-- DELIVERY CODE POPUP -->
<div class="modal" id="codeModal">
 <div class="modal-box">
  <h3>üîê Enter Delivery Code</h3>
  <input id="deliveryCodeInput" placeholder="Enter 6 digit code">
  <button class="btn done" onclick="submitDeliveryCode()">Submit</button>
  <button class="btn" onclick="closeCodeModal()">Cancel</button>
 </div>
</div>

<script>
const API="https://shopbacked-vmhs.onrender.com";
const DBID=localStorage.getItem("userId");
const TOKEN=localStorage.getItem("token");

let CURRENT_ORDER_ID=null;

dbId.innerText = DBID ? DBID.slice(0,8).toUpperCase() : "N/A";

/* LOAD ORDERS */
async function loadOrders(){
 const res=await fetch(`${API}/api/orders/delivery/${DBID}`,{
  headers:{Authorization:"Bearer "+TOKEN}
 });
 const data=await res.json();
 renderOrders(data.orders||[]);
}

/* RENDER */
function renderOrders(list){
 if(!list.length){
  orders.innerHTML="<p style='text-align:center'>No Orders</p>";
  return;
 }

 orders.innerHTML=list.map(o=>`
 <div class="card order">
  <img src="${o.productImg}">
  <div style="flex:1">
   <b>${o.productName}</b> ‚Çπ${o.price}<br><br>

   üè™ <b>${o.wholesalerName}</b><br>
   üìû ${o.wholesalerMobile || "N/A"}<br>
   üè† ${o.wholesalerAddress || "Address not available"}<br><br>

   üè¨ <b>${o.retailerName}</b><br>
   üìû ${o.retailerMobile || "N/A"}<br>
   üè† ${o.retailerAddress || "Address not available"}<br><br>

   üöö Vehicle: ${o.vehicleType}<br>
   <span class="badge blue">${o.status}</span><br>

   ${o.status==="confirmed_by_wholesaler"
    ? `<button class="btn accept" onclick="acceptOrder('${o._id}')">Accept</button>`:""}

   ${o.status==="delivery_accepted"
    ? `<button class="btn pickup" onclick="pickupOrder('${o._id}')">Pickup</button>`:""}

   ${(o.status==="picked_up" || o.deliveryCode)
    ? `<button class="btn done"
        onclick="deliverFlow('${o._id}', ${o.deliveryCode ? true : false})">
        Delivered
       </button>`:""}
  </div>
 </div>
 `).join("");
}

/* ACTIONS */
async function acceptOrder(id){
 await fetch(`${API}/api/orders/${id}/delivery-accept`,{
  method:"POST",
  headers:{Authorization:"Bearer "+TOKEN}
 });
 loadOrders();
}

async function pickupOrder(id){
 await fetch(`${API}/api/orders/${id}/pickup`,{method:"POST"});
 loadOrders();
}

/* DELIVERY FLOW (FINAL FIX) */
async function deliverFlow(orderId, hasCode){

 // FIRST CLICK ‚Üí GENERATE CODE
 if(!hasCode){
  await fetch(`${API}/api/orders/generate-delivery-code/${orderId}`,{
   method:"POST"
  });
  alert("Delivery code generated. Ask retailer for code.");
  loadOrders();
  return;
 }

 // SECOND CLICK ‚Üí OPEN POPUP
 CURRENT_ORDER_ID = orderId;
 deliveryCodeInput.value="";
 codeModal.style.display="flex";
}

/* SUBMIT CODE */
async function submitDeliveryCode(){
 const code=deliveryCodeInput.value.trim();
 if(!code) return alert("Enter code");

 const res=await fetch(`${API}/api/orders/verify-delivery-code/${CURRENT_ORDER_ID}`,{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({code})
 });

 const data=await res.json();
 if(data.success){
  alert("Delivered Successfully ‚úÖ");
  closeCodeModal();
  loadOrders();
 }else{
  alert("Wrong Code ‚ùå");
 }
}

function closeCodeModal(){
 codeModal.style.display="none";
 CURRENT_ORDER_ID=null;
}

loadOrders();
setInterval(loadOrders,8000);
</script>

</body>
</html>
