<!DOCTYPE html>  <html lang="en">  
<head>  
<meta charset="UTF-8">  
<title>Delivery Partner Dashboard</title>  
<meta name="viewport" content="width=device-width, initial-scale=1.0">  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">  
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">  <style>  
/* ===================== BASE ===================== */
* {
  box-sizing: border-box;
  font-family: Poppins, sans-serif;
  margin: 0;
  padding: 0;
}
.main{
  max-width: 900px;
  margin: 16px auto;     /* üî• top space mil jayega */
  padding: 12px;
}
body {
  background: #f3f6fb;   /* soft background */
  color: #1f2937;         /* main text color */
}

/* ===================== TOP BAR ===================== */
.top{
  background:#0f172a;
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;

  padding:16px 20px;    /* thoda comfortable */
  border-radius:16px;

  margin-bottom:14px;  /* üî• neeche gap */
}

.top h3 {
  font-size: 18px;
  font-weight: 600;
}

.icon-btn {
  background: #2563eb;
  border: none;
  color: #fff;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  transition: 0.2s;
}

.icon-btn:hover {
  background: #1d4ed8;
}

/* ===================== CARD BASE ===================== */
.card {
  background: #fff;
  margin-top: 10px;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.card.order {
  display: flex;
  flex-direction: column;
  gapqp: 10px;
}

/* ===================== ORDER IMAGE ===================== */
.order img {
  width: 90px;
  height: 80px;
  object-fit: cover;
  border-radius: 10px;
  border: 1px solid #e5e7eb; /* subtle border for neatness */
}

/* ===================== STATUS BOX ===================== */
/* ===== COMPACT STATUS BOX ===== */
.status-box{
  display:inline-flex;          /* pill jaisa */
  align-items:center;
  gap:6px;

  padding:3px 8px;              /* üî• chhota size */
  border-radius:999px;          /* fully rounded pill */

  font-size:11px;               /* compact text */
  font-weight:600;

  line-height:1;                /* extra height remove */
  white-space:nowrap;

  max-width:100%;
}

.status-pending {
  background: #fff4e5;
  color: #b45309;
  border: 1px solid #fcd34d;
}

.status-assigned {
  background: #e0f2fe;
  color: #0369a1;
  border: 1px solid #60a5fa;
}

.status-delivered {
  background: #dcfce7;
  color: #166534;
  border: 1px solid #4ade80;
}

.status-default {
  background: #f3f4f6;
  color: #374151;
  border: 1px solid #d1d5db;
}

/* ===================== PRODUCTS LIST ===================== */
.card.order ul {
  list-style-type: disc;
  margin: 6px 0 6px 20px;
  padding: 0;
}

.card.order ul li {
  font-size: 14px;
  line-height: 1.6;
  color: #111827;
}

/* ===================== BUTTONS ===================== */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  margin-top: 8px;
  font-size: 13px;
  font-weight: 500;
  transition: 0.2s;
}

.btn:hover {
  opacity: 0.9;
}

.btn.accept {
  background: #16a34a;
  color: #fff;
}

.btn.pickup {
  background: #f59e0b;
  color: #fff;
}

.btn.done {
  background: #2563eb;
  color: #fff;
}

/* ===================== LIVE LOCATION ===================== */
.location-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin: 12px 0;
}

.location-group label {
  font-size: 13px;
  color: #0f172a;
  font-weight: 600;
}

.location-group input {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #2563eb;
  background: #f8fafc;
  font-size: 13px;
  color: #1f2937;
}

/* ===================== MODALS ===================== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 20;
}

.modal-box {
  background: #fff;
  width: 92%;
  max-width: 420px;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.modal-box input,
.modal-box select {
  width: 100%;
  padding: 10px;
  margin: 8px 0;
  border-radius: 10px;
  border: 1px solid #ccc;
  }


</style>  </head>  <body>  <div class="main">    <div class="top">  
    <h3>üöö Delivery Partner</h3>  
    <button class="icon-btn" onclick="openProfile()">  
      <i class="bi bi-person-circle"></i>  
    </button>  
  </div>    <div class="card">  
    <b>ID:</b> <span id="dbId"></span><br>  
    <span class="badge green">ACTIVE</span>  
  </div>    <div id="orders"></div>  
</div>  <!-- PROFILE MODAL -->
<div class="modal" id="profileModal">
 <div class="modal-box">
  <h3>üë§ Delivery Profile</h3>

  <input id="pName" placeholder="Full Name">
  <input id="pMobile" placeholder="Mobile Number">

  <select id="pVehicle">
   <option value="">Vehicle Type</option>
   <option value="two_wheeler">Two Wheeler</option>
   <option value="three_wheeler">Three Wheeler</option>
   <option value="four_wheeler">Four Wheeler</option>
  </select>

  <input id="pVehicleNo" placeholder="Vehicle Number">
  <input id="pCity" placeholder="City">

  <!-- ‚úÖ LIVE LOCATION -->
  <div class="location-group">
    <label>üìç Live Location (lat, lng)</label>
    <input id="pLocation" placeholder="Live location not set" readonly>
    <button class="btn accept" onclick="getLiveLocation()">üì° Set Live Location</button>
  </div>

  <button class="btn accept" onclick="saveProfile()">Save Profile</button>
  <button class="btn" onclick="closeProfile()">Close</button>
 </div>
</div>  <!-- DELIVERY CODE MODAL -->  <div class="modal" id="codeModal">  
 <div class="modal-box">  
  <h3>üîê Enter Delivery Code</h3>  
  <input id="deliveryCodeInput" placeholder="Enter delivery code">  
  <button class="btn done" onclick="submitDeliveryCode()">Submit</button>  
  <button class="btn" onclick="closeCodeModal()">Cancel</button>  
 </div>  
</div>  <script>  
const API = "https://shopbacked-vmhs.onrender.com";  
const DBID = localStorage.getItem("userId");  
const TOKEN = localStorage.getItem("token");  
  
let lastOrders = [];  
let currentOrderId = null;  
  
dbId.innerText = DBID ? DBID.slice(0,8).toUpperCase() : "N/A";  
  
/* PROFILE */  
  
async function openProfile(){  
  profileModal.style.display = "flex";  
  
  try{  
    const res = await fetch(
      `${API}/api/delivery/profile/${DBID}`,
      {
        headers:{ "Authorization":"Bearer "+TOKEN }
      }
    );  
  
    const data = await res.json();  
    if(!data.success || !data.profile) return;  
  
    const p = data.profile;  

    // BASIC DETAILS
    pName.value      = p.name || "";  
    pMobile.value    = p.mobile || "";  
    pVehicle.value   = p.vehicle || "";  
    pVehicleNo.value = p.vehicleNo || "";  
    pCity.value      = p.city || "";  

    // ‚úÖ LIVE LOCATION LOAD
    if(p.location && p.location.lat && p.location.lng){
      liveLat = p.location.lat;
      liveLng = p.location.lng;

      document.getElementById("pLocation").value =
        liveLat.toFixed(6) + ", " + liveLng.toFixed(6);
    }else{
      document.getElementById("pLocation").value = "";
      liveLat = null;
      liveLng = null;
    }
   setLiveLocation();
  }catch(err){  
    console.error("Open profile error:", err);  
    alert("‚ùå Profile load failed");
  }  
}
  
  
  
async function saveProfile(){    

  if(!pMobile.value.trim()){    
    alert("Mobile number required");    
    return;    
  }    

  const payload = {    
    deliveryBoyId: DBID,  
    name: pName.value.trim(),    
    mobile: pMobile.value.trim(),    
    vehicle: pVehicle.value,    
    vehicleNo: pVehicleNo.value.trim(),    
    city: pCity.value.trim(),
    location: liveLat && liveLng ? {
      lat: liveLat,
      lng: liveLng
    } : null
  };    

  try{    
    const res = await fetch(`${API}/api/delivery/profile/save`,{    
      method:"POST",    
      headers:{    
        "Content-Type":"application/json",    
        "Authorization":"Bearer "+TOKEN    
      },    
      body: JSON.stringify(payload)    
    });    

    const data = await res.json();    

    if(data.success){

      localStorage.setItem(
        "deliveryProfile_"+DBID,
        JSON.stringify(payload)
      );

      alert("‚úÖ Profile + Live location saved");
      closeProfile();

    }else{
      alert("‚ùå Profile save failed");
    }    

  }catch(err){    
    alert("‚ùå Server error");    
  }    
}
        
  
window.closeProfile = function(){  
  const modal = document.getElementById("profileModal");  
  if(modal){  
    modal.style.display = "none";  
  }  
}  
function getLiveLocation(){
  setLiveLocation();   // manual click par bhi wahi chale
}
  let liveLat = null;
let liveLng = null;

async function setLiveLocation(){
  if(!navigator.geolocation){
    console.log("Geolocation not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      // üìç BOX ME SHOW
      const locInput = document.getElementById("pLocation");
      if(locInput){
        locInput.value = lat.toFixed(6) + ", " + lng.toFixed(6);
      }

      // üåç SERVER PE SAVE
      try{
        await fetch(`${API}/api/delivery/profile/save`,{
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer "+TOKEN
          },
          body: JSON.stringify({
            deliveryBoyId: DBID,
            location:{ lat, lng }
          })
        });
      }catch(err){
        console.log("Location save error");
      }
    },
    (err)=>{
      console.log("Location error:", err.message);
    },
    {
      enableHighAccuracy:true,
      maximumAge:0,
      timeout:10000
    }
  );
}
   
/* LOAD ORDERS */  
async function loadOrders(){  
 try{  
  const res = await fetch(`${API}/api/orders/delivery/${DBID}`,{  
    headers:{ Authorization:"Bearer "+TOKEN }  
  });  
  const data = await res.json();  
  // ‚úÖ Only show unassigned orders or assigned to current delivery boy  
  lastOrders = (data.orders || []).filter(o => !o.deliveryBoyId || o.deliveryBoyId === DBID);  
  renderOrders(lastOrders);  
 }catch(err){  
  orders.innerHTML="<p style='text-align:center;color:red'>Failed to load orders</p>";  
 }  
}  
 function groupOrdersByCart(orders){
  const map = {};

  orders.forEach(o=>{
    // Agar cartOrder hai to cartGroupId ke under group karo, warna _id
    const key = o.cartGroupId || o._id;

    if(!map[key]){
      map[key] = {
        key,
        isCartOrder: !!o.cartGroupId,
        status: o.status,
        time: o.statusHistory?.[0]?.time || o.createdAt,
        retailerName: o.retailerName,
        retailerMobile: o.retailerMobile,
        wholesalerName: o.wholesalerName,
        wholesalerMobile: o.wholesalerMobile,
        vehicleType: o.vehicleType,
        deliveryBoyId: o.deliveryBoyId,
        products: []
      };
    }

    map[key].products.push(o);
  });

  return Object.values(map);
}
/* RENDER ORDERS */  
function renderOrders(list){
  if(!list.length){
    orders.innerHTML="<p style='text-align:center'>No Orders</p>";
    return;
  }

  const grouped = groupOrdersByCart(list);

  orders.innerHTML = grouped.map(o => {
    // STATUS SAME JAISE WHolesaler
    const statusClass = getStatusClass(o.status);
    const statusText = getStatusText(o.status);

    return `
    <div class="card order">

      <div class="status-box ${statusClass}">
        Status: <b>${statusText}</b><br>
        üïí ${o.time ? new Date(o.time).toLocaleString() : ""}
      </div>

      <hr>

      <b>üì¶ Products:</b>
      <ul>
        ${o.products.map(p=>`<li>${p.productName}</li>`).join("")}
      </ul>

      <hr>

      üè™ <b>Wholesaler:</b> ${o.wholesalerName}<br>
      üìû ${o.wholesalerMobile || "N/A"}<br><br>

      üè¨ <b>Retailer:</b> ${o.retailerName}<br>
      üìû ${o.retailerMobile || "N/A"}<br><br>

      üöó <b>Vehicle:</b>
      ${
        o.vehicleType==="two_wheeler"?"Two Wheeler":
        o.vehicleType==="three_wheeler"?"Three Wheeler":
        o.vehicleType==="four_wheeler"?"Four Wheeler":"N/A"
      }
      <br><br>

      ${
        o.status==="paid"
          ? `<button class="btn accept" onclick="acceptOrder('${o.key}')">Accept</button>`
          : ""
      }

      ${
        o.status==="delivery_accepted"
          ? `<button class="btn pickup" onclick="pickupOrder('${o.key}')">Pickup</button>`
          : ""
      }

      ${
        o.status==="picked_up"
          ? `<button class="btn pickup" onclick="deliverFlow('${o.key}')">Generate Code</button>`
          : ""
      }

      ${
        o.status==="delivery_code_generated"
          ? `<button class="btn done" onclick="deliverFlow('${o.key}')">Delivered</button>`
          : ""
      }

    </div>
    `;
  }).join("");
}
  function getStatusClass(status){
  if(status==="paid" || status==="pending") return "status-pending";
  if(status==="delivery_accepted" || status==="assigned") return "status-assigned";
  if(status==="picked_up" || status==="delivery_code_generated" || status==="delivered") return "status-delivered";
  return "status-default";
}

function getStatusText(status){
  if(status==="paid") return "Pending";
  if(status==="delivery_accepted") return "Assigned";
  if(status==="picked_up") return "Picked Up";
  if(status==="delivery_code_generated") return "Out for Delivery";
  if(status==="delivered") return "Delivered";
  return status;
}
/* ACTIONS */  
async function acceptOrder(id){  
 const p = JSON.parse(localStorage.getItem("deliveryProfile_"+DBID)||"{}");  
 await fetch(`${API}/api/orders/${id}/delivery-accept`,{  
  method:"POST",  
  headers:{ "Content-Type":"application/json","Authorization":"Bearer "+TOKEN },  
  body:JSON.stringify({ deliveryBoyId:DBID,deliveryBoyName:p.name||"Delivery Partner",deliveryBoyMobile:p.mobile||"" })  
 });  
 loadOrders();  
}  
// pickupOrder
async function pickupOrder(orderId){
  const p = JSON.parse(localStorage.getItem("deliveryProfile_"+DBID)||"{}");

  const res = await fetch(`${API}/api/orders/${orderId}/pickup`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+TOKEN
    },
    body: JSON.stringify({
      deliveryBoyId: DBID,
      deliveryBoyName: p.name || "Delivery Partner",
      deliveryBoyMobile: p.mobile || ""
    })
  });

  const data = await res.json();
  if(data.success){
    alert("Order picked up ‚úÖ");
    loadOrders();
  }else{
    alert(data.message || "Pickup failed ‚ùå");
  }
}
  
/* DELIVERY FLOW */  
async function deliverFlow(orderId){
  const order = lastOrders.find(o => o._id === orderId);
  if(!order){
    alert("Order not found");
    return;
  }

  // üîπ STEP 1: GENERATE DELIVERY CODE
  if(order.status === "picked_up"){
    try{
      const res = await fetch(
        `${API}/api/orders/generate-delivery-code/${orderId}`,
        {
          method: "POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer " + TOKEN
          },
          body: JSON.stringify({
            deliveryBoyId: DBID   // ‚úÖ MUST
          })
        }
      );

      const data = await res.json();

      if(data.success){
        alert("üîê Delivery code generated & sent to retailer");
        loadOrders(); // refresh
        return;
      }else{
        alert(data.message || "‚ùå Code generation failed");
        return;
      }

    }catch(err){
      console.error(err);
      alert("‚ùå Server error while generating code");
      return;
    }
  }

  // üîπ STEP 2: VERIFY DELIVERY CODE
  if(order.status === "delivery_code_generated"){
    currentOrderId = orderId;
    deliveryCodeInput.value = "";
    codeModal.style.display = "flex";
    return;
  }

  alert("‚ùå Order not ready for delivery");
}
  
async function submitDeliveryCode(){  
  const code = deliveryCodeInput.value.trim();  
  if(!code) return alert("Enter delivery code");  

  const res = await fetch(`${API}/api/orders/verify-delivery-code/${currentOrderId}`,{
    method:"POST",
    headers:{ 
      "Content-Type":"application/json",
      "Authorization":"Bearer "+TOKEN 
    },
    body: JSON.stringify({
  code,
  deliveryBoyId: DBID
})
  });  

  const data = await res.json();  

  // ‚úÖ SUCCESS ‚Üí DELIVERED
  if(data.success){
    alert("‚úÖ Order delivered successfully");
    closeCodeModal();
    loadOrders();
    return;
  }

  // ‚è±Ô∏è CODE EXPIRED ‚Üí AUTO SHOW GENERATE BUTTON
  if(data.message && data.message.includes("expired")){
    alert(data.message);              // "Delivery code expired..."
    closeCodeModal();
    loadOrders();                     // üî• status ‚Üí picked_up
    return;
  }

  // ‚ùå WRONG CODE
  alert("‚ùå Wrong delivery code");
}
  
function closeCodeModal(){ codeModal.style.display="none"; }  
  
/* INIT */  
loadOrders();
setInterval(loadOrders,8000);
setInterval(setLiveLocation, 15000); 
</script> <!-- üî• FIREBASE SDK & MESSAGING -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBioiLSE3HyZh49yJv93MwnQFrmAm6wJ5g",
    authDomain: "shop-ab586.firebaseapp.com",
    projectId: "shop-ab586",
    storageBucket: "shop-ab586.firebasestorage.app",
    messagingSenderId: "603669325846",
    appId: "1:603669325846:web:00f3ccff7fa977bf542d37"
  };

  // üîπ INIT FIREBASE
  const app = initializeApp(firebaseConfig);
  const messaging = getMessaging(app);

  // üîπ REGISTER SERVICE WORKER
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js')
      .then(registration => {
        console.log("‚úÖ Service Worker registered:", registration);

        // üîπ GET FCM TOKEN
        Notification.requestPermission().then(permission => {
          if(permission === "granted"){
            getToken(messaging, {
              vapidKey: "BFcKfbosO2sXWogZ5fBBt31vEkw_1iwgQWVrZjAJ90pXdhdFBSbXM_Oppuoxm-QIidekMzIQdcl3XrJy0ltkC8s",
              serviceWorkerRegistration: registration
            }).then(token => {
              if(token){
                console.log("üîî FCM Token:", token);

                // ‚úÖ Send token to backend
                fetch(`${API}/api/notifications/saveToken`,{
                  method:"POST",
                  headers:{
                    "Content-Type":"application/json",
                    "Authorization":"Bearer "+TOKEN
                  },
                  body: JSON.stringify({
                    userId: DBID,
                    role: "delivery",
                    fcmToken: token
                  })
                });
              }else{
                console.warn("‚ö†Ô∏è FCM Token not generated. Check HTTPS & permissions.");
              }
            }).catch(err=>{
              console.error("‚ö†Ô∏è getToken error:", err);
            });
          } else {
            console.warn("‚ö†Ô∏è Notification permission not granted");
          }
        });

      }).catch(err => {
        console.error("‚ùå Service Worker registration failed:", err);
      });
  } else {
    console.warn("‚ö†Ô∏è Service Worker not supported");
  }

  // üîπ FOREGROUND NOTIFICATIONS
  onMessage(messaging, payload => {
    alert("üì© New Order: " + payload.notification?.title);
    loadOrders(); // refresh orders
  });
</script>

  <script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

/* üî• Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBioiLSE3HyZh49yJv93MwnQFrmAm6wJ5g",
  authDomain: "shop-ab586.firebaseapp.com",
  projectId: "shop-ab586",
  messagingSenderId: "603669325846",
  appId: "1:603669325846:web:00f3ccff7fa977bf542d37"
};

/* üöÄ Init Firebase */
const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

/* üß† Register Service Worker */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/firebase-messaging-sw.js")
    .then(() => console.log("‚úÖ Service Worker Registered"))
    .catch(err => console.error("‚ùå SW Registration Error", err));
}

/* üîî Init FCM for DELIVERY */
async function initFCM() {

  const userId = localStorage.getItem("userId");
  const role = localStorage.getItem("role");

  // ‚ùå only for delivery dashboard
  if (!userId || role !== "delivery") {
    console.log("‚õî Not a delivery user");
    return;
  }

  const permission = await Notification.requestPermission();
  if (permission !== "granted") {
    console.log("‚ùå Notification permission denied");
    return;
  }

  const fcmToken = await getToken(messaging, {
    vapidKey: "BFcKfbosO2sXWogZ5fBBt31vEkw_1iwgQWVrZjAJ90pXdhdFBSbXM_Oppuoxm-QIidekMzIQdcl3XrJy0ltkC8s"
  });

  if (!fcmToken) {
    console.log("‚ùå FCM Token not generated");
    return;
  }

  console.log("üî• DELIVERY FCM TOKEN:", fcmToken);

  // üì° Save token in backend
  await fetch("https://shopbacked-vmhs.onrender.com/api/notifications/saveToken", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId,
      role: "delivery",
      fcmToken
    })
  });

  console.log("‚úÖ Delivery token saved successfully");
}

/* ‚ñ∂Ô∏è Start */
window.addEventListener("load", initFCM);

  </script>

</body>  
</html>
