<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Delivery Boy Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:15px;max-width:900px;margin:auto}
.top-bar{display:flex;justify-content:space-between;align-items:center;background:#0f172a;color:#fff;padding:12px 16px;border-radius:14px}
.icon-btn{background:#2563eb;border:none;color:#fff;width:42px;height:42px;border-radius:50%;font-size:20px;cursor:pointer}
.card{background:#fff;margin-top:12px;padding:12px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
.order{display:flex;gap:10px}
.order img{width:90px;height:75px;border-radius:8px;object-fit:cover}
button{border:none;border-radius:8px;padding:6px 12px;margin-top:6px;cursor:pointer}
.accept{background:#16a34a;color:#fff}
.pickup{background:#f59e0b;color:#fff}
.done{background:#2563eb;color:#fff}
input{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
.status{font-size:12px;margin-top:5px}
small{color:#475569}
</style>
</head>

<body>
<div class="main">

<div class="top-bar">
 <h3>ğŸšš Delivery Dashboard</h3>
 <div>
  <button class="icon-btn" onclick="updateLocation()"><i class="bi bi-geo-alt"></i></button>
  <button class="icon-btn" onclick="loadOrders()"><i class="bi bi-bell"></i></button>
 </div>
</div>

<div class="card">
 <b>ID:</b> <span id="dbId"></span><br>
 <small id="locText">ğŸ“ Location not set</small>
</div>

<div id="orders"></div>

</div>

<script>
const API="https://shopbacked-vmhs.onrender.com";
const deliveryBoyId=localStorage.getItem("userId");
const TOKEN=localStorage.getItem("token");

dbId.innerText=deliveryBoyId?.substring(0,8)||"UNKNOWN";

let myLocation=null;

/* ================= LOCATION ================= */
function updateLocation(){
 navigator.geolocation.getCurrentPosition(async pos=>{
  myLocation={
   lat:pos.coords.latitude,
   lng:pos.coords.longitude
  };
  locText.innerText=`ğŸ“ ${myLocation.lat.toFixed(4)}, ${myLocation.lng.toFixed(4)}`;

  await fetch(API+"/api/delivery/location",{
   method:"POST",
   headers:{
    "Content-Type":"application/json",
    "Authorization":"Bearer "+TOKEN
   },
   body:JSON.stringify({deliveryBoyId,...myLocation})
  });
 });
}

/* ================= DISTANCE ================= */
function getDistance(lat1,lng1,lat2,lng2){
 const R=6371;
 const dLat=(lat2-lat1)*Math.PI/180;
 const dLng=(lng2-lng1)*Math.PI/180;
 const a=Math.sin(dLat/2)**2+
         Math.cos(lat1*Math.PI/180)*
         Math.cos(lat2*Math.PI/180)*
         Math.sin(dLng/2)**2;
 return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(2);
}

/* ================= LOAD ORDERS ================= */
async function loadOrders(){
 const res=await fetch(API+"/api/orders/delivery/all",{
  headers:{Authorization:"Bearer "+TOKEN}
 });
 const data=await res.json();

 orders.innerHTML=(data.orders||[]).map(o=>{
  let dist="N/A";
  if(myLocation && o.shopLat){
   dist=getDistance(myLocation.lat,myLocation.lng,o.shopLat,o.shopLng)+" km";
  }

  return `
  <div class="card order">
   <img src="${o.productImg}">
   <div style="flex:1">
    <b>${o.productName}</b> â‚¹${o.price}<br>

    ğŸª ${o.shopName}<br>
    ğŸ“ ${o.shopAddress}<br>
    ğŸ“ ${o.shopMobile}<br><br>

    ğŸ¬ ${o.retailerName}<br>
    ğŸ“ ${o.retailerMobile}<br>

    ğŸš— Vehicle: <b>${o.vehicleType}</b><br>
    ğŸ“ Distance: ${dist}

    <div class="status">Status: <b>${o.status}</b></div>

    ${o.status==="confirmed"?`
     <button class="accept" onclick="acceptOrder('${o._id}')">Accept</button>`:""}

    ${o.status==="delivery_accepted"?`
     <button class="pickup" onclick="pickupOrder('${o._id}')">Order Pickup</button>`:""}

    ${o.status==="picked_up"?`
     <input placeholder="Enter Delivery OTP" id="otp-${o._id}">
     <button class="done" onclick="deliverOrder('${o._id}')">Submit</button>`:""}
   </div>
  </div>`;
 }).join("") || "<p>No notifications</p>";
}

/* ================= ACTIONS ================= */
async function acceptOrder(id){
 await fetch(API+"/api/orders/"+id+"/accept",{method:"POST"});
 loadOrders();
}

async function pickupOrder(id){
 await fetch(API+"/api/orders/"+id+"/pickup",{method:"POST"});
 loadOrders();
}

async function deliverOrder(id){
 const otp=document.getElementById("otp-"+id).value;
 if(!otp) return alert("OTP required");

 const res=await fetch(API+"/api/orders/"+id+"/delivered",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({otp})
 });

 const data=await res.json();
 if(data.success){
  alert("Order Delivered âœ…");
  setTimeout(loadOrders,10000);
 }else alert("Wrong OTP âŒ");
}

setInterval(loadOrders,5000);
</script>
</body>
</html>
