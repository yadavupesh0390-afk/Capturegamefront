<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Category Products</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:20px;max-width:900px;margin:auto}
.header{margin-top:15px;background:#fff;padding:15px;border-radius:12px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.1)}
.back-btn{background:#2563eb;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;margin-top:10px}
.products-grid{
  display:grid;
  grid-template-columns:repeat(3, 1fr); /* 3 products per row */
  gap:12px;
  margin-top:20px;
}
@media(max-width:768px){
  .products-grid{grid-template-columns:repeat(2, 1fr);} /* Tablet 2 per row */
}
@media(max-width:500px){
  .products-grid{grid-template-columns:repeat(1, 1fr);} /* Mobile 1 per row */
}
.product-card{
  background:#fff;
  padding:10px;
  border-radius:12px;
  text-align:center;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  transition:.2s;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
.product-card:hover{transform:translateY(-4px)}
.product-card img{width:100%;height:120px;object-fit:cover;border-radius:8px}
.product-card h4{font-size:14px;margin:6px 0;color:#111;font-weight:500}
.price{color:#2563eb;font-weight:600;font-size:13px;margin-bottom:6px}
.product-actions{display:flex;justify-content:center;gap:6px;margin-top:6px}
button.success{background:#16a34a;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px}
button.delete{background:#dc2626;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
.modal-content{background:#fff;padding:20px;width:90%;max-width:500px;border-radius:15px;max-height:85vh;overflow:auto}
.slider{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;gap:10px;margin-top:10px}
.slider img{width:100%;border-radius:10px;scroll-snap-align:center;flex-shrink:0}
.dots{display:flex;justify-content:center;gap:6px;margin:8px 0}
.dot{width:8px;height:8px;border-radius:50%;background:#cbd5e1}
.dot.active{background:#2563eb}
</style>
</head>
<body>
<div class="main">
  <div class="header">
    <h3 id="catTitle">Category</h3>
    <button class="back-btn" onclick="goBack()">⬅ Back</button>
  </div>
  <div id="products" class="products-grid"></div>
</div>

<!-- PRODUCT DETAIL MODAL -->
<div class="modal" id="productDetailModal">
  <div class="modal-content">
    <h3 id="d_name"></h3>
    <div class="slider" id="d_images"></div>
    <div class="dots" id="d_dots"></div>
    <p id="d_price"></p>
    <p id="d_detail"></p>
    <button onclick="closeAll()">Close</button>
  </div>
</div>

<script>
const API="https://shopbacked-vmhs.onrender.com";
const TOKEN=localStorage.getItem("token");
const WID=localStorage.getItem("userId");
const ROLE=localStorage.getItem("role");

if(!TOKEN || !WID || ROLE!=="wholesaler"){ alert("Login again"); location.href="index.html"; }

const params = new URLSearchParams(window.location.search);
const category = params.get("cat") || "Other";
document.getElementById("catTitle").innerText = category;

const productsEl = document.getElementById("products");
const productDetailModal = document.getElementById("productDetailModal");
const d_name = document.getElementById("d_name");
const d_images = document.getElementById("d_images");
const d_dots = document.getElementById("d_dots");

function goBack(){ window.history.back(); }
function closeAll(){ document.querySelectorAll(".modal").forEach(m=>m.style.display="none"); }

async function loadCategoryProducts(){
  const res = await fetch(`${API}/api/products/wholesaler/${WID}`);
  const d = await res.json();
  const filtered = (d.products || []).filter(p => (p.category || "Other") === category);

  if(!filtered.length){ productsEl.innerHTML = "<p>No products in this category</p>"; return; }

  productsEl.innerHTML = filtered.map(p=>`
    <div class="product-card" onclick="openProductDetail('${p._id}')">
      <img src="${p.images?.[0] || ''}">
      <h4>${p.productName}</h4>
      <div class="price">₹${p.price}</div>
    </div>
  `).join("");
}

// Product Detail Modal
async function openProductDetail(id){
  productDetailModal.style.display = "flex";
  const res = await fetch(`${API}/api/products/${id}`);
  const data = await res.json();
  if(!data.success) return;
  const p = data.product;
  d_name.innerText = p.productName;
  d_price.innerText = "₹" + p.price;
  d_detail.innerText = p.detail || "";
  d_images.innerHTML = (p.images || []).map(img => `<img src="${img}">`).join("");
  d_dots.innerHTML = (p.images || []).map((_,i)=>`<div class="dot ${i===0?'active':''}"></div>`).join("");
  d_images.onscroll = () => {
    const index = Math.round(d_images.scrollLeft / d_images.clientWidth);
    [...d_dots.children].forEach((d,i)=>d.classList.toggle("active", i===index));
  };
}

loadCategoryProducts();
</script>
</body>
</html>
