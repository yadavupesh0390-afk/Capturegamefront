<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wholesaler Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Poppins,sans-serif}
body{margin:0;background:#f3f6fb}
.main{padding:20px}

.icon-bar{
 display:flex;justify-content:center;gap:20px;
 background:#0f172a;padding:12px;border-radius:14px;
 max-width:650px;margin:auto
}
.icon-btn{
 background:#2563eb;color:#fff;border:none;
 width:55px;height:55px;border-radius:50%;
 font-size:22px;cursor:pointer
}

.header{
 margin-top:15px;background:#fff;padding:15px;
 border-radius:12px;text-align:center;
 box-shadow:0 5px 15px rgba(0,0,0,.1)
}

.products-grid{
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:10px;margin-top:20px
}
.product-card{
 background:#fff;padding:5px;border-radius:10px;
 text-align:center;cursor:pointer;
 box-shadow:0 3px 8px rgba(0,0,0,.08)
}
.product-card img{
 width:100%;height:80px;object-fit:cover;border-radius:8px
}
.product-card h4{font-size:12px;margin:5px 0}
.price{color:#2563eb;font-weight:600;font-size:12px}

.modal{
 position:fixed;inset:0;
 background:rgba(0,0,0,.5);
 display:none;align-items:center;justify-content:center;
 z-index:20
}
.modal-content{
 background:#fff;padding:20px;
 width:90%;max-width:500px;
 border-radius:15px;max-height:85vh;overflow:auto
}
input,textarea{
 width:100%;padding:10px;margin:8px 0;
 border-radius:8px;border:1px solid #ccc
}
button.primary{
 background:#2563eb;color:#fff;border:none;
 padding:10px 15px;border-radius:10px;cursor:pointer
}
button.success{
 background:#16a34a;color:#fff;border:none;
 padding:8px 12px;border-radius:8px;cursor:pointer
}
.card{
 background:#f8fafc;padding:12px;
 border-radius:10px;margin-bottom:12px
}
img.full{
 width:100%;border-radius:10px;margin:10px 0
}
.small-img{
 width:80px;height:50px;object-fit:cover;border-radius:5px;margin:5px 0;
}

.status-line{
 display:flex;gap:5px;flex-wrap:wrap;margin:5px 0;
}
.status-line span{
 padding:5px 10px;
 border-radius:5px;
 background:#eee;
 color:#555;
 font-size:12px;
 font-weight:500;
}
.status-line span.active{background:#16a34a;color:#fff;}
.status-line span.delivered{background:#059669;color:#fff;}

.buttons button{margin:3px;}
</style>
</head>

<body>
<div class="main">

  <div class="icon-bar">
    <button class="icon-btn" onclick="openWid()" title="Set ID"><i class="bi bi-person-badge"></i></button>
    <button class="icon-btn" onclick="openProfile()" title="Shop Profile"><i class="bi bi-shop"></i></button>
    <button class="icon-btn" onclick="openProduct()" title="Add Product"><i class="bi bi-plus"></i></button>
    <button class="icon-btn" onclick="openOrders()" title="Orders"><i class="bi bi-bag-check"></i></button>
  </div>

  <div class="header">
    <h3>Wholesaler Dashboard</h3>
    <small>ID: <b id="widText"></b></small>
  </div>

  <div class="products-grid" id="products"></div>
</div>

<!-- SET WID -->
<div class="modal" id="widModal">
 <div class="modal-content">
  <h3>Set Wholesaler ID</h3>
  <input id="widInput" placeholder="W001">
  <button class="primary" onclick="setWid()">Save</button>
 </div>
</div>

<!-- SHOP PROFILE -->
<div class="modal" id="profileModal">
 <div class="modal-content">
  <h3>Shop Profile</h3>
  <input id="shopName" placeholder="Shop Name">
  <input id="shopMobile" placeholder="UPI / Mobile Number">
  <textarea id="shopAddress" placeholder="Shop Address"></textarea>
  <button class="primary" onclick="saveProfile()">Save</button>
  <button onclick="closeAll()">Cancel</button>
 </div>
</div>

<!-- ADD PRODUCT -->
<div class="modal" id="productModal">
 <div class="modal-content">
  <h3>Add Product</h3>
  <input id="pname" placeholder="Product Name">
  <input id="pprice" type="number" placeholder="Price">
  <textarea id="pdetail" placeholder="Detail"></textarea>
  <input id="pimg" type="file" accept="image/*">
  <button class="primary" onclick="addProduct()">Save</button>
  <button onclick="closeAll()">Cancel</button>
 </div>
</div>

<!-- ORDERS -->
<div class="modal" id="orderModal">
 <div class="modal-content">
  <h3>Manage Orders</h3>
  <div id="orders"></div>
  <button onclick="closeAll()">Close</button>
 </div>
</div>

<script>
let WID = localStorage.getItem("wid") || "W001";
widText.innerText = WID;

function openWid(){widModal.style.display="flex"}
function openProduct(){productModal.style.display="flex"}
function openOrders(){orderModal.style.display="flex";loadOrders()}
function openProfile(){
 profileModal.style.display="flex";
 let p = JSON.parse(localStorage.getItem("wholesalerProfile_"+WID) || "{}");
 shopName.value = p.shopName || "";
 shopMobile.value = p.mobile || "";
 shopAddress.value = p.address || "";
}
function closeAll(){
 document.querySelectorAll(".modal").forEach(m=>m.style.display="none")
}

/* ===== SET WID ===== */
function setWid(){
 let v=widInput.value.trim();
 if(!v) return alert("Enter ID");
 WID=v;
 localStorage.setItem("wid",WID);
 widText.innerText=WID;
 closeAll();
 loadProducts();
}

/* ===== SAVE SHOP PROFILE ===== */
function saveProfile(){
 let profile={
  wid:WID,
  shopName:shopName.value,
  mobile:shopMobile.value,
  address:shopAddress.value
 };
 localStorage.setItem("wholesalerProfile_"+WID, JSON.stringify(profile));
 alert("Shop profile saved ✅");
 closeAll();
}

/* ===== ADD PRODUCT ===== */
function addProduct(){
 let f=pimg.files[0];
 if(!f) return alert("Image required");
 let profile = JSON.parse(localStorage.getItem("wholesalerProfile_"+WID) || "{}");
 if(!profile.shopName){ alert("Set Shop Profile first"); return; }
 let r=new FileReader();
 r.onload=()=>{
  let p=JSON.parse(localStorage.getItem("products")||"[]");
  p.push({
   wid: WID,
   name: pname.value,
   price: pprice.value,
   detail: pdetail.value,
   img: r.result,
   shopName: profile.shopName,
   mobile: profile.mobile,
   address: profile.address
  });
  localStorage.setItem("products",JSON.stringify(p));
  closeAll(); loadProducts();
 };
 r.readAsDataURL(f);
}

/* ===== LOAD PRODUCTS ===== */
function loadProducts(){
 let list=JSON.parse(localStorage.getItem("products")||"[]")
  .filter(p=>p.wid===WID);
 products.innerHTML=list.map((p,i)=>`
  <div class="product-card" onclick="showDetail(${i})">
   <img src="${p.img}">
   <h4>${p.name}</h4>
   <div class="price">₹${p.price}</div>
  </div>`).join("") || "No products";
}

/* ===== LOAD ORDERS ===== */
function loadOrders(){
 autoCleanOrders(); // remove old delivered orders
 let all=JSON.parse(localStorage.getItem("orders")||"[]").filter(o=>o.wid===WID);
 all = all.map(o=>{
   if(!o.orderId) o.orderId=Date.now()+Math.floor(Math.random()*1000);
   return o;
 });
 orders.innerHTML = all.map(o=>{
   let steps=['pending','confirmed','pickup','delivered'];
   let statusLine=steps.map(s=>{
     let cls='';
     if(s===o.status) cls='active';
     if(s==='delivered' && o.status==='delivered') cls='delivered';
     return `<span class="${cls}">${s.toUpperCase()}</span>`;
   }).join(' → ');

   let confirmBtn = o.status==='pending'?`<button class="success" onclick="updateStatus(${o.orderId},'confirmed')">Confirm</button>`:'';

   return `<div class="card">
    <b>${o.product}</b> (₹${o.price})<br>
    <img src="${o.productImg}" class="small-img">
    <p>Retailer: ${o.retailerName}</p>
    <p>Mobile: ${o.retailerMobile}</p>
    <p>Txn ID: ${o.txnId}</p>
    <div class="status-line">${statusLine}</div>
    <div class="buttons">${confirmBtn}</div>
   </div>`;
 }).join('') || "No pending orders";
 localStorage.setItem("orders",JSON.stringify(all));
}

/* ===== UPDATE STATUS ===== */
function updateStatus(orderId,newStatus){
 let all=JSON.parse(localStorage.getItem("orders")||"[]");
 all=all.map(o=>{
   if(o.orderId==orderId){
     o.status=newStatus;
     o.statusTime=Date.now();
   }
   return o;
 });
 localStorage.setItem("orders",JSON.stringify(all));
 loadOrders();
}

/* ===== AUTO CLEAN DELIVERED ORDERS AFTER 10 MIN ===== */
function autoCleanOrders(){
 let all=JSON.parse(localStorage.getItem("orders")||"[]");
 let now=Date.now();
 all = all.filter(o=>{
   if(o.status==='delivered'){
     return now - o.statusTime < 600000; // 10 min
   }
   return true;
 });
 localStorage.setItem("orders",JSON.stringify(all));
}

loadProducts();
setInterval(autoCleanOrders,60000);
</script>
</body>
</html>